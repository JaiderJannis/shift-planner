<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Shift Planner â€” projecten & shifts</title>

  <!-- ðŸ”¹ Materialize CSS -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    rel="stylesheet"
  />

  <!-- ðŸ”¹ Favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.ico" />

  <!-- ðŸ”¹ Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <style>
    body {
      padding: 18px;
    }

    nav .brand-logo {
      margin-left: 16px;
    }

    table {
      font-size: 0.95rem;
    }

    th,
    td {
      text-align: center;
      vertical-align: middle;
    }

    .positive {
      color: green;
      font-weight: 700;
    }

    .negative {
      color: red;
      font-weight: 700;
    }

    label {
      font-size: 0.95rem !important;
      font-weight: 600;
    }

    input,
    select {
      font-size: 0.95rem !important;
      padding: 6px 8px;
    }

    .dur {
      font-size: 1.05rem;
      font-weight: 700;
    }

    .totals {
      margin-top: 10px;
      font-size: 1rem;
    }

    .small {
      font-size: 0.85rem;
    }

    /* Floating Action Button */
    .fixed-action-btn {
      z-index: 1000;
    }

    /* ðŸ”¹ Uitloggen FAB */
    .logout-zone {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 80px;
      height: 80px;
      z-index: 999;
    }

    .logout-hover {
      position: absolute;
      bottom: 24px;
      right: 24px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .logout-zone:hover .logout-hover {
      opacity: 1;
      pointer-events: auto;
    }

    /* ðŸ”¹ Admin FAB */
    .admin-zone {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 80px;
      height: 80px;
      z-index: 999;
    }

    .admin-hover {
      position: absolute;
      bottom: 24px;
      left: 24px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .admin-zone:hover .admin-hover {
      opacity: 1;
      pointer-events: auto;
    }

    #adminModal {
      max-width: 90% !important;
      width: 90% !important;
      height: 80% !important;
    }

    #adminModal .modal-content {
      overflow-y: auto;
      height: calc(100% - 64px);
    }

    /* ðŸ”¹ Quick input FAB */
    .quick-zone {
      position: fixed;
      bottom: 0;
      right: 80px;
      width: 80px;
      height: 80px;
      z-index: 999;
    }

    .quick-hover {
      position: absolute;
      bottom: 24px;
      right: 24px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .quick-zone:hover .quick-hover {
      opacity: 1;
      pointer-events: auto;
    }

    /* ðŸ”¹ Mobiele weergave */
    @media (max-width: 768px) {
      .quick-hover {
        opacity: 1 !important;
        pointer-events: auto !important;
      }
    }
  </style>
</head>
<body>

  <!-- ðŸ”¹ UITLOGGEN FAB -->
  <div class="logout-zone">
    <div class="fixed-action-btn logout-hover">
      <a id="logoutBtn" class="btn-floating btn-large red tooltipped" data-tooltip="Uitloggen">
        <i class="material-icons">logout</i>
      </a>
    </div>
  </div>

  <!-- ðŸ”¹ ADMIN FAB -->
  <div class="admin-zone">
    <div id="adminFab" class="fixed-action-btn admin-hover" style="display: none;">
      <a
        id="adminFabBtn"
        class="btn-floating btn-large orange tooltipped modal-trigger"
        data-tooltip="Admin beheer"
        href="#adminModal"
      >
        <i class="material-icons">admin_panel_settings</i>
      </a>
    </div>
  </div>

  <!-- ðŸ”¹ ADMIN MODAL -->
  <div id="adminModal" class="modal">
    <div class="modal-content">
      <h5>ðŸ”‘ Admin Beheer</h5>

      <p><strong>Ingelogd als:</strong> <span id="loggedInUserLabel">-</span></p>
      <p><strong>Actieve gebruiker:</strong> <span id="activeUserLabel">-</span></p>

      <!-- Gebruikersbeheer -->
      <h6>Gebruikersbeheer</h6>
      <div class="row">
        <div class="input-field col s6">
          <select id="adminUserSelect"></select>
          <label for="adminUserSelect">Gebruiker selecteren</label>
        </div>
        <div class="input-field col s6">
          <button id="addUserBtn" class="btn blue">Nieuwe gebruiker</button>
          <button id="removeUserBtn" class="btn red">Verwijder gebruiker</button>
        </div>
      </div>

      <div class="row">
        <div class="input-field col s6">
          <select id="roleSelect">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
          <label for="roleSelect">Rol wijzigen</label>
        </div>
        <div class="input-field col s6">
          <button id="updateRoleBtn" class="btn orange">Update rol</button>
        </div>
      </div>

      <!-- Projectbeheer -->
      <h6>Projectbeheer</h6>
      <div class="row">
        <div class="input-field col s4">
          <input id="newProjectName" type="text" />
          <label>Project naam</label>
        </div>
        <div class="input-field col s3">
          <input id="newProjectStart" type="date" />
          <label>Start datum</label>
        </div>
        <div class="input-field col s3">
          <input id="newProjectEnd" type="date" />
          <label>Eind datum</label>
        </div>
        <div class="input-field col s2">
          <button id="addProjectBtn" class="btn green">Toevoegen</button>
        </div>
      </div>

      <table class="striped">
        <thead>
          <tr>
            <th>Project</th>
            <th>Start</th>
            <th>Eind</th>
            <th>Acties</th>
          </tr>
        </thead>
        <tbody id="projectTableBody"></tbody>
      </table>

      <!-- Audit Log -->
      <h6>Audit Log</h6>
      <div class="row">
        <div class="input-field col s6">
          <select id="auditFilterSelect">
            <option value="all" selected>Alle gebruikers</option>
            <option value="active">Actieve gebruiker</option>
            <option value="self">Ingelogde gebruiker</option>
          </select>
          <label for="auditFilterSelect">Filter audit log</label>
        </div>
      </div>

      <ul id="auditLog" class="collection small"></ul>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close btn-flat">Sluiten</a>
    </div>
  </div>

  <!-- ðŸ”¹ NAVIGATIE -->
  <nav>
    <div class="nav-wrapper blue">
      <a href="#!" class="brand-logo">Shift Planner</a>
      <ul id="tabs-swipe" class="tabs tabs-fixed-width right">
        <li class="tab col s3"><a class="active" href="#tab-shifts">Shift aanmaken</a></li>
        <li class="tab col s3"><a href="#tab-invoer">Invoer</a></li>
        <li class="tab col s3"><a href="#tab-historiek">Historiek</a></li>
        <li class="tab col s3"><a href="#tab-converter">Tijd omrekenen</a></li>
      </ul>
    </div>
  </nav>

  <div class="row">
    <!-- ðŸ”¹ SNELLE INVOER FAB -->
    <div class="quick-zone">
      <div id="quickFab" class="fixed-action-btn quick-hover">
        <a
          id="quickFabBtn"
          class="btn-floating btn-large teal tooltipped modal-trigger"
          data-tooltip="Snelle invoer"
          href="#quickModal"
        >
          <i class="material-icons">event</i>
        </a>
      </div>
    </div>

    <!-- ðŸ”¹ SNELLE INVOER MODAL -->
    <div id="quickModal" class="modal">
      <div class="modal-content">
        <h5>ðŸ“… Snelle Invoer</h5>
        <p>Selecteer datum + shift om snel een dag in te plannen:</p>

        <div class="row">
          <div class="input-field col s6">
            <input type="date" id="quickDate" />
            <label for="quickDate">Datum</label>
          </div>
          <div class="input-field col s6">
            <select id="quickShift" class="browser-default"></select>
          </div>
        </div>

        <div class="row">
          <div class="input-field col s12">
            <input type="text" id="quickNote" />
            <label for="quickNote">Omschrijving (optioneel)</label>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <a href="#!" id="saveQuickBtn" class="btn green">Opslaan</a>
        <a href="#!" class="modal-close btn-flat">Sluiten</a>
      </div>
    </div>

    <!-- ðŸ”¹ TAB: SHIFTS -->
    <div id="tab-shifts" class="col s12">
      <h5>Shift aanmaken â€” Gebruiker: <span id="currentUserLabel">-</span></h5>

      <div class="row compact">
        <div class="input-field col s3">
          <input id="newShiftName" type="text" />
          <label for="newShiftName">Shift naam</label>
        </div>
        <div class="input-field col s2">
          <input id="newShiftStart" type="time" value="08:00" />
          <label for="newShiftStart">Start</label>
        </div>
        <div class="input-field col s2">
          <input id="newShiftEnd" type="time" value="16:00" />
          <label for="newShiftEnd">Einde</label>
        </div>
        <div class="input-field col s1">
          <input id="newShiftBreak" type="number" min="0" value="0" />
          <label for="newShiftBreak">Pauze</label>
        </div>
        <div class="input-field col s2">
          <select id="newShiftProjectSelect" class="browser-default">
            <option value="">Geen project</option>
          </select>
        </div>
        <div class="input-field col s2">
          <input id="newShiftStartDate" type="date" />
          <label for="newShiftStartDate">Vanaf (opt)</label>
        </div>
        <div class="input-field col s2">
          <input id="newShiftEndDate" type="date" />
          <label for="newShiftEndDate">Tot (opt)</label>
        </div>
        <div class="input-field col s1">
          <button id="addShiftBtn" class="btn green">Toevoegen</button>
        </div>
      </div>

      <div class="row">
        <div class="input-field col s2">
          <select id="filterShiftYear" class="browser-default"></select>
        </div>
      </div>

      <table class="striped">
        <thead>
          <tr>
            <th>Naam</th>
            <th>Start</th>
            <th>Einde</th>
            <th>Pauze</th>
            <th>Project</th>
            <th>Periode</th>
            <th>Acties</th>
          </tr>
        </thead>
        <tbody id="shiftTableBody"></tbody>
      </table>

      <p class="small">Je kan shifts herschikken via drag & drop (sleep de rijen).</p>
    </div>

    <!-- ðŸ”¹ TAB: INVOER -->
    <div id="tab-invoer" class="col s12">
      <h5>Invoer â€” Gebruiker: <span id="currentUserInvoer">-</span></h5>

      <div class="row compact">
        <div class="input-field col s1">
          <input id="monthTargetHours" type="number" min="0" value="0" />
          <label for="monthTargetHours">Doel uren</label>
        </div>
        <div class="input-field col s1">
          <input id="monthTargetMinutes" type="number" min="0" value="0" />
          <label for="monthTargetMinutes">Doel min</label>
        </div>
        <div class="input-field col s2">
          <select id="monthSelectMain" class="browser-default">
            <option value="0">Januari</option>
            <option value="1">Februari</option>
            <option value="2">Maart</option>
            <option value="3">April</option>
            <option value="4">Mei</option>
            <option value="5">Juni</option>
            <option value="6">Juli</option>
            <option value="7">Augustus</option>
            <option value="8">September</option>
            <option value="9">Oktober</option>
            <option value="10">November</option>
            <option value="11">December</option>
          </select>
        </div>
        <div class="input-field col s2">
          <select id="yearSelectMain" class="browser-default"></select>
        </div>
        <div class="input-field col s3">
          <select id="projectFilterSelect" class="browser-default">
            <option value="">Alle projecten</option>
          </select>
        </div>
      </div>

      <table class="striped">
        <thead>
          <tr>
            <th>Dag</th>
            <th>Datum</th>
            <th>Project</th>
            <th>Shift</th>
            <th>Start</th>
            <th>Einde</th>
            <th>Pauze (min)</th>
            <th>Omschrijving</th>
            <th>Duur</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="row totals">
        <div class="col s4">
          <strong>Doel totaal:</strong> <span id="inputTotDoel">0u 0min</span>
        </div>
        <div class="col s4">
          <strong>Totaal uren:</strong> <span id="inputTotGepland">0u 0min</span>
        </div>
        <div class="col s4">
          <strong>Verschil:</strong> <span id="inputTotVerschil">0u 0min</span>
        </div>
      </div>
    </div>

    <!-- ðŸ”¹ TAB: HISTORIEK -->
    <div id="tab-historiek" class="col s12">
      <h5>
        Historiek â€” Gebruiker: <span id="currentUserHistoriek">-</span> â€”
        Jaar: <span id="historiekJaar"></span>
      </h5>

      <table class="striped">
        <thead>
          <tr>
            <th>Maand</th>
            <th>Doel uren</th>
            <th>Gepland</th>
            <th>Verschil</th>
            <th>Verlof</th>
            <th>Ziekte</th>
            <th>Schoolverlof</th>
            <th>Feestdag</th>
            <th>Bench</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
        <tfoot>
          <tr>
            <th>Totaal</th>
            <th id="totDoel">0u 0min</th>
            <th id="totGepland">0u 0min</th>
            <th id="totVerschil">0u 0min</th>
            <th id="totVerlof">0u 0min</th>
            <th id="totZiekte">0u 0min</th>
            <th id="totSchool">0u 0min</th>
            <th id="totFeest">0u 0min</th>
            <th id="totBench">0u 0min</th>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- ðŸ”¹ TAB: CONVERTER -->
    <div id="tab-converter" class="col s12">
      <h5>ðŸ•’ â€” Uren/minuten â†” Decimale uren</h5>
      <div class="row compact">
        <div class="input-field col s2">
          <input id="convHours" type="number" min="0" value="0" />
          <label for="convHours">Uren</label>
        </div>
        <div class="input-field col s2">
          <input id="convMinutes" type="number" min="0" value="0" />
          <label for="convMinutes">Minuten</label>
        </div>
        <div class="input-field col s3">
          <input id="decimalInput" type="number" step="0.01" min="0" value="0" />
          <label for="decimalInput">Decimale uren</label>
        </div>
      </div>
    </div>
  </div>
  <!-- ================== SCRIPTS ================== -->
  <!-- ðŸ”¹ Materialize JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <!-- ðŸ”¹ Firebase SDK's -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
    // =========================================
    // ðŸ”¹ Firebase Configuratie
    // =========================================
    const firebaseConfig = {
      apiKey: "AIzaSyB8uHwRXCe1iV7z6T80YPxEbeB64qdMpNY",
      authDomain: "shift-planner-dc7ad.firebaseapp.com",
      projectId: "shift-planner-dc7ad",
      storageBucket: "shift-planner-dc7ad.firebasestorage.app",
      messagingSenderId: "719441527396",
      appId: "1:719441527396:web:de87d6f950fe23702a5571"
    };

    // ðŸ”¹ Firebase initialiseren
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // =========================================
    // ðŸ”¹ Admin logica (zonder audit / rol)
    // =========================================

    // Toon admin-FAB alleen voor admins
    auth.onAuthStateChanged(async (user) => {
      if (!user) return;

      document.getElementById("loggedInUserLabel").textContent = user.displayName || user.email;

      const snap = await db.collection("users").doc(user.uid).get();
      if (!snap.exists) return;

      const data = snap.data();
      if (data.role === "admin") {
        document.getElementById("adminFab").style.display = "block";
        await renderAdminUserSelect();
      }
    });

    // Gebruikerslijst vullen
    async function renderAdminUserSelect() {
      const sel = document.getElementById("adminUserSelect");
      sel.innerHTML = "";

      const snapshot = await db.collection("users").get();
      snapshot.forEach((doc) => {
        const data = doc.data();
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = data.name || data.email || doc.id;
        sel.appendChild(opt);
      });

      // Initialiseer Materialize select
      M.FormSelect.init(sel);
    }

    // Nieuwe gebruiker toevoegen
    document.getElementById("addUserBtn").addEventListener("click", async () => {
      const name = prompt("Nieuwe gebruikersnaam:");
      if (!name) return;

      try {
        const userRef = db.collection("users").doc();
        await userRef.set({
          name: name,
          role: "user",
          shifts: {},
          monthData: {},
          projects: []
        });

        alert("âœ… Gebruiker toegevoegd!");
        renderAdminUserSelect();
      } catch (err) {
        console.error("âŒ Fout bij gebruiker toevoegen:", err);
      }
    });

    // Gebruiker verwijderen
    document.getElementById("removeUserBtn").addEventListener("click", async () => {
      const sel = document.getElementById("adminUserSelect");
      const uid = sel.value;
      if (!uid) return alert("Selecteer eerst een gebruiker.");
      if (!confirm("Weet je zeker dat je deze gebruiker wilt verwijderen?")) return;

      try {
        await db.collection("users").doc(uid).delete();
        alert("âŒ Gebruiker verwijderd!");
        renderAdminUserSelect();
      } catch (err) {
        console.error("âŒ Fout bij gebruiker verwijderen:", err);
      }
    });

    // Project toevoegen
    document.getElementById("addProjectBtn").addEventListener("click", async () => {
      const name = document.getElementById("newProjectName").value.trim();
      const start = document.getElementById("newProjectStart").value;
      const end = document.getElementById("newProjectEnd").value;

      if (!name || !start || !end) return alert("Vul alle velden in.");

      try {
        const projectRef = db.collection("projects").doc();
        await projectRef.set({
          name: name,
          start: start,
          end: end,
          createdBy: auth.currentUser.uid
        });

        alert("âœ… Project toegevoegd!");
        document.getElementById("newProjectName").value = "";
        document.getElementById("newProjectStart").value = "";
        document.getElementById("newProjectEnd").value = "";
      } catch (err) {
        console.error("âŒ Fout bij project toevoegen:", err);
      }
    });

    // Admin-modal initialiseren
    document.addEventListener("DOMContentLoaded", () => {
      const adminModalEl = document.getElementById("adminModal");
      M.Modal.init(adminModalEl);
    });
  </script>
  <script>
    /* =========================================
       App state
    ============================================*/
    let dataStore = { users: {}, currentUser: null };
    let currentUser = null;

    /* =========================================
       Materialize: Tabs + Modals
    ============================================*/
    document.addEventListener("DOMContentLoaded", () => {
      const tabs = document.querySelectorAll(".tabs");
      M.Tabs.init(tabs, { swipeable: false });
      const instance = M.Tabs.getInstance(tabs[0]);
      instance.select("tab-shifts");

      const modals = document.querySelectorAll(".modal");
      M.Modal.init(modals);
    });

    /* =========================================
       Auth state + init
    ============================================*/
    document.addEventListener("DOMContentLoaded", () => {
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          if (!DEBUG) window.location.href = "index.html";
          return;
        }

        currentUser = user.uid;
        dataStore.currentUser = currentUser;

        // Zorg dat user-doc altijd minimale velden heeft
        const userRef = db.collection("users").doc(user.uid);
        const snap = await userRef.get();

        if (!snap.exists) {
          await userRef.set({
            email: user.email,
            name: user.displayName || user.email.split("@")[0],
            role: "user",
            shifts: {},
            monthData: {},
            projects: []
          });
        } else {
          const data = snap.data();
          const updates = {};
          if (!("email" in data)) updates.email = user.email;
          if (!("name" in data)) updates.name = user.displayName || user.email.split("@")[0];
          if (!("role" in data)) updates.role = "user";
          if (!("shifts" in data)) updates.shifts = {};
          if (!("monthData" in data)) updates.monthData = {};
          if (!("projects" in data)) updates.projects = [];
          if (Object.keys(updates).length) await userRef.update(updates);
        }

        await initApp();

        // Admin FAB tonen indien admin
        const roleData = (await userRef.get()).data();
        if (roleData.role === "admin") {
          document.getElementById("adminFab").style.display = "block";
          await renderAdminUserSelect();
          document.getElementById("adminUserSelect").value = currentUser;
        } else if (DEBUG) {
          document.getElementById("adminFab").style.display = "block";
        }

        updateCurrentUserLabels();
      });
    });

    /* =========================================
       Firestore helpers
    ============================================*/
    async function saveAll() {
      if (!currentUser) return;
      await db.collection("users").doc(currentUser).set(dataStore.users[currentUser]);
    }

    async function loadUser(uid) {
      const doc = await db.collection("users").doc(uid).get();
      if (doc.exists) {
        dataStore.users[uid] = doc.data();
      } else {
        dataStore.users[uid] = { shifts: {}, monthData: {}, projects: [] };
        await saveAll();
      }
    }

    async function loadAllUsers() {
      if (!auth.currentUser) return;
      const meRef = db.collection("users").doc(auth.currentUser.uid);
      const meSnap = await meRef.get();
      const role = meSnap.data().role;

      dataStore.users = {};
      if (role === "admin") {
        const snapshot = await db.collection("users").get();
        snapshot.forEach((d) => (dataStore.users[d.id] = d.data()));
      } else {
        dataStore.users[auth.currentUser.uid] = meSnap.data();
      }
    }

    /* =========================================
       Init App
    ============================================*/
    async function initApp() {
      await loadAllUsers();

      if (!currentUser) {
        const ids = Object.keys(dataStore.users);
        currentUser = ids.length ? ids[0] : null;
        dataStore.currentUser = currentUser;
      }
      if (currentUser) await loadUser(currentUser);

      populateYearSelect();
      renderProjects();
      renderShifts();
      updateCurrentUserLabels();
      renderHistory();
      renderProjectFilterForMonth();
      populateFilterShiftYears();
      generateMonth();

      initQuickInputModal();
      initConverter();
      initLogout();
    }

    /* =========================================
       Elements
    ============================================*/
    const currentUserLabel = document.getElementById("currentUserLabel");
    const currentUserInvoer = document.getElementById("currentUserInvoer");
    const currentUserHistoriek = document.getElementById("currentUserHistoriek");

    const projectTableBody = document.getElementById("projectTableBody");
    const newProjectName = document.getElementById("newProjectName");
    const newProjectStart = document.getElementById("newProjectStart");
    const newProjectEnd = document.getElementById("newProjectEnd");
    const addProjectBtn = document.getElementById("addProjectBtn");

    const newShiftName = document.getElementById("newShiftName");
    const newShiftStart = document.getElementById("newShiftStart");
    const newShiftEnd = document.getElementById("newShiftEnd");
    const newShiftBreak = document.getElementById("newShiftBreak");
    const newShiftProjectSelect = document.getElementById("newShiftProjectSelect");
    const newShiftStartDate = document.getElementById("newShiftStartDate");
    const newShiftEndDate = document.getElementById("newShiftEndDate");
    const addShiftBtn = document.getElementById("addShiftBtn");
    const shiftTableBody = document.getElementById("shiftTableBody");
    const filterShiftYear = document.getElementById("filterShiftYear");

    const monthSelectMain = document.getElementById("monthSelectMain");
    const yearSelectMain = document.getElementById("yearSelectMain");
    const projectFilterSelect = document.getElementById("projectFilterSelect");
    const monthTargetHours = document.getElementById("monthTargetHours");
    const monthTargetMinutes = document.getElementById("monthTargetMinutes");
    const tbody = document.getElementById("tbody");

    const inputTotDoel = document.getElementById("inputTotDoel");
    const inputTotGepland = document.getElementById("inputTotGepland");
    const inputTotVerschil = document.getElementById("inputTotVerschil");

    const historyBody = document.getElementById("historyBody");
    const historiekJaar = document.getElementById("historiekJaar");
    const projectFilterSelect_el = projectFilterSelect;

    /* =========================================
       Utils
    ============================================*/
    const daysFull = ["Zondag", "Maandag", "Dinsdag", "Woensdag", "Donderdag", "Vrijdag", "Zaterdag"];
    const monthsFull = ["Januari", "Februari", "Maart", "April", "Mei", "Juni", "Juli", "Augustus", "September", "Oktober", "November", "December"];

    function getCurrentUserData() {
      if (!currentUser) return { shifts: {}, monthData: {}, projects: [] };
      if (!dataStore.users[currentUser]) dataStore.users[currentUser] = { shifts: {}, monthData: {}, projects: [] };
      return dataStore.users[currentUser];
    }

    function dateKey(y, m, d) {
      return `${y}-${String(m + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
    }

    function minutesBetween(startStr, endStr, breakMin) {
      if (!startStr || !endStr) return 0;
      const [sh, sm] = startStr.split(":").map(Number);
      const [eh, em] = endStr.split(":").map(Number);
      let mins = (eh * 60 + em) - (sh * 60 + sm) - (Number(breakMin) || 0);
      if (mins < 0) mins += 24 * 60; // over-midnight
      return mins;
    }

    function toDisplayDate(iso) {
      if (!iso) return "-";
      const parts = iso.split("-");
      if (parts.length !== 3) return iso;
      const [y, m, d] = parts;
      return `${d.padStart(2, "0")}-${m.padStart(2, "0")}-${y}`;
    }

    function fromDisplayDate(display) {
      if (!display) return null;
      const parts = display.split("-");
      if (parts.length !== 3) return null;
      const [day, month, year] = parts;
      return `${year}-${month}-${day}`;
    }

    function isDateWithin(isoDate, startIso, endIso) {
      const d = isoDate ? isoDate.replaceAll("-", "") : null;
      const s = startIso ? startIso.replaceAll("-", "") : null;
      const e = endIso ? endIso.replaceAll("-", "") : null;
      if (!d) return false;
      if (s && d < s) return false;
      if (e && d > e) return false;
      return true;
    }

    function projectByName(name) {
      return (getCurrentUserData().projects || []).find((p) => p.name === name) || null;
    }

    function projectIsValidForDate(p, isoDate) {
      if (!p) return false;
      if (!(p.start || p.end)) return false;
      return isDateWithin(isoDate, p.start || null, p.end || null);
    }

    function ensureOptionInSelect(selectEl, value, label) {
      const exists = Array.from(selectEl.options).some((o) => o.value === value);
      if (!exists) {
        const opt = document.createElement("option");
        opt.value = value;
        opt.textContent = label || value;
        selectEl.appendChild(opt);
      }
    }

    function ensurePXLProjectExists() {
      const ud = getCurrentUserData();
      ud.projects = ud.projects || [];
      let p = ud.projects.find((p) => p.name === "PXL Verpleegkunde Hasselt");
      if (!p) {
        p = { name: "PXL Verpleegkunde Hasselt", start: null, end: null };
        ud.projects.push(p);
        saveAll();
        renderProjects();
      }
      return p;
    }

    function ensureEghtCareProjectExists() {
      const ud = getCurrentUserData();
      ud.projects = ud.projects || [];
      let p = ud.projects.find((p) => p.name === "Eght Care");
      if (!p) {
        p = { name: "Eght Care", start: null, end: null };
        ud.projects.push(p);
        saveAll();
        renderProjects();
      }
      return p;
    }

    /* =========================================
       Projects
    ============================================*/
    function renderProjects() {
      projectTableBody.innerHTML = "";
      newShiftProjectSelect.innerHTML = '<option value="">Geen project</option>';
      projectFilterSelect_el.innerHTML = '<option value="">Alle projecten</option>';

      const userData = getCurrentUserData();
      let projects = userData.projects || [];

      projects = projects
        .slice()
        .sort((a, b) => {
          const aStart = a.start ? new Date(a.start) : new Date("1900-01-01");
          const bStart = b.start ? new Date(b.start) : new Date("1900-01-01");
          if (aStart.getTime() !== bStart.getTime()) return aStart - bStart;
          const aEnd = a.end ? new Date(a.end) : new Date("9999-12-31");
          const bEnd = b.end ? new Date(b.end) : new Date("9999-12-31");
          return aEnd - bEnd;
        });

      projects.forEach((p, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${toDisplayDate(p.start)}</td>
          <td>${toDisplayDate(p.end)}</td>
          <td>
            <button class="btn orange btn-small" onclick="extendProject(${idx})">Verleng</button>
            <button class="btn red btn-small" onclick="deleteProject(${idx})">Verwijder</button>
          </td>`;
        projectTableBody.appendChild(tr);

        const opt1 = document.createElement("option");
        opt1.value = p.name;
        opt1.textContent = p.name;
        newShiftProjectSelect.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = p.name;
        opt2.textContent = p.name;
        projectFilterSelect_el.appendChild(opt2);
      });

      userData.projects = projects;
      saveAll();
    }

    addProjectBtn?.addEventListener("click", () => {
      if (!currentUser) return alert("Kies eerst een gebruiker");
      const name = newProjectName.value.trim();
      if (!name) return alert("Vul projectnaam in");
      const start = newProjectStart.value || null;
      const end = newProjectEnd.value || null;
      const ud = getCurrentUserData();
      ud.projects = ud.projects || [];
      ud.projects.push({ name, start, end });
      saveAll();
      newProjectName.value = "";
      newProjectStart.value = "";
      newProjectEnd.value = "";
      renderProjects();
    });

    window.extendProject = function (index) {
      const ud = getCurrentUserData();
      const p = ud.projects[index];
      if (!p) return;
      const newEnd = prompt("Nieuwe einddatum (DD-MM-YYYY):", toDisplayDate(p.end) || "");
      if (!newEnd) return;
      p.end = fromDisplayDate(newEnd);
      saveAll();
      renderProjects();
    };

    window.deleteProject = function (index) {
      if (!confirm("Project verwijderen?")) return;
      const ud = getCurrentUserData();
      ud.projects.splice(index, 1);
      saveAll();
      renderProjects();
    };

    function renderProjectFilterForMonth() {
      projectFilterSelect_el.innerHTML = '<option value="">Alle projecten</option>';

      const y = Number(yearSelectMain.value);
      const m = Number(monthSelectMain.value);
      const daysInMonth = new Date(y, m + 1, 0).getDate();
      const monthStart = `${y}-${String(m + 1).padStart(2, "0")}-01`.replaceAll("-", "");
      const monthEnd = `${y}-${String(m + 1).padStart(2, "0")}-${String(daysInMonth).padStart(2, "0")}`.replaceAll("-", "");

      (getCurrentUserData().projects || []).forEach((p) => {
        if (p.start || p.end) {
          const projStart = (p.start || "0000-01-01").replaceAll("-", "");
          const projEnd = (p.end || "9999-12-31").replaceAll("-", "");
          if (projStart <= monthEnd && projEnd >= monthStart) {
            const opt = document.createElement("option");
            opt.value = p.name;
            opt.textContent = p.name;
            projectFilterSelect_el.appendChild(opt);
          }
        } else {
          const opt = document.createElement("option");
          opt.value = p.name;
          opt.textContent = p.name;
          projectFilterSelect_el.appendChild(opt);
        }
      });
    }

    /* =========================================
       Shifts
    ============================================*/
    function renderShifts() {
      shiftTableBody.innerHTML = "";
      const ud = getCurrentUserData();
      const shifts = ud.shifts || {};
      const order = ud.shiftOrder || Object.keys(shifts);
      const selectedYear = filterShiftYear.value;

      order.forEach((sName) => {
        const sh = shifts[sName];
        if (!sh) return;

        if (selectedYear && sh.startDate) {
          const year = new Date(sh.startDate).getFullYear().toString();
          if (year !== selectedYear) return;
        } else if (selectedYear && !sh.startDate) {
          return;
        }

        const tr = document.createElement("tr");
        tr.setAttribute("draggable", "true");
        tr.dataset.shiftName = sName;
        tr.innerHTML = `
          <td class="nowrap">${sName}</td>
          <td>${sh.start || ""}</td>
          <td>${sh.end || ""}</td>
          <td>${sh.break || 0}</td>
          <td>${sh.project || ""}</td>
          <td>${toDisplayDate(sh.startDate)} â†’ ${toDisplayDate(sh.endDate)}</td>
          <td>
            <button class="btn orange btn-small" onclick="editShift('${sName}')">Bewerk</button>
            <button class="btn red btn-small" onclick="deleteShift('${sName}')">Verwijder</button>
          </td>`;
        shiftTableBody.appendChild(tr);
      });

      enableDragAndDropOnShifts();
    }

    addShiftBtn?.addEventListener("click", () => {
      if (!currentUser) return alert("Kies eerst een gebruiker");
      const name = newShiftName.value.trim();
      if (!name) return alert("Vul shift naam in");

      const ud = getCurrentUserData();
      ud.shifts = ud.shifts || {};
      ud.shifts[name] = {
        start: newShiftStart.value || "00:00",
        end: newShiftEnd.value || "00:00",
        break: Number(newShiftBreak.value) || 0,
        project: newShiftProjectSelect.value || null,
        startDate: newShiftStartDate.value || null,
        endDate: newShiftEndDate.value || null
      };

      if (!ud.shiftOrder) ud.shiftOrder = [];
      if (!ud.shiftOrder.includes(name)) ud.shiftOrder.push(name);

      saveAll();
      newShiftName.value = "";
      newShiftBreak.value = 0;
      newShiftStartDate.value = "";
      newShiftEndDate.value = "";
      renderShifts();
    });

    window.deleteShift = function (s) {
      if (!confirm(`Shift ${s} verwijderen?`)) return;
      const ud = getCurrentUserData();
      delete ud.shifts[s];
      saveAll();
      renderShifts();
    };

    window.editShift = function (name) {
      const ud = getCurrentUserData();
      const sh = ud.shifts[name];
      if (!sh) return;

      newShiftName.value = name;
      newShiftStart.value = sh.start;
      newShiftEnd.value = sh.end;
      newShiftBreak.value = sh.break;
      newShiftProjectSelect.value = sh.project || "";
      newShiftStartDate.value = sh.startDate || "";
      newShiftEndDate.value = sh.endDate || "";

      delete ud.shifts[name];
      saveAll();
      renderShifts();
    };

    function enableDragAndDropOnShifts() {
      const rows = shiftTableBody.querySelectorAll("tr");
      let dragSrc = null;
      rows.forEach((r) => {
        r.addEventListener("dragstart", (e) => {
          dragSrc = r;
          e.dataTransfer.effectAllowed = "move";
        });
        r.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });
        r.addEventListener("drop", (e) => {
          e.preventDefault();
          if (dragSrc && dragSrc !== r) {
            shiftTableBody.insertBefore(dragSrc, r.nextSibling);
            saveShiftOrder();
          }
        });
      });
    }

    function saveShiftOrder() {
      if (!currentUser) return;
      const ud = getCurrentUserData();
      ud.shiftOrder = Array.from(shiftTableBody.querySelectorAll("tr")).map((tr) => tr.dataset.shiftName);
      saveAll();
    }

    filterShiftYear.addEventListener("change", renderShifts);

    /* =========================================
       Year/Month selects
    ============================================*/
    function populateYearSelect() {
      const now = new Date();
      const yNow = now.getFullYear();
      yearSelectMain.innerHTML = "";
      for (let y = yNow - 2; y <= yNow + 3; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (y === yNow) opt.selected = true;
        yearSelectMain.appendChild(opt);
      }
    }

    function populateFilterShiftYears() {
      const ud = getCurrentUserData();
      const years = new Set();
      Object.values(ud.shifts || {}).forEach((sh) => {
        if (sh.startDate) years.add(new Date(sh.startDate).getFullYear());
      });
      filterShiftYear.innerHTML = '<option value="">Alle jaren</option>';
      [...years].sort().forEach((y) => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        filterShiftYear.appendChild(opt);
      });
    }

    /* =========================================
       Invoer â€” maand genereren & renderen
    ============================================*/
    function generateMonth() {
      if (!currentUser) return alert("Kies eerst een gebruiker");
      const year = Number(yearSelectMain.value);
      const month = Number(monthSelectMain.value);

      const ud = getCurrentUserData();
      ud.monthData = ud.monthData || {};
      ud.monthData[year] = ud.monthData[year] || {};
      if (!ud.monthData[year][month]) {
        ud.monthData[year][month] = { targetHours: 0, targetMinutes: 0, rows: {} };
      }

      saveAll();
      renderMonth(year, month);
      updateInputTotals();
      renderHistory();
    }

    function renderMonth(year, month) {
      tbody.innerHTML = "";
      const ud = getCurrentUserData();
      ud.monthData = ud.monthData || {};
      ud.monthData[year] = ud.monthData[year] || {};
      ud.monthData[year][month] = ud.monthData[year][month] || { targetHours: 0, targetMinutes: 0, rows: {} };
      const md = ud.monthData[year][month];

      monthTargetHours.value = md.targetHours || 0;
      monthTargetMinutes.value = md.targetMinutes || 0;

      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let d = 1; d <= daysInMonth; d++) {
        const key = dateKey(year, month, d);
        if (!md.rows[key]) {
          md.rows[key] = { project: "", shift: "", start: "00:00", end: "00:00", break: 0, omschrijving: "", minutes: 0 };
        }
        const rowData = md.rows[key];
        const dayName = daysFull[new Date(year, month, d).getDay()];

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${dayName}</td>
          <td>${String(d).padStart(2, "0")}-${String(month + 1).padStart(2, "0")}-${year}</td>
          <td><select class="browser-default projectSelect"></select></td>
          <td><select class="browser-default shiftSelect"></select></td>
          <td><input class="startInput" type="time" value="${rowData.start}"></td>
          <td><input class="endInput" type="time" value="${rowData.end}"></td>
          <td><input class="breakInput" type="number" min="0" value="${rowData.break}"></td>
          <td><input class="omschrijvingInput" type="text" value="${rowData.omschrijving}"></td>
          <td class="dur">${Math.floor(rowData.minutes / 60)}u ${rowData.minutes % 60}min</td>`;
        tbody.appendChild(tr);

        if (projectFilterSelect_el.value && rowData.project !== projectFilterSelect_el.value) {
          tr.style.display = "none";
        }

        // Project dropdown
        const projSel = tr.querySelector(".projectSelect");
        projSel.innerHTML = '<option value="">--</option>';

        const eligible = [];
        (ud.projects || []).forEach((p) => {
          if ((p.start || p.end) && isDateWithin(key, p.start || null, p.end || null)) {
            eligible.push(p.name);
            const opt = document.createElement("option");
            opt.value = p.name;
            opt.textContent = p.name;
            projSel.appendChild(opt);
          }
        });

        // Forceer specifieke projecten per speciale shift
        if (rowData.shift === "Schoolverlof" || rowData.shift === "School") {
          ensurePXLProjectExists();
          ensureOptionInSelect(projSel, "PXL Verpleegkunde Hasselt", "PXL Verpleegkunde Hasselt");
          rowData.project = "PXL Verpleegkunde Hasselt";
          projSel.value = "PXL Verpleegkunde Hasselt";
          saveCell(year, month, key, rowData, tr);
          saveAll();
        }
        if (rowData.shift === "Verlof" || rowData.shift === "Teammeeting") {
          ensureEghtCareProjectExists();
          ensureOptionInSelect(projSel, "Eght Care", "Eght Care");
          rowData.project = "Eght Care";
          projSel.value = "Eght Care";
          saveCell(year, month, key, rowData, tr);
          saveAll();
        }

        // Automatisch geldig project kiezen (indien nodig)
        if (
          (!rowData.shift || (eligible.length > 0 && !eligible.includes(rowData.project))) &&
          !["Bench", "School", "Schoolverlof", "Verlof", "Teammeeting"].includes(rowData.shift)
        ) {
          rowData.project = eligible.length > 0 ? eligible[0] : "";
          saveCell(year, month, key, rowData, tr);
        }

        if (rowData.project) projSel.value = rowData.project;

        projSel.addEventListener("change", () => {
          rowData.project = projSel.value || "";
          saveCell(year, month, key, rowData, tr);
          populateShiftSelectForRow(tr, d, month, year);
          updateInputTotals();
          saveAll();
        });

        populateShiftSelectForRow(tr, d, month, year);

        tr.querySelector(".startInput").addEventListener("change", (e) => {
          rowData.start = e.target.value;
          recalcRowMinutes(rowData);
          saveCell(year, month, key, rowData, tr);
          tr.querySelector(".dur").textContent = `${Math.floor(rowData.minutes / 60)}u ${rowData.minutes % 60}min`;
          updateInputTotals();
          saveAll();
          renderHistory();
        });

        tr.querySelector(".endInput").addEventListener("change", (e) => {
          rowData.end = e.target.value;
          recalcRowMinutes(rowData);
          saveCell(year, month, key, rowData, tr);
          tr.querySelector(".dur").textContent = `${Math.floor(rowData.minutes / 60)}u ${rowData.minutes % 60}min`;
          updateInputTotals();
          saveAll();
          renderHistory();
        });

        tr.querySelector(".breakInput").addEventListener("input", (e) => {
          rowData.break = Number(e.target.value) || 0;
          recalcRowMinutes(rowData);
          saveCell(year, month, key, rowData, tr);
          tr.querySelector(".dur").textContent = `${Math.floor(rowData.minutes / 60)}u ${rowData.minutes % 60}min`;
          updateInputTotals();
          saveAll();
          renderHistory();
        });

        tr.querySelector(".omschrijvingInput").addEventListener("change", (e) => {
          rowData.omschrijving = e.target.value;
          saveCell(year, month, key, rowData, tr);
          saveAll();
          renderHistory();
        });
      }

      saveAll();
    }

    function populateShiftSelectForRow(tr, day, month, year) {
      const key = dateKey(year, month, day);
      const ud = getCurrentUserData();
      const md = ud.monthData[year][month];
      const rowData = md.rows[key];
      const projSel = tr.querySelector(".projectSelect");
      const shiftSel = tr.querySelector(".shiftSelect");
      shiftSel.innerHTML = '<option value=""></option>';

      const isoDate = key;
      const projectFilterVal = projectFilterSelect_el.value;
      const selectedRowProject = projSel.value || "";
      const allShifts = ud.shifts || {};
      const shiftOrder = ud.shiftOrder || Object.keys(allShifts);

      const withPeriod = [];
      const withoutPeriod = [];

      shiftOrder.forEach((sName) => {
        const sh = allShifts[sName];
        if (!sh) return;
        if (sh.startDate || sh.endDate) withPeriod.push([sName, sh]);
        else withoutPeriod.push([sName, sh]);
      });

      const shiftEntries = [...withPeriod, ...withoutPeriod];

      for (const [sName, sh] of shiftEntries) {
        // Project filter
        let projectAllowed = false;
        if (sh.project) {
          if (selectedRowProject && sh.project === selectedRowProject) projectAllowed = true;
          else if (!selectedRowProject && projectFilterVal && sh.project === projectFilterVal) projectAllowed = true;
          else if (!selectedRowProject && !projectFilterVal) projectAllowed = true;
        } else {
          projectAllowed = true;
        }
        if (!projectAllowed) continue;

        // Datum filter
        if (!isDateWithin(isoDate, sh.startDate || null, sh.endDate || null)) continue;

        const opt = document.createElement("option");
        opt.value = sName;
        opt.textContent = sName;
        if (rowData.shift === sName) opt.selected = true;
        shiftSel.appendChild(opt);
      }

      shiftSel.addEventListener("change", () => {
        const chosen = shiftSel.value;
        const allShifts2 = getCurrentUserData().shifts || {};
        const projSel = tr.querySelector(".projectSelect");

        if (!chosen) {
          rowData.shift = "";
          const valid = (getCurrentUserData().projects || []).find((p) => (p.start || p.end) && isDateWithin(key, p.start || null, p.end || null));
          rowData.project = valid ? valid.name : "";
          projSel.value = rowData.project;
          saveCell(year, month, key, rowData, tr);
          saveAll();
          renderHistory();
          updateInputTotals();
          return;
        }

        rowData.shift = chosen;

        if (chosen === "Bench") {
          rowData.project = "";
          projSel.value = "";
        } else if (chosen === "Schoolverlof" || chosen === "School") {
          ensurePXLProjectExists();
          ensureOptionInSelect(projSel, "PXL Verpleegkunde Hasselt", "PXL Verpleegkunde Hasselt");
          rowData.project = "PXL Verpleegkunde Hasselt";
          projSel.value = "PXL Verpleegkunde Hasselt";
        } else if (chosen === "Verlof" || chosen === "Teammeeting") {
          ensureEghtCareProjectExists();
          ensureOptionInSelect(projSel, "Eght Care", "Eght Care");
          rowData.project = "Eght Care";
          projSel.value = "Eght Care";
        } else {
          const sh = allShifts2[chosen];
          if (sh && sh.project) {
            const p = projectByName(sh.project);
            if (projectIsValidForDate(p, key)) {
              rowData.project = p.name;
              projSel.value = p.name;
            } else {
              const valid = (getCurrentUserData().projects || []).find((p) => (p.start || p.end) && isDateWithin(key, p.start || null, p.end || null));
              rowData.project = valid ? valid.name : "";
              projSel.value = rowData.project;
            }
          } else {
            const valid = (getCurrentUserData().projects || []).find((p) => (p.start || p.end) && isDateWithin(key, p.start || null, p.end || null));
            rowData.project = valid ? valid.name : "";
            projSel.value = rowData.project;
          }
        }

        if (allShifts2[chosen]) {
          const sh = allShifts2[chosen];
          if (!rowData.start || rowData.start === "00:00") rowData.start = sh.start || "00:00";
          if (!rowData.end || rowData.end === "00:00") rowData.end = sh.end || "00:00";
          if (!rowData.break || rowData.break === 0) rowData.break = Number(sh.break) || 0;
        }

        recalcRowMinutes(rowData);
        tr.querySelector(".startInput").value = rowData.start;
        tr.querySelector(".endInput").value = rowData.end;
        tr.querySelector(".breakInput").value = rowData.break;
        tr.querySelector(".dur").textContent = `${Math.floor(rowData.minutes / 60)}u ${rowData.minutes % 60}min`;

        saveCell(year, month, key, rowData, tr);
        saveAll();
        updateInputTotals();
      });
    }

    function recalcRowMinutes(rowData) {
      rowData.minutes = minutesBetween(rowData.start, rowData.end, rowData.break);
    }

    function saveCell(year, month, key, rowData, tr) {
      const ud = getCurrentUserData();
      ud.monthData = ud.monthData || {};
      ud.monthData[year] = ud.monthData[year] || {};
      ud.monthData[year][month] = ud.monthData[year][month] || { targetHours: 0, targetMinutes: 0, rows: {} };

      ud.monthData[year][month].rows[key] = { ...rowData };
      ud.monthData[year][month].rows[key].minutes = rowData.minutes || minutesBetween(rowData.start, rowData.end, rowData.break);

      saveAll();
      renderHistory();
    }

    function updateInputTotals() {
      const year = Number(yearSelectMain.value);
      const month = Number(monthSelectMain.value);
      const ud = getCurrentUserData();
      const md = ud.monthData && ud.monthData[year] && ud.monthData[year][month] ? ud.monthData[year][month] : null;
      const totalMin = md ? Object.values(md.rows).reduce((s, r) => s + (r.minutes || 0), 0) : 0;
      const targetMin = md ? ((md.targetHours || 0) * 60 + (md.targetMinutes || 0)) : 0;
      const diff = totalMin - targetMin;

      inputTotDoel.textContent = `${Math.floor(targetMin / 60)}u ${targetMin % 60}min`;
      inputTotGepland.textContent = `${Math.floor(totalMin / 60)}u ${totalMin % 60}min`;
      inputTotVerschil.textContent = `${diff >= 0 ? "+" : "-"}${Math.floor(Math.abs(diff) / 60)}u ${Math.abs(diff) % 60}min`;
      inputTotVerschil.className = diff >= 0 ? "positive" : "negative";
    }

    /* =========================================
       Historiek
    ============================================*/
    function renderHistory() {
      historyBody.innerHTML = "";
      if (!currentUser) return;
      const ud = getCurrentUserData();
      const year = Number(yearSelectMain.value) || new Date().getFullYear();
      historiekJaar.textContent = year;

      let totDoel = 0, totGepland = 0, totVerschil = 0, totVerlof = 0, totZiekte = 0, totSchool = 0, totFeest = 0, totBench = 0;

      for (let m = 0; m < 12; m++) {
        const md = ud.monthData && ud.monthData[year] && ud.monthData[year][m] ? ud.monthData[year][m] : { targetHours: 0, targetMinutes: 0, rows: {} };
        const targetMin = (md.targetHours || 0) * 60 + (md.targetMinutes || 0);
        const rows = md.rows || {};
        const maandGepland = Object.values(rows).reduce((s, r) => s + (r.minutes || 0), 0);

        let v = 0, z = 0, sf = 0, f = 0, b = 0;
        Object.values(rows).forEach((r) => {
          if (!r.shift) return;
          if (r.shift === "Verlof") v += r.minutes || 0;
          if (r.shift === "Ziekte") z += r.minutes || 0;
          if (r.shift === "Schoolverlof") sf += r.minutes || 0;
          if (r.shift === "Feestdag") f += r.minutes || 0;
          if (r.shift === "Bench") b += r.minutes || 0;
        });

        const diff = maandGepland - targetMin;

        totDoel += targetMin;
        totGepland += maandGepland;
        totVerschil += diff;
        totVerlof += v;
        totZiekte += z;
        totSchool += sf;
        totFeest += f;
        totBench += b;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${monthsFull[m]}</td>
          <td>${Math.floor(targetMin / 60)}u ${targetMin % 60}min</td>
          <td>${Math.floor(maandGepland / 60)}u ${maandGepland % 60}min</td>
          <td class="${diff >= 0 ? "positive" : "negative"}">${diff >= 0 ? "+" : ""}${Math.floor(Math.abs(diff) / 60)}u ${Math.abs(diff) % 60}min</td>
          <td>${Math.floor(v / 60)}u ${v % 60}min</td>
          <td>${Math.floor(z / 60)}u ${z % 60}min</td>
          <td>${Math.floor(sf / 60)}u ${sf % 60}min</td>
          <td>${Math.floor(f / 60)}u ${f % 60}min</td>
          <td>${Math.floor(b / 60)}u ${b % 60}min</td>`;
        historyBody.appendChild(tr);
      }

      document.getElementById("totDoel").textContent = `${Math.floor(totDoel / 60)}u ${totDoel % 60}min`;
      document.getElementById("totGepland").textContent = `${Math.floor(totGepland / 60)}u ${totGepland % 60}min`;
      document.getElementById("totVerschil").textContent = `${totVerschil >= 0 ? "+" : ""}${Math.floor(Math.abs(totVerschil) / 60)}u ${Math.abs(totVerschil) % 60}min`;
      document.getElementById("totVerschil").className = totVerschil >= 0 ? "positive" : "negative";
      document.getElementById("totVerlof").textContent = `${Math.floor(totVerlof / 60)}u ${totVerlof % 60}min`;
      document.getElementById("totZiekte").textContent = `${Math.floor(totZiekte / 60)}u ${totZiekte % 60}min`;
      document.getElementById("totSchool").textContent = `${Math.floor(totSchool / 60)}u ${totSchool % 60}min`;
      document.getElementById("totFeest").textContent = `${Math.floor(totFeest / 60)}u ${totFeest % 60}min`;
      document.getElementById("totBench").textContent = `${Math.floor(totBench / 60)}u ${totBench % 60}min`;
    }

    /* =========================================
       Targets live opslaan
    ============================================*/
    monthTargetHours.addEventListener("input", () => {
      const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
      const ud = getCurrentUserData();
      ud.monthData = ud.monthData || {};
      ud.monthData[y] = ud.monthData[y] || {};
      ud.monthData[y][m] = ud.monthData[y][m] || { targetHours: 0, targetMinutes: 0, rows: {} };
      ud.monthData[y][m].targetHours = Number(monthTargetHours.value) || 0;
      saveAll();
      updateInputTotals();
      renderHistory();
    });

    monthTargetMinutes.addEventListener("input", () => {
      const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
      const ud = getCurrentUserData();
      ud.monthData = ud.monthData || {};
      ud.monthData[y] = ud.monthData[y] || {};
      ud.monthData[y][m] = ud.monthData[y][m] || { targetHours: 0, targetMinutes: 0, rows: {} };
      ud.monthData[y][m].targetMinutes = Number(monthTargetMinutes.value) || 0;
      saveAll();
      updateInputTotals();
      renderHistory();
    });

    projectFilterSelect_el.addEventListener("change", () => {
      const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
      const ud = getCurrentUserData();
      if (ud.monthData && ud.monthData[y] && ud.monthData[y][m]) {
        renderMonth(y, m);
        updateInputTotals();
      }
    });

    yearSelectMain.addEventListener("change", () => {
      renderProjectFilterForMonth();
      generateMonth();
    });

    monthSelectMain.addEventListener("change", () => {
      renderProjectFilterForMonth();
      generateMonth();
    });

    /* =========================================
       Quick Input Modal
    ============================================*/
    function initQuickInputModal() {
      const quickModal = document.getElementById("quickModal");
      M.Modal.init(quickModal);

      function populateQuickShifts() {
        const ud = getCurrentUserData();
        const quickShiftSel = document.getElementById("quickShift");
        quickShiftSel.innerHTML = '<option value="">-- Kies shift --</option>';

        const allShifts = ud.shifts || {};
        const order = ud.shiftOrder || Object.keys(allShifts);

        const dateStr = document.getElementById("quickDate").value;
        if (!dateStr) return;

        const isoDate = dateStr;

        const withPeriod = [];
        const withoutPeriod = [];
        order.forEach((name) => {
          const sh = allShifts[name];
          if (!sh) return;
          if (sh.startDate || sh.endDate) withPeriod.push([name, sh]);
          else withoutPeriod.push([name, sh]);
        });

        const shiftEntries = [...withPeriod, ...withoutPeriod];
        shiftEntries.forEach(([name, sh]) => {
          if (!isDateWithin(isoDate, sh.startDate || null, sh.endDate || null)) return;
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          quickShiftSel.appendChild(opt);
        });
      }

      document.getElementById("quickDate").addEventListener("change", populateQuickShifts);

      document.getElementById("saveQuickBtn").addEventListener("click", () => {
        const date = document.getElementById("quickDate").value;
        const shift = document.getElementById("quickShift").value;
        const note = document.getElementById("quickNote").value;
        if (!date || !shift) return alert("Kies minstens een datum en shift!");

        const year = Number(date.split("-")[0]);
        const month = Number(date.split("-")[1]) - 1;
        const key = date;

        const ud = getCurrentUserData();
        ud.monthData = ud.monthData || {};
        ud.monthData[year] = ud.monthData[year] || {};
        ud.monthData[year][month] = ud.monthData[year][month] || { targetHours: 0, targetMinutes: 0, rows: {} };

        const sh = ud.shifts[shift];
        const minutes = minutesBetween(sh.start, sh.end, sh.break);

        ud.monthData[year][month].rows[key] = {
          project: sh.project || "",
          shift: shift,
          start: sh.start,
          end: sh.end,
          break: sh.break,
          omschrijving: note,
          minutes
        };

        saveAll();
        renderMonth(year, month);
        updateInputTotals();
        renderHistory();

        M.toast({ html: "âœ… Snelle invoer toegevoegd!", classes: "green" });
      });

      // Prefill bij laden
      if (auth.currentUser) populateQuickShifts();
      else auth.onAuthStateChanged((u) => u && populateQuickShifts());

      // Mobiel â†’ auto open
      if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 768) {
        setTimeout(() => M.Modal.getInstance(quickModal).open(), 500);
      }
    }

    /* =========================================
       Converter
    ============================================*/
    function initConverter() {
      const convHours = document.getElementById("convHours");
      const convMinutes = document.getElementById("convMinutes");
      const decimalInput = document.getElementById("decimalInput");

      function updateDecimal() {
        const h = Number(convHours.value) || 0;
        const m = Number(convMinutes.value) || 0;
        const dec = h + m / 60;
        decimalInput.value = dec.toFixed(2);
      }

      function updateHMFromDecimal() {
        const dec = Number(decimalInput.value) || 0;
        const h = Math.floor(dec);
        const m = Math.round((dec - h) * 60);
        convHours.value = h;
        convMinutes.value = m;
      }

      convHours.addEventListener("input", updateDecimal);
      convMinutes.addEventListener("input", updateDecimal);
      decimalInput.addEventListener("input", updateHMFromDecimal);

      updateDecimal();
    }

    /* =========================================
       Labels + Logout
    ============================================*/
    function updateCurrentUserLabels() {
      const ud = dataStore.users[currentUser];
      let label = currentUser || "-";
      if (ud) label = ud.name || ud.email || currentUser;

      currentUserLabel.textContent = label;
      currentUserInvoer.textContent = label;
      currentUserHistoriek.textContent = label;
    }

    function initLogout() {
      const logoutBtn = document.getElementById("logoutBtn");
      if (!logoutBtn) return;
      logoutBtn.addEventListener("click", async () => {
        try {
          await auth.signOut();
          if (!DEBUG) window.location.href = "index.html";
          else alert("DEBUG: uitgelogd, maar je blijft op de pagina.");
        } catch (err) {
          console.error("Fout bij uitloggen:", err);
          alert("Uitloggen is mislukt. Probeer opnieuw.");
        }
      });
    }

    // Expose voor debug
    window.saveAll = saveAll;
    window.getDataStore = () => dataStore;
  </script>
</body>
</html>
