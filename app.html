<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shift Planner — projecten & shifts</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  body { padding:18px; }
  nav .brand-logo { margin-left: 16px; }
  table { font-size: 0.95rem; }
  th, td { text-align: center; vertical-align: middle; }
  .positive { color: green; font-weight: 700; }
  .negative { color: red; font-weight: 700; }
  label { font-size: 0.95rem !important; font-weight: 600; }
  input, select { font-size: 0.95rem !important; padding: 6px 8px; }
  .dur { font-size: 1.05rem; font-weight: 700; }
  .totals { margin-top:10px; font-size:1rem; }
  .small { font-size:0.85rem; }

  /* FAB styling */
  .fixed-action-btn { z-index: 1000; }
  /* Hover-zone uitloggen */
  .logout-zone {
    position: fixed;
    bottom: 0;
    right: 0;
    width: 80px;
    height: 80px;
    z-index: 999;
  }
  .logout-hover {
    position: absolute;
    bottom: 24px;
    right: 24px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .logout-zone:hover .logout-hover {
    opacity: 1;
    pointer-events: auto;
  }
  .admin-zone {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 80px;
  height: 80px;
  z-index: 999;
}
.admin-hover {
  position: absolute;
  bottom: 24px;
  left: 24px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.admin-zone:hover .admin-hover {
  opacity: 1;
  pointer-events: auto;
}
#adminModal {
  max-width: 90% !important;
  width: 90% !important;
  height: 80% !important;
}
#adminModal .modal-content {
  overflow-y: auto;
  height: calc(100% - 64px); /* ruimte voor footer */
}
/* 🔹 Hover effect voor PC */
.quick-zone {
  position: fixed;
  bottom: 0;
  right: 80px; /* naast logout-knop */
  width: 80px;
  height: 80px;
  z-index: 999;
}

.quick-hover {
  position: absolute;
  bottom: 24px;
  right: 24px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.quick-zone:hover .quick-hover {
  opacity: 1;
  pointer-events: auto;
}

/* 🔹 Mobiel → FAB altijd zichtbaar */
@media (max-width: 768px) {
  .quick-hover {
    opacity: 1 !important;
    pointer-events: auto !important;
  }
}
</style>
</head>
<body>

<!-- 🔹 Uitlog knop (rechtsonder, hover) -->
<div class="logout-zone">
  <div class="fixed-action-btn logout-hover">
    <a id="logoutBtn" class="btn-floating btn-large red tooltipped" data-tooltip="Uitloggen">
      <i class="material-icons">logout</i>
    </a>
  </div>
</div>

<!-- 🔹 Admin FAB linksonder -->
<div class="admin-zone">
  <div id="adminFab" class="fixed-action-btn admin-hover" style="display:none;">
    <a id="adminFabBtn" class="btn-floating btn-large orange tooltipped modal-trigger" data-tooltip="Admin beheer" href="#adminModal">
  <i class="material-icons">admin_panel_settings</i>
</a>
  </div>
</div>
<!-- 🔹 Admin Modal -->
<div id="adminModal" class="modal">
  <div class="modal-content">
    <h5>🔑 Admin Beheer</h5>
    <h6>Gebruikersbeheer</h6>
    <div class="row">
      <div class="input-field col s6">
        <select id="adminUserSelect" class="browser-default"></select>
      </div>
      <div class="input-field col s6">
        <button id="addUserBtn" class="btn blue">Nieuwe gebruiker</button>
        <button id="removeUserBtn" class="btn red">Verwijder gebruiker</button>
      </div>
    </div>

    <h6>Projectbeheer</h6>
    <div class="row compact">
      <div class="input-field col s4">
        <input id="newProjectName" type="text"><label for="newProjectName">Project naam</label>
      </div>
      <div class="input-field col s3">
        <input id="newProjectStart" type="date"><label for="newProjectStart">Start datum</label>
      </div>
      <div class="input-field col s3">
        <input id="newProjectEnd" type="date"><label for="newProjectEnd">Eind datum</label>
      </div>
      <div class="input-field col s2">
        <button id="addProjectBtn" class="btn green">Project toevoegen</button>
      </div>
    </div>

    <table class="striped">
      <thead>
        <tr><th>Project</th><th>Start</th><th>Eind</th><th>Acties</th></tr>
      </thead>
      <tbody id="projectTableBody"></tbody>
    </table>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close btn-flat">Sluiten</a>
  </div>
</div>
<nav>
  <div class="nav-wrapper blue">
    <a href="#!" class="brand-logo">Shift Planner</a>
    <ul id="tabs-swipe" class="tabs tabs-fixed-width right">
      <li class="tab col s3"><a class="active" href="#tab-shifts">Shift aanmaken</a></li>
      <li class="tab col s3"><a href="#tab-invoer">Invoer</a></li>
      <li class="tab col s3"><a href="#tab-historiek">Historiek</a></li>
      <li class="tab col s3"><a href="#tab-converter">Tijd omrekenen</a></li>
    </ul>
  </div>
</nav>

<div class="row">
<!-- 🔹 Snelle invoer FAB -->
<div class="quick-zone">
  <div id="quickFab" class="fixed-action-btn quick-hover">
    <a id="quickFabBtn" class="btn-floating btn-large teal tooltipped modal-trigger" 
       data-tooltip="Snelle invoer" href="#quickModal">
      <i class="material-icons">event</i>
    </a>
  </div>
</div>

<!-- 🔹 Snelle Invoer Modal -->
<div id="quickModal" class="modal">
  <div class="modal-content">
    <h5>📅 Snelle Invoer</h5>
    <p>Selecteer datum + shift om snel een dag in te plannen:</p>
    
    <div class="row">
      <div class="input-field col s6">
        <input type="date" id="quickDate">
        <label for="quickDate">Datum</label>
      </div>
      <div class="input-field col s6">
        <select id="quickShift" class="browser-default"></select>
      </div>
    </div>

    <div class="row">
      <div class="input-field col s12">
        <input type="text" id="quickNote">
        <label for="quickNote">Omschrijving (optioneel)</label>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <a href="#!" id="saveQuickBtn" class="btn green">Opslaan</a>
    <a href="#!" class="modal-close btn-flat">Sluiten</a>
  </div>
</div>
  <!-- TAB: Shifts -->
  <div id="tab-shifts" class="col s12">
    <h5>Shift aanmaken — Gebruiker: <span id="currentUserLabel">-</span></h5>

    <div class="row compact">
      <div class="input-field col s3">
        <input id="newShiftName" type="text"><label for="newShiftName">Shift naam</label>
      </div>
      <div class="input-field col s2">
        <input id="newShiftStart" type="time" value="08:00"><label for="newShiftStart">Start</label>
      </div>
      <div class="input-field col s2">
        <input id="newShiftEnd" type="time" value="16:00"><label for="newShiftEnd">Einde</label>
      </div>
      <div class="input-field col s1">
        <input id="newShiftBreak" type="number" min="0" value="0"><label for="newShiftBreak">Pauze</label>
      </div>
      <div class="input-field col s2">
        <select id="newShiftProjectSelect" class="browser-default">
          <option value="">Geen project</option>
        </select>
      </div>
      <div class="input-field col s2">
        <input id="newShiftStartDate" type="date"><label for="newShiftStartDate">Vanaf (opt)</label>
      </div>
      <div class="input-field col s2">
        <input id="newShiftEndDate" type="date"><label for="newShiftEndDate">Tot (opt)</label>
      </div>
      <div class="input-field col s1">
        <button id="addShiftBtn" class="btn green">Toevoegen</button>
      </div>
    </div>

    <div class="row">
  <div class="input-field col s2">
    <select id="filterShiftYear" class="browser-default"></select>
  </div>
</div>
    <table class="striped">
      <thead>
        <tr><th>Naam</th><th>Start</th><th>Einde</th><th>Pauze</th><th>Project</th><th>Periode</th><th>Acties</th></tr>
      </thead>
      <tbody id="shiftTableBody"></tbody>
    </table>
    <p class="small">Je kan shifts herschikken via drag & drop (sleep de rijen).</p>
  </div>

  <!-- TAB: Invoer -->
  <div id="tab-invoer" class="col s12">
  <h5>Invoer — Gebruiker: <span id="currentUserInvoer">-</span></h5>

  <div class="row compact">
    <div class="input-field col s1">
      <input id="monthTargetHours" type="number" min="0" value="0"><label for="monthTargetHours">Doel uren</label>
    </div>
    <div class="input-field col s1">
      <input id="monthTargetMinutes" type="number" min="0" value="0"><label for="monthTargetMinutes">Doel min</label>
    </div>
    <div class="input-field col s2">
      <select id="monthSelectMain" class="browser-default">
          <option value="0">Januari</option><option value="1">Februari</option><option value="2">Maart</option>
          <option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option>
          <option value="6">Juli</option><option value="7">Augustus</option><option value="8">September</option>
          <option value="9">Oktober</option><option value="10">November</option><option value="11">December</option>
        </select>
      </div>
      <div class="input-field col s2">
      <select id="yearSelectMain" class="browser-default"></select>
    </div>
    <div class="input-field col s3">
      <select id="projectFilterSelect" class="browser-default">
        <option value="">Alle projecten</option>
      </select>
    </div>
  </div>

  <table class="striped">
    <thead>
      <tr>
        <th>Dag</th><th>Datum</th><th>Project</th><th>Shift</th>
        <th>Start</th><th>Einde</th><th>Pauze (min)</th><th>Omschrijving</th><th>Duur</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="row totals">
    <div class="col s4"><strong>Doel totaal:</strong> <span id="inputTotDoel">0u 0min</span></div>
    <div class="col s4"><strong>Totaal uren:</strong> <span id="inputTotGepland">0u 0min</span></div>
    <div class="col s4"><strong>Verschil:</strong> <span id="inputTotVerschil">0u 0min</span></div>
  </div>
</div>

  <!-- TAB: Historiek -->
  <div id="tab-historiek" class="col s12">
    <h5>Historiek — Gebruiker: <span id="currentUserHistoriek">-</span> — Jaar: <span id="historiekJaar"></span></h5>

    <table class="striped">
      <thead>
        <tr><th>Maand</th><th>Doel uren</th><th>Gepland</th><th>Verschil</th><th>Verlof</th><th>Ziekte</th><th>Schoolverlof</th><th>Feestdag</th><th>Bench</th></tr>
      </thead>
      <tbody id="historyBody"></tbody>
      <tfoot>
        <tr><th>Totaal</th><th id="totDoel">0u 0min</th><th id="totGepland">0u 0min</th><th id="totVerschil">0u 0min</th>
        <th id="totVerlof">0u 0min</th><th id="totZiekte">0u 0min</th><th id="totSchool">0u 0min</th><th id="totFeest">0u 0min</th><th id="totBench">0u 0min</th></tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- TAB: Converter -->
<div id="tab-converter" class="col s12">
  <h5>🕒 — Uren/minuten ↔ Decimale uren</h5>

  <div class="row compact">
    <div class="input-field col s2">
      <input id="convHours" type="number" min="0" value="0">
      <label for="convHours">Uren</label>
    </div>
    <div class="input-field col s2">
      <input id="convMinutes" type="number" min="0" value="0">
      <label for="convMinutes">Minuten</label>
    </div>
    <div class="input-field col s3">
      <input id="decimalInput" type="number" step="0.01" min="0" value="0">
      <label for="decimalInput">Decimale uren</label>
    </div>
    </div>
  </div>
</div>
<!-- ================== SCRIPTS ================== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<!-- 🔹 Firebase SDK's -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>
  // 🔹 Jouw Firebase-config (die je uit de console haalt)
  const firebaseConfig = {
    apiKey: "AIzaSyB8uHwRXCe1iV7z6T80YPxEbeB64qdMpNY",
    authDomain: "shift-planner-dc7ad.firebaseapp.com",
    projectId: "shift-planner-dc7ad",
    storageBucket: "shift-planner-dc7ad.firebasestorage.app",
    messagingSenderId: "719441527396",
    appId: "1:719441527396:web:de87d6f950fe23702a5571"
  };

  // 🔹 Firebase initialiseren
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
// 🔹 Zet DEBUG aan/uit
const DEBUG = false; // ➡️ verander naar false voor productie

if (DEBUG) {
  console.log(
    "%c⚠️ DEBUG MODUS ACTIEF ⚠️",
    "background: red; color: white; font-size: 20px; font-weight: bold; padding: 8px; border: 2px solid black;"
  );
} 
</script>
<script>
/* ============================
   Data & storage helpers
   ============================ */
// localStorage KEY mag je verwijderen, is niet meer nodig

let dataStore = { users: {}, currentUser: null };
let currentUser = null;
// 🔹 auth state
document.addEventListener("DOMContentLoaded", () => {
  // Init Materialize modal
  var modals = document.querySelectorAll('.modal');
  M.Modal.init(modals);

  // Auth check
auth.onAuthStateChanged(async user => {
  if (!user) {
    if (!DEBUG) window.location.href = "index.html";
    return;
  }

  currentUser = user.uid;   // 👈 altijd jezelf instellen
  dataStore.currentUser = currentUser;

  // ✅ Check en aanvullen van user-doc
  const userRef = db.collection("users").doc(user.uid);
  const doc = await userRef.get();

  if (!doc.exists) {
  await userRef.set({
    email: user.email,
    name: user.displayName || user.email.split('@')[0], // 🔹 naam opslaan
    role: "user",
    shifts: {},
    monthData: {},
    projects: []
  });
} else {
  const data = doc.data();
  const updates = {};
  if (!("email" in data)) updates.email = user.email;
  if (!("name" in data)) updates.name = user.displayName || user.email.split('@')[0];
  if (!("role" in data)) updates.role = "user";
  if (!("shifts" in data)) updates.shifts = {};
  if (!("monthData" in data)) updates.monthData = {};
  if (!("projects" in data)) updates.projects = [];
    if (Object.keys(updates).length > 0) {
      await userRef.update(updates);
    }
  }

  // ✅ Alle users laden + jouw data
  await initApp();

  // ✅ Labels correct vullen (nu staat email in dataStore)
  updateCurrentUserLabels();

 // ✅ Admin-knop tonen
const data = (await userRef.get()).data();
console.log("Ingelogd als:", user.email, "→ role:", data.role); // 👈 log erbij

if (data.role === "admin") {
  document.getElementById("adminFab").style.display = "block";
  await renderAdminUserSelect();
  document.getElementById("adminUserSelect").value = currentUser;
} else if (DEBUG) {
  document.getElementById("adminFab").style.display = "block";
}

updateCurrentUserLabels(); // 👈 nu pas labels invullen
});

});
// 🔹 Admin user select
async function renderAdminUserSelect(){
  const snapshot = await db.collection("users").get();
  const sel = document.getElementById("adminUserSelect");
  sel.innerHTML="";
  snapshot.forEach(doc=>{
    const opt=document.createElement("option");
    opt.value=doc.id;
    const u = doc.data();
opt.textContent = u.name || u.email || doc.id;
    sel.appendChild(opt);
  });
  sel.addEventListener("change", async ()=>{
    currentUser=sel.value;
    await loadUser(currentUser);
    sel.value = currentUser;
    renderProjects();
    renderShifts();
    updateCurrentUserLabels();
    renderHistory();
  });
}
// 🔹 Save naar Firestore
async function saveAll(){
  if (!currentUser) return;
  console.log("saveAll →", currentUser, dataStore.users[currentUser]);
  await db.collection("users").doc(currentUser).set(dataStore.users[currentUser]);
}

// 🔹 Load uit Firestore
async function loadUser(userName){
  console.log("loadUser:", userName);
  const doc = await db.collection("users").doc(userName).get();
  if(doc.exists){
    console.log("→ gevonden in Firestore:", doc.data());
    dataStore.users[userName] = doc.data();
  } else {
    console.log("→ nieuw user, nog niet in Firestore");
    dataStore.users[userName] = { shifts:{}, monthData:{}, projects:[] };
    await saveAll();   // 🔹 toevoegen zodat nieuwe user direct in Firestore komt
}
}
async function loadAllUsers() {
  if (!auth.currentUser) return;
  const userRef = db.collection("users").doc(auth.currentUser.uid);
  const userDoc = await userRef.get();
  const role = userDoc.data().role;

  dataStore.users = {};

  if (role === "admin") {
    // admin → alle users ophalen
    const snapshot = await db.collection("users").get();
    snapshot.forEach(doc => {
      dataStore.users[doc.id] = doc.data();
    });
  } else {
    // gewone user → alleen zichzelf ophalen
    dataStore.users[auth.currentUser.uid] = userDoc.data();
  }

  console.log("loadAllUsers →", Object.keys(dataStore.users));
}
document.addEventListener("DOMContentLoaded", () => {
  // Init Materialize modal
  const quickModal = document.getElementById("quickModal");
  M.Modal.init(quickModal);

  // Vullen met shifts uit je database
  const quickShiftSel = document.getElementById("quickShift");
  function populateQuickShifts() {
  const userData = getCurrentUserData();
  const quickShiftSel = document.getElementById("quickShift");
  quickShiftSel.innerHTML = '<option value="">-- Kies shift --</option>';

  const allShifts = userData.shifts || {};
  const order = userData.shiftOrder || Object.keys(allShifts);

  // pak de gekozen datum
  const dateStr = document.getElementById("quickDate").value;
  if (!dateStr) return; // geen datum gekozen → stop

  const isoDate = dateStr; // "YYYY-MM-DD"

  // zelfde logica als bij invoer: eerst met periode, dan zonder
  const withPeriod = [];
  const withoutPeriod = [];
  order.forEach(name => {
    const sh = allShifts[name];
    if (!sh) return;
    if (sh.startDate || sh.endDate) {
      withPeriod.push([name, sh]);
    } else {
      withoutPeriod.push([name, sh]);
    }
  });

  const shiftEntries = [...withPeriod, ...withoutPeriod];

  shiftEntries.forEach(([name, sh]) => {
    if (!isDateWithin(isoDate, sh.startDate || null, sh.endDate || null)) return;

    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    quickShiftSel.appendChild(opt);
  });
}
  // 🔹 Shifts updaten zodra datum verandert
  document.getElementById("quickDate").addEventListener("change", populateQuickShifts);

  // Opslaan van snelle invoer
  document.getElementById("saveQuickBtn").addEventListener("click", () => {
    const date = document.getElementById("quickDate").value;
    const shift = document.getElementById("quickShift").value;
    const note = document.getElementById("quickNote").value;
    if (!date || !shift) {
      return alert("Kies minstens een datum en shift!");
    }

    const year = Number(date.split("-")[0]);
    const month = Number(date.split("-")[1]) - 1;
    const key = date;

    const userData = getCurrentUserData();
    if (!userData.monthData) userData.monthData = {};
    if (!userData.monthData[year]) userData.monthData[year] = {};
    if (!userData.monthData[year][month]) userData.monthData[year][month] = {targetHours:0, targetMinutes:0, rows:{}};

    const sh = userData.shifts[shift];
    const minutes = minutesBetween(sh.start, sh.end, sh.break);

    userData.monthData[year][month].rows[key] = {
      project: sh.project || "",
      shift: shift,
      start: sh.start,
      end: sh.end,
      break: sh.break,
      omschrijving: note,
      minutes: minutes
    };

    saveAll();
    renderMonth(year, month);
    updateInputTotals();
    renderHistory();
    M.Modal.getInstance(quickModal).close();
    alert("✅ Snelle invoer toegevoegd!");
  });

  // Autovullen shifts zodra user geladen is
  if (auth.currentUser) populateQuickShifts();
  else auth.onAuthStateChanged(u => { if (u) populateQuickShifts(); });

  // Mobiel → open automatisch bij laden
  function isMobile() {
    return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 768;
  }
  if (isMobile()) {
    setTimeout(() => {
      M.Modal.getInstance(quickModal).open();
    }, 500);
  }
});


/* ============================
   Utils
   ============================ */
const daysFull = ["Zondag","Maandag","Dinsdag","Woensdag","Donderdag","Vrijdag","Zaterdag"];
const monthsFull = ["Januari","Februari","Maart","April","Mei","Juni","Juli","Augustus","September","Oktober","November","December"];

function dateKey(y,m,d){
  return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}
function minutesBetween(startStr, endStr, breakMin){
  // startStr, endStr like "08:00"
  if(!startStr || !endStr) return 0;
  const [sh,sm] = startStr.split(':').map(Number);
  const [eh,em] = endStr.split(':').map(Number);
  let mins = (eh*60+em) - (sh*60+sm) - (Number(breakMin)||0);
  if(mins < 0) mins += 24*60;
  return mins;
}
function toDisplayDate(iso){
  if(!iso) return '-';
  const parts = iso.split('-');
  if(parts.length !== 3) return iso;
  const [y,m,d] = parts;
  return `${d.padStart(2,'0')}-${m.padStart(2,'0')}-${y}`;
}

function fromDisplayDate(display){
  if(!display) return null;
  const parts = display.split('-');
  if(parts.length !== 3) return null;
  const [day,month,year] = parts;
  return `${year}-${month}-${day}`; // terug naar ISO
}
/* compare ISO date strings safely ('' means no restriction) */
function isDateWithin(isoDate, startIso, endIso){
  const d = isoDate ? isoDate.replaceAll('-','') : null; // YYYYMMDD
  const s = startIso ? startIso.replaceAll('-','') : null;
  const e = endIso ? endIso.replaceAll('-','') : null;
  if(!d) return false;
  if(s && d < s) return false;
  if(e && d > e) return false;
  return true;
}
/* ===== Helpers voor projecten ===== */
function ensurePXLProjectExists(){
  const ud = getCurrentUserData();
  ud.projects = ud.projects || [];
  let p = ud.projects.find(p => p.name === "PXL Verpleegkunde Hasselt");
  if(!p){
    p = { name:"PXL Verpleegkunde Hasselt", start:null, end:null };
    ud.projects.push(p);
    saveAll();
    renderProjects(); // zodat het overal meteen gekend is
  }
  return p;
}
function ensureEghtCareProjectExists(){
  const ud = getCurrentUserData();
  ud.projects = ud.projects || [];
  let p = ud.projects.find(p => p.name === "Eght Care");
  if(!p){
    p = { name:"Eght Care", start:null, end:null };
    ud.projects.push(p);
    saveAll();
    renderProjects(); // overal meteen gekend
  }
  return p;
}

function ensureOptionInSelect(selectEl, value, label){
  const exists = Array.from(selectEl.options).some(o => o.value === value);
  if(!exists){
    const opt = document.createElement('option');
    opt.value = value;
    opt.textContent = label || value;
    selectEl.appendChild(opt);
  }
}

function projectByName(name){
  return (getCurrentUserData().projects || []).find(p => p.name === name) || null;
}

function projectIsValidForDate(p, isoDate){
  if(!p) return false;
  // Alleen projecten met een ingestelde periode (start of eind) & datum binnen die periode
  if(!(p.start || p.end)) return false;
  return isDateWithin(isoDate, p.start || null, p.end || null);
}
/* ============================
   Materialize Tabs init
   ============================ */
document.addEventListener('DOMContentLoaded', async function(){
  var elems = document.querySelectorAll('.tabs');
  M.Tabs.init(elems, { swipeable: false });
  const instance = M.Tabs.getInstance(elems[0]);
  instance.select('tab-shifts');
});

/* ============================
   Elements
   ============================ */
const addUserBtn = document.getElementById('addUserBtn');
const removeUserBtn = document.getElementById('removeUserBtn');
// 🔹 Admin: nieuwe gebruiker maken
addUserBtn.addEventListener('click', async () => {
  const email = prompt("Geef e-mailadres voor de nieuwe gebruiker:");
  if (!email) return;

  // nieuwe gebruiker-document met role=user
  const newRef = db.collection("users").doc();
  await newRef.set({
    email: email,
    role: "user",
    shifts: {},
    monthData: {},
    projects: []
  });

  alert(`Nieuwe gebruiker toegevoegd: ${email}`);
  renderAdminUserSelect();
});

// 🔹 Admin: gebruiker verwijderen
removeUserBtn.addEventListener('click', async () => {
  const sel = document.getElementById("adminUserSelect");
  const uid = sel.value;
  if (!uid) return alert("Geen gebruiker geselecteerd.");
  
  if (!confirm(`Weet je zeker dat je gebruiker ${uid} wilt verwijderen?`)) return;

  try {
    await db.collection("users").doc(uid).delete();
    delete dataStore.users[uid];

    // reset currentUser
    currentUser = auth.currentUser.uid;
    await loadUser(currentUser);

    alert(`Gebruiker ${uid} verwijderd.`);
    renderAdminUserSelect();
    renderProjects();
    renderShifts();
    updateCurrentUserLabels();
    renderHistory();
  } catch (err) {
    console.error("Fout bij verwijderen gebruiker:", err);
    alert("Fout bij verwijderen gebruiker, check de console.");
  }
});
const currentUserLabel = document.getElementById('currentUserLabel');
const currentUserInvoer = document.getElementById('currentUserInvoer');
const currentUserHistoriek = document.getElementById('currentUserHistoriek');
const projectTableBody = document.getElementById('projectTableBody');
const newProjectName = document.getElementById('newProjectName');
const newProjectStart = document.getElementById('newProjectStart');
const newProjectEnd = document.getElementById('newProjectEnd');
const addProjectBtn = document.getElementById('addProjectBtn');

const newShiftName = document.getElementById('newShiftName');
const newShiftStart = document.getElementById('newShiftStart');
const newShiftEnd = document.getElementById('newShiftEnd');
const newShiftBreak = document.getElementById('newShiftBreak');
const newShiftProjectSelect = document.getElementById('newShiftProjectSelect');
const newShiftStartDate = document.getElementById('newShiftStartDate');
const newShiftEndDate = document.getElementById('newShiftEndDate');
const addShiftBtn = document.getElementById('addShiftBtn');
const shiftTableBody = document.getElementById('shiftTableBody');
const filterShiftYear = document.getElementById('filterShiftYear');

const monthSelectMain = document.getElementById('monthSelectMain');
const yearSelectMain = document.getElementById('yearSelectMain');
const projectFilterSelect = document.getElementById('projectFilterSelect');
const monthTargetHours = document.getElementById('monthTargetHours');
const monthTargetMinutes = document.getElementById('monthTargetMinutes');
const generateMonthBtn = document.getElementById('generateMonthBtn');
const tbody = document.getElementById('tbody');

const inputTotDoel = document.getElementById('inputTotDoel');
const inputTotGepland = document.getElementById('inputTotGepland');
const inputTotVerschil = document.getElementById('inputTotVerschil');

const historyBody = document.getElementById('historyBody');
const historiekJaar = document.getElementById('historiekJaar');
const projectFilterSelect_el = projectFilterSelect;

/* ============================
   Data accessors
   ============================ */
function getCurrentUserData(){
  if(!currentUser) return {shifts:{}, monthData:{}, projects:[]};
  if(!dataStore.users[currentUser]) dataStore.users[currentUser] = {shifts:{}, monthData:{}, projects:[]};
  return dataStore.users[currentUser];
}

/* ============================
   Initialization
   ============================ */
async function initApp(){
  // 🔹 laad eerst alle gebruikers uit Firestore
  await loadAllUsers();

  if(!currentUser){
    const users = Object.keys(dataStore.users);
    currentUser = users.length > 0 ? users[0] : null;
    dataStore.currentUser = currentUser;
  }
  if(currentUser){
    await loadUser(currentUser);
  }

  populateYearSelect();
  renderProjects();
  renderShifts();
  updateCurrentUserLabels();
  renderHistory();
  renderProjectFilterForMonth(); 
  populateFilterShiftYears();
  generateMonth();
}
/* ============================
   Projects (per user)
   ============================ */
function renderProjects(){
  projectTableBody.innerHTML = '';
  // projectFilter and newShiftProject select should reflect current user's projects
  newShiftProjectSelect.innerHTML = '<option value="">Geen project</option>';
  projectFilterSelect_el.innerHTML = '<option value="">Alle projecten</option>';
  const userData = getCurrentUserData();
  let projects = userData.projects || [];

  // sorteren op startdatum (oudste eerst), en bij gelijke startdatum op einddatum
  projects = projects.slice().sort((a,b)=>{
    const aStart = a.start ? new Date(a.start) : new Date("1900-01-01");
    const bStart = b.start ? new Date(b.start) : new Date("1900-01-01");
    if(aStart.getTime() !== bStart.getTime()) return aStart - bStart;
    const aEnd = a.end ? new Date(a.end) : new Date("9999-12-31");
    const bEnd = b.end ? new Date(b.end) : new Date("9999-12-31");
    return aEnd - bEnd;
  });

  projects.forEach((p, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.name}</td><td>${toDisplayDate(p.start)}</td><td>${toDisplayDate(p.end)}</td>
      <td>
        <button class="btn orange btn-small" onclick="extendProject(${idx})">Verleng</button>
        <button class="btn red btn-small" onclick="deleteProject(${idx})">Verwijder</button>
      </td>`;
    projectTableBody.appendChild(tr);

    const opt1 = document.createElement('option'); opt1.value = p.name; opt1.textContent = p.name; newShiftProjectSelect.appendChild(opt1);
    const opt2 = document.createElement('option'); opt2.value = p.name; opt2.textContent = p.name; projectFilterSelect_el.appendChild(opt2);
  });

  // overschrijf de gesorteerde lijst ook terug in dataStore
  userData.projects = projects;
  saveAll();
}

addProjectBtn.addEventListener('click', ()=>{
  if(!currentUser) return alert("Kies eerst een gebruiker");
  const name = newProjectName.value.trim();
  if(!name) return alert("Vul projectnaam in");
  const start = newProjectStart.value || null;
  const end = newProjectEnd.value || null;
  const userData = getCurrentUserData();
  if(!userData.projects) userData.projects = [];
  userData.projects.push({name, start, end});
  saveAll();
  newProjectName.value=''; newProjectStart.value=''; newProjectEnd.value='';
  renderProjects();
});

window.extendProject = function(index){
  const userData = getCurrentUserData();
  const p = userData.projects[index];
  if(!p) return;
  const newEnd = prompt("Nieuwe einddatum (DD-MM-YYYY):", toDisplayDate(p.end) || '');
if(!newEnd) return;
p.end = fromDisplayDate(newEnd);
  saveAll();
  renderProjects();
};

window.deleteProject = function(index){
  if(!confirm("Project verwijderen?")) return;
  const userData = getCurrentUserData();
  userData.projects.splice(index,1);
  saveAll();
  renderProjects();
};

function renderProjectFilterForMonth(){
  projectFilterSelect_el.innerHTML = '<option value="">Alle projecten</option>';

  const y = Number(yearSelectMain.value);
  const m = Number(monthSelectMain.value);
  const daysInMonth = new Date(y, m+1, 0).getDate();
  const monthStart = `${y}-${String(m+1).padStart(2,'0')}-01`.replaceAll('-','');
  const monthEnd   = `${y}-${String(m+1).padStart(2,'0')}-${String(daysInMonth).padStart(2,'0')}`.replaceAll('-','');

  const userData = getCurrentUserData();
  (userData.projects || []).forEach(p => {
    if(p.start || p.end){
      // project heeft een periode → enkel tonen bij overlap
      const projStart = (p.start || "0000-01-01").replaceAll('-','');
      const projEnd   = (p.end   || "9999-12-31").replaceAll('-','');
      if(projStart <= monthEnd && projEnd >= monthStart){
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name;
        projectFilterSelect_el.appendChild(opt);
      }
    } else {
      // project zonder periode → altijd tonen
      const opt = document.createElement('option');
      opt.value = p.name;
      opt.textContent = p.name;
      projectFilterSelect_el.appendChild(opt);
    }
  });
}

/* ============================
   Shifts (per user)
   ============================ */
function renderShifts(){
  shiftTableBody.innerHTML = '';
  const userData = getCurrentUserData();
  const shifts = userData.shifts || {};

  // gebruik altijd shiftOrder, of anders alfabetisch
  const order = userData.shiftOrder || Object.keys(shifts);
  const selectedYear = filterShiftYear.value;

  order.forEach(sName => {
    const sh = shifts[sName];
    if(!sh) return;

    // filter op jaar indien gekozen
    if (selectedYear && sh.startDate) {
      const year = new Date(sh.startDate).getFullYear().toString();
      if(year !== selectedYear) return;
    } else if (selectedYear && !sh.startDate) {
      return; // geen startDate → valt buiten filter
    }

    const tr = document.createElement('tr');
    tr.setAttribute('draggable','true');
    tr.dataset.shiftName = sName;
    tr.innerHTML = `
      <td class="nowrap">${sName}</td>
      <td>${sh.start||''}</td>
      <td>${sh.end||''}</td>
      <td>${sh.break||0}</td>
      <td>${sh.project||''}</td>
      <td>${toDisplayDate(sh.startDate)} → ${toDisplayDate(sh.endDate)}</td>
      <td>
        <button class="btn orange btn-small" onclick="editShift('${sName}')">Bewerk</button>
        <button class="btn red btn-small" onclick="deleteShift('${sName}')">Verwijder</button>
      </td>`;
    shiftTableBody.appendChild(tr);
  });

  enableDragAndDropOnShifts();
}
addShiftBtn.addEventListener('click', ()=>{
  if(!currentUser) return alert("Kies eerst een gebruiker");
  const name = newShiftName.value.trim();
  if(!name) return alert("Vul shift naam in");
  const userData = getCurrentUserData();
  if(!userData.shifts) userData.shifts = {};
  userData.shifts[name] = {
    start: newShiftStart.value || '00:00',
    end: newShiftEnd.value || '00:00',
    break: Number(newShiftBreak.value)||0,
    project: newShiftProjectSelect.value || null,
    startDate: newShiftStartDate.value || null,
    endDate: newShiftEndDate.value || null
  };

  // 🔹 Voeg nieuwe shift ook toe aan de volgorde-array
  if(!userData.shiftOrder) userData.shiftOrder = [];
  if(!userData.shiftOrder.includes(name)) {
    userData.shiftOrder.push(name);
  }

  saveAll();
  newShiftName.value=''; newShiftBreak.value=0; newShiftStartDate.value=''; newShiftEndDate.value='';
  renderShifts();
});

window.deleteShift = function(s){
  if(!confirm(`Shift ${s} verwijderen?`)) return;
  const userData = getCurrentUserData();
  delete userData.shifts[s];
  saveAll();
  renderShifts();
};
window.editShift = function(name){
  const userData = getCurrentUserData();
  const sh = userData.shifts[name];
  if(!sh) return;

  // Vul de velden met de bestaande waarden
  newShiftName.value = name;
  newShiftStart.value = sh.start;
  newShiftEnd.value = sh.end;
  newShiftBreak.value = sh.break;
  newShiftProjectSelect.value = sh.project || "";
  newShiftStartDate.value = sh.startDate || "";
  newShiftEndDate.value = sh.endDate || "";

  // Shift tijdelijk verwijderen → bij toevoegen wordt hij herschreven
  delete userData.shifts[name];
  saveAll();
  renderShifts();
};

function enableDragAndDropOnShifts(){
  const rows = shiftTableBody.querySelectorAll('tr');
  let dragSrc = null;
  rows.forEach(r=>{
    r.addEventListener('dragstart',(e)=>{ dragSrc=r; e.dataTransfer.effectAllowed='move'; });
    r.addEventListener('dragover',(e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
    r.addEventListener('drop',(e)=>{ e.preventDefault(); if(dragSrc && dragSrc!==r){ shiftTableBody.insertBefore(dragSrc,r.nextSibling); saveShiftOrder(); } });
  });
}
function saveShiftOrder(){
  if(!currentUser) return;
  const userData = getCurrentUserData();
  userData.shiftOrder = Array.from(shiftTableBody.querySelectorAll('tr'))
    .map(tr => tr.dataset.shiftName);
  saveAll();
}

/* ============================
   Year/Month populate
   ============================ */
function populateYearSelect(){
  const now = new Date();
  const yNow = now.getFullYear();
  yearSelectMain.innerHTML = '';
  for(let y = yNow-2; y<=yNow+3; y++){
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    if(y === yNow) opt.selected = true;
    yearSelectMain.appendChild(opt);
  }
}

// 🔹 aparte functie, niet genest
function populateFilterShiftYears(){
  const userData = getCurrentUserData();
  const years = new Set();

  Object.values(userData.shifts || {}).forEach(sh=>{
    if(sh.startDate){
      years.add(new Date(sh.startDate).getFullYear());
    }
  });

  filterShiftYear.innerHTML = '<option value="">Alle jaren</option>';
  [...years].sort().forEach(y=>{
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    filterShiftYear.appendChild(opt);
  });
}

filterShiftYear.addEventListener('change', renderShifts);

/* ============================
   Generate month & invoer table
   ============================ */
function generateMonth(){
  if(!currentUser) return alert("Kies eerst een gebruiker");
  const year = Number(yearSelectMain.value);
  const month = Number(monthSelectMain.value);

  const userData = getCurrentUserData();
  if(!userData.monthData) userData.monthData = {};
  if(!userData.monthData[year]) userData.monthData[year] = {};
  // Bestaat de maand nog niet? Maak ze aan, maar zet targets NIET vanuit de inputs.
  if(!userData.monthData[year][month]) {
    userData.monthData[year][month] = { targetHours:0, targetMinutes:0, rows:{} };
  }

  // Niets overschrijven hier: de targets worden enkel opgeslagen via de input-listeners.
  saveAll();
  renderMonth(year, month);
  updateInputTotals();
  renderHistory();
}

function renderMonth(year, month){
  tbody.innerHTML = '';
  const userData = getCurrentUserData();
  if(!userData.monthData) userData.monthData = {};
  if(!userData.monthData[year]) userData.monthData[year] = {};
  if(!userData.monthData[year][month]) userData.monthData[year][month] = { targetHours:0, targetMinutes:0, rows:{} };
  const md = userData.monthData[year][month];
  // fill targets UI
  monthTargetHours.value = md.targetHours || 0;
  monthTargetMinutes.value = md.targetMinutes || 0;

  const daysInMonth = new Date(year, month+1, 0).getDate();
  for(let d=1; d<=daysInMonth; d++){
    const dtKey = dateKey(year, month, d); // dd-mm-yyyy
    if(!md.rows[dtKey]){
      md.rows[dtKey] = { project:'', shift:'', start:'00:00', end:'00:00', break:0, omschrijving:'', minutes:0 };
    }
    const rowData = md.rows[dtKey];
    const dayName = daysFull[new Date(year, month, d).getDay()];
    const tr = document.createElement('tr');
tr.innerHTML = `
  <td>${dayName}</td>
  <td>${String(d).padStart(2,'0')}-${String(month+1).padStart(2,'0')}-${year}</td>
  <td><select class="browser-default projectSelect"></select></td>
  <td><select class="browser-default shiftSelect"></select></td>
  <td><input class="startInput" type="time" value="${rowData.start}"></td>
  <td><input class="endInput" type="time" value="${rowData.end}"></td>
  <td><input class="breakInput" type="number" min="0" value="${rowData.break}"></td>
  <td><input class="omschrijvingInput" type="text" value="${rowData.omschrijving}"></td>
  <td class="dur">${Math.floor(rowData.minutes/60)}u ${rowData.minutes%60}min</td>
`;
tbody.appendChild(tr);
if (projectFilterSelect_el.value) {
  if (rowData.project !== projectFilterSelect_el.value) {
    tr.style.display = "none";
  }
}
// populate project select
const projSel = tr.querySelector('.projectSelect');
projSel.innerHTML = '<option value="">--</option>';

const eligible = [];
(userData.projects || []).forEach(p => {
  if((p.start || p.end) && isDateWithin(dtKey, p.start || null, p.end || null)){
    eligible.push(p.name);
    const opt = document.createElement('option');
    opt.value = p.name;
    opt.textContent = p.name;
    projSel.appendChild(opt);
  }
});
// Als deze rij al "Schoolverlof" (of "School") als shift heeft: forceer PXL in de dropdown
if (rowData.shift === "Schoolverlof" || rowData.shift === "School") {
  ensurePXLProjectExists();
  ensureOptionInSelect(projSel, "PXL Verpleegkunde Hasselt", "PXL Verpleegkunde Hasselt");
  rowData.project = "PXL Verpleegkunde Hasselt";
  projSel.value = "PXL Verpleegkunde Hasselt";
  saveCell(year, month, dtKey, rowData, tr);
  saveAll();
}
// Als deze rij al "Verlof" (of "Teammeeting") als shift heeft: forceer Eght Care in de dropdown
if (rowData.shift === "Verlof" || rowData.shift === "Teammeeting") {
  ensureEghtCareProjectExists();
  ensureOptionInSelect(projSel, "Eght Care", "Eght Care");
  rowData.project = "Eght Care";
  projSel.value = "Eght Care";
  saveCell(year, month, dtKey, rowData, tr);
  saveAll();
}

// Als er nog geen shift gekozen is (vrij weekend / niet ingepland),
// of de rij heeft een ongeldig project → kies automatisch geldig project
if (
  (!rowData.shift || (eligible.length > 0 && !eligible.includes(rowData.project)))
  && rowData.shift !== "Bench"
  && rowData.shift !== "School"
  && rowData.shift !== "Schoolverlof"
  && rowData.shift !== "Verlof"
  && rowData.shift !== "Teammeeting"
) {
  if (eligible.length > 0) {
    rowData.project = eligible[0]; // eerste geldig project
  } else {
    rowData.project = ''; // geen project beschikbaar
  }
  saveCell(year, month, dtKey, rowData, tr);
}

// Reflecteer de (nieuwe) waarde in de dropdown
if(rowData.project){
  projSel.value = rowData.project;
}

// Wanneer gebruiker het project wijzigt: opslaan + shifts heropbouwen
projSel.addEventListener('change', ()=>{
  rowData.project = projSel.value || '';
  saveCell(year, month, dtKey, rowData, tr);
  populateShiftSelectForRow(tr, d, month, year);
  updateInputTotals();
  saveAll(); // 🔹 direct opslaan
});

// >>> Belangrijk: roep pas hierna de shifts-populatie aan, zodat hij de gekozen projectwaarde meekrijgt.
populateShiftSelectForRow(tr, d, month, year);

    // attach other inputs
tr.querySelector('.startInput').addEventListener('change', (e)=>{ 
  rowData.start = e.target.value; 
  recalcRowMinutes(rowData); 
  saveCell(year, month, dtKey, rowData, tr);
  tr.querySelector('.dur').textContent = `${Math.floor(rowData.minutes/60)}u ${rowData.minutes%60}min`; 
  updateInputTotals(); 
  saveAll(); 
  renderHistory();
});

tr.querySelector('.endInput').addEventListener('change', (e)=>{ 
  rowData.end = e.target.value; 
  recalcRowMinutes(rowData); 
  saveCell(year, month, dtKey, rowData, tr);
  tr.querySelector('.dur').textContent = `${Math.floor(rowData.minutes/60)}u ${rowData.minutes%60}min`; 
  updateInputTotals(); 
  saveAll(); 
  renderHistory();
});

tr.querySelector('.breakInput').addEventListener('input', (e)=>{ 
  rowData.break = Number(e.target.value)||0; 
  recalcRowMinutes(rowData); 
  saveCell(year, month, dtKey, rowData, tr);
  tr.querySelector('.dur').textContent = `${Math.floor(rowData.minutes/60)}u ${rowData.minutes%60}min`; 
  updateInputTotals(); 
  saveAll(); 
  renderHistory();
});

tr.querySelector('.omschrijvingInput').addEventListener('change', (e)=>{ 
  rowData.omschrijving = e.target.value; 
  saveCell(year, month, dtKey, rowData, tr); 
  saveAll(); 
  renderHistory();
});
  }
  saveAll();
}

function populateShiftSelectForRow(tr, day, month, year){
  const key = dateKey(year, month, day);   // juist!
  const userData = getCurrentUserData();
  const md = userData.monthData[year][month];
  const rowData = md.rows[key];
  const projSel = tr.querySelector('.projectSelect');
  const shiftSel = tr.querySelector('.shiftSelect');
  shiftSel.innerHTML = '<option value=""></option>';

  const isoDate = key; 
  const projectFilterVal = projectFilterSelect_el.value; 
  const selectedRowProject = projSel.value || '';

  const allShifts = getCurrentUserData().shifts || {};

  // volgorde volgens shiftOrder
const shiftOrder = userData.shiftOrder || Object.keys(allShifts);

// splitsen in 2 groepen
const withPeriod = [];
const withoutPeriod = [];

shiftOrder.forEach(sName => {
  const sh = allShifts[sName];
  if(!sh) return;
  if (sh.startDate || sh.endDate) {
    withPeriod.push([sName, sh]);
  } else {
    withoutPeriod.push([sName, sh]);
  }
});

// eerst shiften met periode, daarna de rest
const shiftEntries = [...withPeriod, ...withoutPeriod];

for (const [sName, sh] of shiftEntries) {
  // project filtering
  let projectAllowed = false;
  if(sh.project){
    if(selectedRowProject && sh.project === selectedRowProject) projectAllowed = true;
    else if(!selectedRowProject && projectFilterVal && sh.project === projectFilterVal) projectAllowed = true;
    else if(!selectedRowProject && !projectFilterVal) projectAllowed = true;
  } else {
    projectAllowed = true;
  }
  if(!projectAllowed) continue;

  // date check
  const within = isDateWithin(isoDate, sh.startDate || null, sh.endDate || null);
  if(!within) continue;

  const opt = document.createElement('option');
  opt.value = sName;
  opt.textContent = sName;
  if(rowData.shift === sName) opt.selected = true;
  shiftSel.appendChild(opt);
}

  // when selecting a shift, autofill times & break
// when selecting a shift, autofill times & break
shiftSel.addEventListener('change', ()=> {
  const chosen = shiftSel.value;
  const allShifts2 = getCurrentUserData().shifts || {};
  const projSel = tr.querySelector('.projectSelect');

  if (!chosen) {
    rowData.shift = '';
    // Automatisch eerste geldige project (alleen met periode) voor die datum
    const valid = (getCurrentUserData().projects || []).find(p =>
      (p.start || p.end) && isDateWithin(key, p.start || null, p.end || null)
    );
    rowData.project = valid ? valid.name : '';
    projSel.value = rowData.project;
    saveCell(year, month, key, rowData, tr);
    saveAll();
    renderHistory();
    updateInputTotals();
    return;
  }

  rowData.shift = chosen;

  if (chosen === "Bench") {
    // Bench → project leeg/--
    rowData.project = "";
    projSel.value = "";
  }
  else if (chosen === "Schoolverlof" || chosen === "School") {
    // Schoolverlof → altijd PXL, zelfs zonder periode (alleen voor deze rij)
    ensurePXLProjectExists();
    ensureOptionInSelect(projSel, "PXL Verpleegkunde Hasselt", "PXL Verpleegkunde Hasselt");
    rowData.project = "PXL Verpleegkunde Hasselt";
    projSel.value = "PXL Verpleegkunde Hasselt";
  }
    else if (chosen === "Verlof" || chosen === "Teammeeting") {
    // Schoolverlof → altijd PXL, zelfs zonder periode (alleen voor deze rij)
    ensureEghtCareProjectExists();
    ensureOptionInSelect(projSel, "Eght Care", "Eght Care");
    rowData.project = "Eght Care";
    projSel.value = "Eght Care";
  }
  else {
    // Normale shift: als de shift aan een project hangt en die is geldig op de datum → kies dat project
    const sh = allShifts2[chosen];
    if (sh && sh.project) {
      const p = projectByName(sh.project);
      if (projectIsValidForDate(p, key)) {
        rowData.project = p.name;
        projSel.value = p.name;
      } else {
        // anders: kies het eerste geldige project op datum
        const valid = (getCurrentUserData().projects || []).find(p =>
          (p.start || p.end) && isDateWithin(key, p.start || null, p.end || null)
        );
        rowData.project = valid ? valid.name : '';
        projSel.value = rowData.project;
      }
    } else {
      // shift heeft geen project → kies eerste geldige project op datum
      const valid = (getCurrentUserData().projects || []).find(p =>
        (p.start || p.end) && isDateWithin(key, p.start || null, p.end || null)
      );
      rowData.project = valid ? valid.name : '';
      projSel.value = rowData.project;
    }
  }

  // Tijden/pauze overnemen
if(allShifts2[chosen]){
  const sh = allShifts2[chosen];
  if(!rowData.start || rowData.start === "00:00") rowData.start = sh.start || '00:00';
  if(!rowData.end   || rowData.end   === "00:00") rowData.end   = sh.end   || '00:00';
  if(!rowData.break || rowData.break === 0)       rowData.break = Number(sh.break) || 0;
}

  recalcRowMinutes(rowData);
  tr.querySelector('.startInput').value = rowData.start;
  tr.querySelector('.endInput').value   = rowData.end;
  tr.querySelector('.breakInput').value = rowData.break;
  tr.querySelector('.dur').textContent  = `${Math.floor(rowData.minutes/60)}u ${rowData.minutes%60}min`;

  saveCell(year, month, key, rowData, tr);
  saveAll();
  updateInputTotals();
});
}
// kleine helper
function findProject(name){
  return (getCurrentUserData().projects || []).find(p => p.name===name);
}

/* save single cell row */
function saveCell(year, month, key, rowData, tr){
  const userData = getCurrentUserData();
  if(!userData.monthData) userData.monthData = {};
  if(!userData.monthData[year]) userData.monthData[year] = {};
  if(!userData.monthData[year][month]) userData.monthData[year][month] = {targetHours:0,targetMinutes:0,rows:{}};
  
  userData.monthData[year][month].rows[key] = Object.assign({}, rowData);
  userData.monthData[year][month].rows[key].minutes = rowData.minutes || minutesBetween(rowData.start, rowData.end, rowData.break);
  
  saveAll();
  renderHistory();   // 🔹 update historiek telkens er een cel verandert
}

/* recalc minutes into rowData.minutes */
function recalcRowMinutes(rowData){
  const mins = minutesBetween(rowData.start, rowData.end, rowData.break);
  rowData.minutes = mins;
}

/* update totals shown under invoer */
function updateInputTotals(){
  const year = Number(yearSelectMain.value);
  const month = Number(monthSelectMain.value);
  const userData = getCurrentUserData();
  const md = userData.monthData && userData.monthData[year] && userData.monthData[year][month] ? userData.monthData[year][month] : null;
  const totalMin = md ? Object.values(md.rows).reduce((s,r)=> s + (r.minutes||0), 0) : 0;
  const targetMin = md ? ( (md.targetHours||0)*60 + (md.targetMinutes||0) ) : 0;
  const diff = totalMin - targetMin;
  inputTotDoel.textContent = `${Math.floor(targetMin/60)}u ${targetMin%60}min`;
  inputTotGepland.textContent = `${Math.floor(totalMin/60)}u ${totalMin%60}min`;
  inputTotVerschil.textContent = `${(diff>=0?'+':'-')}${Math.floor(Math.abs(diff)/60)}u ${Math.abs(diff)%60}min`;
  inputTotVerschil.className = diff>=0 ? 'positive' : 'negative';
}

/* ============================
   Historiek
   ============================ */
function renderHistory(){
  historyBody.innerHTML = '';
  if(!currentUser) return;
  const userData = getCurrentUserData();
  const year = Number(yearSelectMain.value) || new Date().getFullYear();
  historiekJaar.textContent = year;
  // for months 0..11, show rows
  let totDoel=0, totGepland=0, totVerschil=0, totVerlof=0, totZiekte=0, totSchool=0, totFeest=0, totBench=0;
  for(let m=0;m<12;m++){
    const md = userData.monthData && userData.monthData[year] && userData.monthData[year][m] ? userData.monthData[year][m] : {targetHours:0,targetMinutes:0,rows:{}};
    const targetMin = (md.targetHours||0)*60 + (md.targetMinutes||0);
    const rows = md.rows || {};
    const maandGepland = Object.values(rows).reduce((s,r)=> s + (r.minutes||0), 0);
    // count special shifts totals
    let v=0,z=0,sf=0,f=0,b=0;
    Object.values(rows).forEach(r=>{
      if(!r.shift) return;
      if(r.shift === 'Verlof') v += r.minutes || 0;
      if(r.shift === 'Ziekte') z += r.minutes || 0;
      if(r.shift === 'Schoolverlof') sf += r.minutes || 0;
      if(r.shift === 'Feestdag') f += r.minutes || 0;
      if(r.shift === 'Bench') b += r.minutes || 0;
    });
    const diff = maandGepland - targetMin;
    totDoel += targetMin; totGepland += maandGepland; totVerschil += diff;
    totVerlof += v; totZiekte += z; totSchool += sf; totFeest += f; totBench += b;

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${monthsFull[m]}</td>
      <td>${Math.floor(targetMin/60)}u ${targetMin%60}min</td>
      <td>${Math.floor(maandGepland/60)}u ${maandGepland%60}min</td>
      <td class="${diff>=0?'positive':'negative'}">${diff>=0?'+':''}${Math.floor(Math.abs(diff)/60)}u ${Math.abs(diff)%60}min</td>
      <td>${Math.floor(v/60)}u ${v%60}min</td>
      <td>${Math.floor(z/60)}u ${z%60}min</td>
      <td>${Math.floor(sf/60)}u ${sf%60}min</td>
      <td>${Math.floor(f/60)}u ${f%60}min</td>
      <td>${Math.floor(b/60)}u ${b%60}min</td>`;
    historyBody.appendChild(tr);
  }
  document.getElementById('totDoel').textContent = `${Math.floor(totDoel/60)}u ${totDoel%60}min`;
  document.getElementById('totGepland').textContent = `${Math.floor(totGepland/60)}u ${totGepland%60}min`;
  document.getElementById('totVerschil').textContent = `${totVerschil>=0?'+':''}${Math.floor(Math.abs(totVerschil)/60)}u ${Math.abs(totVerschil)%60}min`;
  document.getElementById('totVerschil').className = totVerschil>=0 ? 'positive' : 'negative';
  document.getElementById('totVerlof').textContent = `${Math.floor(totVerlof/60)}u ${totVerlof%60}min`;
  document.getElementById('totZiekte').textContent = `${Math.floor(totZiekte/60)}u ${totZiekte%60}min`;
  document.getElementById('totSchool').textContent = `${Math.floor(totSchool/60)}u ${totSchool%60}min`;
  document.getElementById('totFeest').textContent = `${Math.floor(totFeest/60)}u ${totFeest%60}min`;
  document.getElementById('totBench').textContent = `${Math.floor(totBench/60)}u ${totBench%60}min`;
}

/* ============================
   Helpers: update UI labels
   ============================ */
function updateCurrentUserLabels(){
  const userData = dataStore.users[currentUser];
  let label = currentUser || '-';
if (userData) {
  label = userData.name || userData.email || currentUser;
}

  document.getElementById('currentUserLabel').textContent = label;
  document.getElementById('currentUserInvoer').textContent = label;
  document.getElementById('currentUserHistoriek').textContent = label;
}

/* ============================
   Ensure targets changes saved live
   ============================ */
monthTargetHours.addEventListener('input', ()=>{
  const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
  const ud = getCurrentUserData();
  if(!ud.monthData) ud.monthData = {};
  if(!ud.monthData[y]) ud.monthData[y] = {};
  if(!ud.monthData[y][m]) ud.monthData[y][m] = {targetHours:0,targetMinutes:0,rows:{}};
  ud.monthData[y][m].targetHours = Number(monthTargetHours.value)||0;
  saveAll(); updateInputTotals(); renderHistory();
});
monthTargetMinutes.addEventListener('input', ()=>{
  const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
  const ud = getCurrentUserData();
  if(!ud.monthData) ud.monthData = {};
  if(!ud.monthData[y]) ud.monthData[y] = {};
  if(!ud.monthData[y][m]) ud.monthData[y][m] = {targetHours:0,targetMinutes:0,rows:{}};
  ud.monthData[y][m].targetMinutes = Number(monthTargetMinutes.value)||0;
  saveAll(); updateInputTotals(); renderHistory();
});

/* ============================
   When project filter changes -> re-render current month table (if present)
   ============================ */
projectFilterSelect_el.addEventListener('change', ()=>{
  const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
  const ud = getCurrentUserData();
  if(ud.monthData && ud.monthData[y] && ud.monthData[y][m]){
    renderMonth(y,m);
    updateInputTotals();
  }
});
yearSelectMain.addEventListener('change', ()=>{
  renderProjectFilterForMonth();
  generateMonth();   // automatisch renderen
});
monthSelectMain.addEventListener('change', ()=>{
  renderProjectFilterForMonth();
  generateMonth();   // automatisch renderen
});

/* ============================
   Converter tab — automatisch updaten
   ============================ */
const convHours = document.getElementById('convHours');
const convMinutes = document.getElementById('convMinutes');
const decimalInput = document.getElementById('decimalInput');

// H/M → decimaal
function updateDecimal() {
  const h = Number(convHours.value)||0;
  const m = Number(convMinutes.value)||0;
  const dec = h + (m/60);
  decimalInput.value = dec.toFixed(2);
}

// Decimaal → H/M
function updateHMFromDecimal() {
  const dec = Number(decimalInput.value)||0;
  const h = Math.floor(dec);
  const m = Math.round((dec - h)*60);
  convHours.value = h;
  convMinutes.value = m;
}

// Event listeners → automatisch updaten
convHours.addEventListener('input', updateDecimal);
convMinutes.addEventListener('input', updateDecimal);
decimalInput.addEventListener('input', updateHMFromDecimal);

// Init 1x
updateDecimal();

/* ============================
   Final: expose saveAll for debug (optional)
   ============================ */
window.saveAll = saveAll;
window.getDataStore = ()=>dataStore;

// Uitlog
document.addEventListener("DOMContentLoaded", () => {
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      try {
        await auth.signOut();
        console.log("Uitgelogd!");

        if (!DEBUG) {
          // in productie → naar loginpagina
          window.location.href = "index.html";
        } else {
          // in debug → blijf gewoon op de pagina
          alert("DEBUG: uitgelogd, maar je blijft hier.");
        }

      } catch (err) {
        console.error("Fout bij uitloggen:", err);
        alert("Uitloggen is mislukt. Probeer opnieuw.");
      }
    });
  }
});
</script>
</body>
</html>
