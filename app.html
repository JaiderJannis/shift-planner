<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shift Planner</title>
<!-- ===== Favicons for all devices ===== -->
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="favicon-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="favicon-512x512.png">
<link rel="shortcut icon" href="favicon.ico">

<!-- Apple (iPhone/iPad) -->
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png">
<link rel="apple-touch-icon-precomposed" href="apple-touch-icon-180x180.png">

<!-- Android/Chrome Web App -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">

<!-- Windows -->
<meta name="msapplication-TileImage" content="favicon-192x192.png">
<meta name="msapplication-TileColor" content="#0d6efd">
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root {
      --sp-sidebar-w: 260px;
      --sp-sidebar-w-collapsed: 78px;
    }
    body { background: #f5f7fb; }
    /* Sidebar */
    .sp-sidebar {
      position: fixed; inset: 0 auto 0 0;
      width: var(--sp-sidebar-w); background: #0d6efd; color: #fff;
      padding-top: 64px; transition: width .25s ease, left .25s ease;
      z-index: 1031;
    }
    .sp-sidebar.collapsed { width: var(--sp-sidebar-w-collapsed); }
    .sp-sidebar .nav-link {
      color: #fff; display: flex; align-items: center; gap: 10px; padding: 10px 16px;
      border-radius: .375rem; margin: 2px 10px;
    }
    .sp-sidebar .nav-link.active, .sp-sidebar .nav-link:hover { background: rgba(255,255,255,.18); }
    .sp-sidebar .label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sp-sidebar.collapsed .label { display: none; }

    /* Topbar */
    .sp-topbar { position: fixed; top: 0; left: 0; right: 0; height: 64px; background: #fff; border-bottom: 1px solid #e9edf5; z-index: 1032; }

    /* Main content */
    .sp-main { padding: 86px 20px 24px; margin-left: var(--sp-sidebar-w); transition: margin-left .25s ease; }
    .sp-main.collapsed { margin-left: var(--sp-sidebar-w-collapsed); }

    /* Mobile: sidebar overlay */
    @media (max-width: 768px) {
      .sp-sidebar { left: -100%; }
      .sp-sidebar.show { left: 0; }
      .sp-main, .sp-main.collapsed { margin-left: 0; }
    }

    .table-nowrap td, .table-nowrap th { white-space: nowrap; }
    .text-mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .chip {display:inline-flex;align-items:center;gap:6px;padding:.25rem .5rem;border-radius:999px;background:#eef4ff;color:#0d6efd;font-size:.8rem}
    .chip .dot{width:.5rem;height:.5rem;border-radius:50%;background:#0d6efd}
.drag-handle:hover { color: #0d6efd; transform: scale(1.15); }
.sortable-chosen { background-color: #f0f8ff !important; }
.sortable-ghost { opacity: 0.6; }
#quickTopBtn {
  border-color: #fd7e14 !important;   /* zachter oranje */
  color: #fd7e14 !important;
  transition: all .15s ease;
}

#quickTopBtn:hover {
  background-color: #fd7e14 !important;
  color: #fff !important;
  transform: scale(1.05);
}
@media (max-width: 768px) {
  #exportPdfBtn {
    font-size: 0.9rem;
    padding: 6px 10px;
  }
}
@media (max-width: 768px) {
  #multiDayShiftBtn {
    font-size: 0.9rem;
    padding: 6px 10px;
  }
}
#notifList li.unread {
  font-weight: 600;
}
.sp-topbar .ms-auto {
  margin-left: auto !important;
}
#notifDropdown {
  position: absolute;
  top: 100%;
  right: 0;
  z-index: 1050; /* hoger dan navbar */
  display: none;
}

#notifDropdown.show {
  display: block !important;
}
/* === 🌙 Donkere modus === */
body.dark-mode {
  background-color: #1e1e1e !important;
  color: #eaeaea !important;
}

body.dark-mode .sp-topbar {
  background-color: #2b2b2b !important;
  border-bottom-color: #444 !important;
}

body.dark-mode .sp-sidebar {
  background-color: #111 !important;
}

body.dark-mode .sp-main {
  background-color: #1e1e1e !important;
  color: #eaeaea !important;
}

body.dark-mode .table {
  color: #ddd !important;
}

body.dark-mode .table thead {
  background-color: #333 !important;
  color: #fff !important;
}

body.dark-mode .modal-content {
  background-color: #2b2b2b !important;
  color: #eaeaea !important;
}

body.dark-mode .btn-outline-secondary {
  color: #eaeaea !important;
  border-color: #666 !important;
}
body.dark-mode .alert-info {
  background-color: #2b3e50 !important;
  color: #eaeaea !important;
  border-color: #3d5065 !important;
}
body.dark-mode .alert-success {
  background-color: #244c2c !important;
  color: #a8f0a5 !important;
}
body.dark-mode .alert-warning {
  background-color: #4d3a13 !important;
  color: #ffe7a0 !important;
}
body.dark-mode .alert-danger {
  background-color: #5b1b1b !important;
  color: #ffbdbd !important;
}
/* 🌊 Altijd zwevende resterende uren-balk */
#remainingHoursAlert {
  position: fixed !important;
  bottom: 1rem;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2000;
  width: auto;
  max-width: 90%;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 0.75rem;
  padding: 8px 16px;
  font-size: 0.9rem;
  text-align: center;
  transition: all 0.3s ease-in-out;
  opacity: 0.95; /* subtiel transparant */
}

/* 📱 Mobiel — iets breder */
@media (max-width: 768px){
  #exportPdfBtn,
  #multiDayShiftBtn,
  #submitMonthBtn{
    --bs-btn-padding-y: .375rem;   /* hoogte (≈ 6px) */
    --bs-btn-padding-x: .75rem;    /* breedte */
    --bs-btn-line-height: 1.2;
    font-size: 1rem;
    padding: var(--bs-btn-padding-y) var(--bs-btn-padding-x) !important;
  }
}
/* === 🔄 Loading overlay === */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}
.main-content, .container {
  overflow: visible !important;
}
/* 📱 Op mobiel: knoppen onder elkaar even breed maken */
@media (max-width: 768px) {
  #exportPdfBtn,
  #multiDayShiftBtn,
  #submitMonthBtn{
    display: block;
    width: 100%;
    max-width: 320px;   /* optioneel: begrenst de breedte */
    margin: 0 auto 0.5rem auto;
  }
}
/* 🔶 Dagen met geplande shift */
.flatpickr-day.planned-day {
  background-color: #ffc107 !important; /* geel */
  color: #000 !important;
  border-radius: 50% !important;
  font-weight: 600;
  border: 2px solid #e0a800 !important;
}
.flatpickr-day.selected.planned-day {
  background-color: #ff9800 !important; /* oranje */
  color: white !important;
}
/* ── Maandstatus badges ─────────────────────────────── */
.badge-status { font-weight: 600; }
.badge-draft { background:#e9ecef; color:#495057; }
.badge-submitted { background:#e7f1ff; color:#0d6efd; }
.badge-approved { background:#e6f4ea; color:#1e7e34; }
.badge-rejected { background:#fdecea; color:#842029; }
/* mini actieknoppen in de invoertabel */
.btn-line{
  --bs-btn-padding-y: .15rem;
  --bs-btn-padding-x: .35rem;
  --bs-btn-font-size: .75rem;
  line-height: 1;
}
/* Acties-kolom smal + niet afbreken */
#thActions{ width:1%; white-space:nowrap; }
td.actions-cell{ white-space:nowrap; }  
.btn-success { font-weight: 600; }
.badge.bg-secondary-subtle { background-color: #f1f3f5 !important; color: #495057 !important; }
body.dark-mode .badge.bg-secondary-subtle { background-color: #2e2e2e !important; color: #ddd !important; }
/* Compacte projectkaarten (Invoer) */
#projectSummary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: .5rem;
}

.project-mini {
  background: #fff;
  border: 1px solid #e9edf5;
  border-radius: .5rem;
  padding: .5rem .75rem;          /* klein! */
}

.project-mini .meta { 
  color: #6c757d; 
  font-size: .75rem; 
}
.project-mini .title { 
  font-weight: 600; 
  font-size: .95rem; 
}
.project-mini .value { 
  font-variant-numeric: tabular-nums; 
  font-weight: 700; 
}

/* Donkere modus matchen */
body.dark-mode #projectSummary .project-mini {
  background: #2b2b2b;
  border-color: #444;
  color: #eaeaea;
}
body.dark-mode #projectSummary .meta { color: #aaa; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside id="sidebar" class="sp-sidebar">
    <div class="px-3 mb-3">
  <div class="d-flex align-items-center gap-2 ps-2">
    <span class="material-icons-outlined">event_note</span>
    <a class="label text-white text-decoration-none" data-bs-toggle="tab" href="#tab-home">
      Shift Planner
    </a>
  </div>
</div>
<nav class="nav flex-column" id="navTabs">
  <a class="nav-link active" data-bs-toggle="tab" href="#tab-home">
    <span class="material-icons-outlined">home</span> <span class="label">Home</span>
  </a>
  <a class="nav-link" data-bs-toggle="tab" href="#tab-shifts">
    <span class="material-icons-outlined">schedule</span> <span class="label">Shifts</span>
  </a>
  <a class="nav-link" data-bs-toggle="tab" href="#tab-invoer">
    <span class="material-icons-outlined">list_alt</span> <span class="label">Invoer</span>
  </a>
  <a class="nav-link" data-bs-toggle="tab" href="#tab-historiek">
    <span class="material-icons-outlined">query_stats</span> <span class="label">Historiek</span>
  </a>
  <a class="nav-link" data-bs-toggle="tab" href="#tab-converter">
    <span class="material-icons-outlined">calculate</span> <span class="label">Converter</span>
  </a>
 <a class="nav-link" data-bs-toggle="tab" href="#tab-mail">
  <span class="material-icons-outlined">mail</span>
  <span class="label">Mailbox</span>
  <span id="mailSidebarBadge" class="badge bg-danger ms-1 d-none">0</span>
</a>
  <a class="nav-link d-none" id="adminTabBtn" data-bs-toggle="tab" href="#tab-admin">
    <span class="material-icons-outlined">admin_panel_settings</span> <span class="label">Admin</span>
  </a>
</nav>
  </aside>

  <!-- Topbar -->
  <nav class="sp-topbar">
    <div class="container-fluid h-100 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
  <button id="sidebarToggle" class="btn btn-outline-primary btn-sm d-none d-md-inline-flex">
    <span class="material-icons-outlined">menu_open</span>
  </button>
  <button id="sidebarMobile" class="btn btn-outline-primary btn-sm d-inline-flex d-md-none">
    <span class="material-icons-outlined">menu</span>
  </button>

  <!-- ✅ Nieuw: Snelle invoer-knop -->
  <button id="quickTopBtn" class="btn btn-outline-warning btn-sm d-flex align-items-center gap-1" data-bs-toggle="modal" data-bs-target="#quickModal">
    <span class="material-icons-outlined">event</span> 
    <span class="d-none d-sm-inline">Snelle invoer</span>
  </button>

  <div class="chip d-none d-sm-inline-flex"><span class="dot"></span> <span id="envBadge">Online</span></div>
</div>

<div class="d-flex align-items-center gap-3 ms-auto">
  <span class="text-secondary small">Ingelogd als <strong id="currentUserName">-</strong></span>
    <!-- Dark mode -->
<button id="darkModeBtn" class="btn btn-outline-secondary btn-sm">
  <span class="material-icons-outlined">dark_mode</span>
</button>
  <!-- 🔔 Notificatieknop -->
  <div class="position-relative">
    <button id="notifBtn" class="btn btn-outline-secondary btn-sm position-relative">
      <span class="material-icons-outlined">notifications</span>
      <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
    </button>

    <!-- Dropdown -->
    <div id="notifDropdown" class="dropdown-menu dropdown-menu-end shadow p-2 d-none" style="min-width:300px;">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Meldingen</strong>
        <button id="markAllReadBtn" class="btn btn-link btn-sm text-decoration-none">Alles gelezen</button>
      </div>

      <ul id="notifList" class="list-unstyled mb-2" style="max-height: 300px; overflow-y: auto;"></ul>

      <div class="text-center mt-2">
        <button id="loadMoreNotifBtn" class="btn btn-outline-secondary btn-sm d-none">Toon meer</button>
      </div>
    </div>
  </div>

  <!-- 🚪 Uitloggen -->
  <button id="logoutBtn" class="btn btn-outline-danger btn-sm">
    <span class="material-icons-outlined">logout</span>
  </button>
</div>
    </div>
  </nav>

  <!-- Main -->
  <main id="main" class="sp-main">
    <div class="tab-content">
<!-- HOME -->
<section id="tab-home" class="tab-pane fade show active">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Welkom, <span id="homeUserName">-</span></h5>
    <div class="d-flex flex-wrap gap-2">
      <button id="homeBtnQuickInput" class="btn btn-outline-warning btn-sm">
        <span class="material-icons-outlined">event</span> Snelle invoer
      </button>
      <button id="homeBtnGoInvoer" class="btn btn-outline-primary btn-sm">
        <span class="material-icons-outlined">table_view</span> Naar Invoer
      </button>
      <button id="homeBtnNewShift" class="btn btn-primary btn-sm">
        <span class="material-icons-outlined">add</span> Nieuwe shift
      </button>
    </div>
  </div>

  <!-- Voortgang huidige maand -->
  <div class="card shadow-sm border-0 mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div class="small text-muted">Voortgang — <span id="homeMonthName">-</span></div>
          <div class="fw-semibold">
            Gepland: <span id="homeMonthPlanned">0u 0min</span>
            &nbsp;|&nbsp; Doel: <span id="homeMonthTarget">0u 0min</span>
            &nbsp;|&nbsp; Verschil: <span id="homeMonthDiff">0u 0min</span>
          </div>
        </div>
        <span class="badge bg-secondary-subtle text-dark" id="homeMonthStatus">Concept</span>
      </div>
      <div class="progress" style="height: 10px;">
        <div id="homeMonthProgress" class="progress-bar" role="progressbar"
             style="width:0%;" aria-valuemin="0" aria-valuemax="100">
          <span class="visually-hidden" id="homeMonthProgressLabel">0%</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Verlof badges -->
  <div class="mb-3">
    <span class="badge bg-secondary-subtle text-dark me-2" id="homeLeave">Verlof: —</span>
    <span class="badge bg-secondary-subtle text-dark" id="homeSchoolLeave">Schoolverlof: —</span>
  </div>

  <div class="row g-3">
    <!-- Actieve projecten -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Actieve projecten (vandaag)</h6>
          </div>
          <div class="row g-2" id="homeProjects"></div>
        </div>
      </div>
    </div>

    <!-- Laatste meldingen -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Laatste meldingen</h6>
            <span class="text-muted small">(max. 5)</span>
          </div>
          <ul class="mb-0" id="homeNotifList"></ul>
        </div>
      </div>
    </div>
  </div>
</section>
      <!-- SHIFTS -->
      <section id="tab-shifts" class="tab-pane fade">
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Shifts</h5>
          <div class="d-flex flex-wrap gap-2">
            <select id="filterShiftYear" class="form-select form-select-sm"></select>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#shiftModal">
              <span class="material-icons-outlined">add</span> Nieuwe shift
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle table-nowrap">
            <thead class="table-light">
              <tr>
                <th>Naam</th><th>Start</th><th>Einde</th><th>Pauze (min)</th><th>Project</th><th>Periode</th><th class="text-end">Acties</th>
              </tr>
            </thead>
            <tbody id="shiftTableBody"></tbody>
          </table>
        </div>

        <div class="alert alert-info small">
          Tip: je kan de volgorde bewaren via de “volgorde opslaan”-knop (drag & drop is browser-afhankelijk in tabellen; alternatief: gebruik sorteerknoppen).
        </div>
      </section>

      <!-- INVOER -->
      <section id="tab-invoer" class="tab-pane fade">
       <!-- Invoer-toolbar -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="row g-2 align-items-center mb-3 w-100">
    <!-- 📅 Selects -->
    <div class="col-12 col-md-auto d-flex flex-wrap gap-2">
      <select id="monthSelectMain" class="form-select form-select-sm w-auto flex-fill flex-md-grow-0">
        <option value="0">Januari</option><option value="1">Februari</option><option value="2">Maart</option>
        <option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option>
        <option value="6">Juli</option><option value="7">Augustus</option><option value="8">September</option>
        <option value="9">Oktober</option><option value="10">November</option><option value="11">December</option>
      </select>

      <select id="yearSelectMain" class="form-select form-select-sm w-auto flex-fill flex-md-grow-0"></select>
      <select id="projectFilterSelect" class="form-select form-select-sm w-auto flex-fill flex-md-grow-0">
        <option value="">Alle projecten</option>
      </select>
    </div>

    <!-- ✅ Concept-badge: op mobiel BOVEN Export -->
    <div class="col-12 col-md-auto mt-2 mt-md-0 order-1 order-md-0">
      <span id="monthStatusBadge" class="badge badge-status badge-draft">Concept</span>
      <span id="leaveBalanceBadge" class="badge bg-secondary-subtle text-dark ms-2">Verlof saldo: — (stel in)</span>
      <span id="schoolLeaveBalanceBadge" class="badge bg-secondary-subtle text-dark ms-2">Schoolverlof saldo: — (stel in)</span>
    </div>

    <!-- Export PDF -->
    <div class="col-12 col-md-auto mt-2 mt-md-0 order-2 order-md-0">
      <button id="exportPdfBtn" class="btn btn-outline-danger btn-sm w-100 w-md-auto">
        Export PDF
      </button>
    </div>

    <!-- Invoer meerdere dagen -->
    <div class="col-12 col-md-auto mt-2 mt-md-0 order-3 order-md-0">
      <button id="multiDayShiftBtn" class="btn btn-outline-primary btn-sm w-100 w-md-auto">
        Invoer meerdere dagen
      </button>
    </div>

    <!-- ✅ Indienen: op mobiel ONDER “Invoer meerdere dagen” -->
    <div class="col-12 col-md-auto mt-2 mt-md-0 order-3 order-md-0">
      <button id="submitMonthBtn" class="btn btn-outline-success btn-sm w-100 w-md-auto">
        Indienen
      </button>
    </div>
  </div>
<!-- 🎯 Sticky resterende uren-balk -->
<div id="remainingHoursAlert" class="alert small d-none mb-3"></div>
</div>
        <div class="row g-3 mb-3">
          <div class="col-6 col-md-2">
            <label class="form-label">Doel uren</label>
            <input id="monthTargetHours" type="number" min="0" value="0" class="form-control form-control-sm" />
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">Doel min</label>
            <input id="monthTargetMinutes" type="number" min="0" value="0" class="form-control form-control-sm" />
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle table-nowrap">
            <thead class="table-light">
  <tr>
    <th id="thActions">Acties</th>
    <th>Dag</th><th>Datum</th><th>Project</th><th>Shift</th><th>Start</th><th>Einde</th><th>Pauze</th><th>Omschrijving</th><th>Duur</th>
  </tr>
</thead>
            <tbody id="tbody"></tbody>
        </div>
          </table>
     <!-- Project-samenvatting kaarten (zichtbare maand) -->
<div id="projectSummary" class="mt-3"></div>
        <div class="row g-3 mt-2">
        </div>
      </section>

      <!-- HISTORIEK -->
      <section id="tab-historiek" class="tab-pane fade">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Historiek — <span id="currentUserHistoriek">-</span> — Jaar: <span id="historiekJaar"></span></h5>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle table-nowrap">
            <thead class="table-light">
              <tr>
                <th>Maand</th><th>Doel uren</th><th>Gepland</th><th>Verschil</th>
                <th>Verlof</th><th>Ziekte</th><th>Schoolverlof</th><th>Feestdag</th><th>Bench</th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
            <tfoot class="table-light">
              <tr>
                <th>Totaal</th>
                <th id="totDoel">0u 0min</th>
                <th id="totGepland">0u 0min</th>
                <th id="totVerschil">0u 0min</th>
                <th id="totVerlof">0u 0min</th>
                <th id="totZiekte">0u 0min</th>
                <th id="totSchool">0u 0min</th>
                <th id="totFeest">0u 0min</th>
                <th id="totBench">0u 0min</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <!-- CONVERTER -->
      <section id="tab-converter" class="tab-pane fade">
        <h5>Uren/minuten ↔ decimale uren</h5>
        <div class="row g-3">
          <div class="col-6 col-md-2">
            <label class="form-label">Uren</label>
            <input id="convHours" type="number" min="0" value="0" class="form-control" />
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">Minuten</label>
            <input id="convMinutes" type="number" min="0" value="0" class="form-control" />
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Decimale uren</label>
            <input id="decimalInput" type="number" step="0.01" min="0" value="0" class="form-control" />
          </div>
        </div>
      </section>
<section id="tab-mail" class="tab-pane fade">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Mailbox</h5>
    <div class="d-flex gap-2">
      <button id="mailRefreshBtn" class="btn btn-outline-secondary btn-sm" type="button" title="Vernieuwen">
        <span class="material-icons-outlined">refresh</span>
      </button>
      <button id="mailComposeBtn" class="btn btn-primary btn-sm" type="button">
        <span class="material-icons-outlined">edit</span> Nieuw bericht
      </button>
    </div>
  </div>

  <!-- Folders -->
  <ul class="nav nav-pills mb-2" id="mailFolderNav" role="tablist" style="gap:.5rem;">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-folder="inbox" type="button">Inbox <span id="mailUnreadBadge" class="badge bg-danger ms-1 d-none">0</span></button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-folder="sent" type="button">Verzonden</button>
    </li>
  </ul>

  <!-- Compose -->
  <div id="mailComposeCard" class="card p-3 mb-3 d-none">
    <div class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Aan</label>
        <select id="mailToSelect" class="form-select"></select>
      </div>
      <div class="col-md-8">
        <label class="form-label">Onderwerp</label>
        <input id="mailSubjectInput" class="form-control" placeholder="Onderwerp">
      </div>
      <div class="col-12">
        <label class="form-label">Bericht</label>
        <textarea id="mailBodyInput" rows="5" class="form-control" placeholder="Typ je bericht..."></textarea>
      </div>
      <div class="col-12 d-flex gap-2">
        <button id="mailSendBtn" class="btn btn-success" type="button">Versturen</button>
        <button id="mailCancelBtn" class="btn btn-outline-secondary" type="button">Annuleren</button>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Lijst -->
    <div class="col-12 col-lg-5">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Berichten</h6>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Van</th>
                  <th>Onderwerp</th>
                  <th class="text-end">Datum</th>
                  <th class="text-end">Acties</th>
                </tr>
              </thead>
              <tbody id="mailListBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Detail -->
    <div class="col-12 col-lg-7">
      <div class="card border-0 shadow-sm">
        <div class="card-body" id="mailDetail">
          <div class="text-muted small">Selecteer een bericht…</div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- ADMIN -->
<section id="tab-admin" class="tab-pane fade">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h5 class="mb-0">Admin beheer</h5>
    <div class="text-secondary small">
      Actief: <strong id="activeUserLabel">-</strong>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <h6 class="mb-3">Gebruikersbeheer</h6>
    <div class="row g-2 align-items-end">
      <div class="col-md-6">
        <label class="form-label">Gebruiker selecteren</label>
        <select id="adminUserSelect" class="form-select"></select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Rol</label>
        <select id="roleSelect" class="form-select">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="col-md-6 d-flex gap-2">
        <button id="updateRoleBtn" class="btn btn-warning flex-fill">Rol opslaan</button>
        <button id="removeUserBtn" class="btn btn-danger flex-fill">Verwijder</button>
        <button id="saveSettingsBtn"class="btn btn-outline-secondary flex-fill">Schoolverlof uitschakelen</button>
      </div>
    </div>
  </div>
  <div class="card p-3 mb-3">
  <h6 class="mb-3">Schoolverlof zichtbaarheid</h6>
  <div class="form-check form-switch">
    <input id="adminSchoolLeaveEnabled" class="form-check-input" type="checkbox">
    <label class="form-check-label" for="adminSchoolLeaveEnabled">
      Schoolverlof tonen voor geselecteerde gebruiker
    </label>
  </div>
  <small class="text-muted">Als uitgeschakeld: schoolverlof badge, invoeroptie en historiek worden verborgen.</small>
</div>
  <div class="card p-3 mb-3">
    <h6 class="mb-3">Projectbeheer</h6>
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Projectnaam</label>
        <input id="newProjectName" class="form-control" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Startdatum</label>
        <input id="newProjectStart" type="date" class="form-control" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Einddatum</label>
        <input id="newProjectEnd" type="date" class="form-control" />
      </div>
      <div class="col-md-2">
        <button id="addProjectBtn" class="btn btn-success w-100">Toevoegen</button>
      </div>
    </div>

    <div class="table-responsive mt-3">
      <table class="table table-striped align-middle table-nowrap">
        <thead class="table-light">
          <tr><th>Project</th><th>Start</th><th>Eind</th><th>Acties</th></tr>
        </thead>
        <tbody id="projectTableBody"></tbody>
      </table>
    </div>
  </div>
<div class="card p-3 mb-3">
  <h6 class="mb-3">Verlof & Schoolverlof – jaarlijkse toekenning</h6>
<div class="row g-3 align-items-end">
  <!-- Kalendervoorjaar (ongewijzigd) -->
  <div class="col-md-4">
    <label class="form-label">Verlof (uren per kalenderjaar)</label>
    <input id="adminLeaveHours" type="number" min="0" step="1" class="form-control" placeholder="bv. 160">
  </div>

  <!-- Schooljaar-select + uren -->
  <div class="col-md-4">
    <label class="form-label">Schooljaar</label>
    <select id="adminSchoolYearSelect" class="form-select"></select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Schoolverlof (uren voor dit schooljaar)</label>
    <input id="adminSchoolLeaveHours" type="number" min="0" step="1" class="form-control" placeholder="bv. 40">
  </div>
</div>

<div class="row g-2 mt-3">
  <div class="col-md-6 d-flex gap-2">
    <button id="adminSaveLeaveBtn" class="btn btn-primary flex-fill">Opslaan kalenderjaar-verlof</button>
    <button id="adminResetLeaveBtn" class="btn btn-outline-secondary flex-fill">Leegmaken</button>
  </div>
  <div class="col-md-6 d-flex gap-2">
    <button id="adminSaveSchoolLeaveBtn" class="btn btn-success flex-fill">Opslaan schoolverlof (gekozen jaar)</button>
    <button id="adminResetSchoolLeaveBtn" class="btn btn-outline-secondary flex-fill">Leegmaken schoolverlof (gekozen jaar)</button>
  </div>
</div>

<small class="text-muted d-block mt-2">
  Verlof = kalenderjaar. Schoolverlof = per schooljaar (1 september – 31 augustus).
</small>
</div>
  <div class="card p-3 mb-3">
  <h6 class="mb-3">Goedkeuring maand</h6>
  <div class="row g-2 align-items-end">
    <div class="col-md-3">
      <label class="form-label">Maand</label>
      <select id="adminApproveMonth" class="form-select">
        <option value="0">Januari</option><option value="1">Februari</option><option value="2">Maart</option>
        <option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option>
        <option value="6">Juli</option><option value="7">Augustus</option><option value="8">September</option>
        <option value="9">Oktober</option><option value="10">November</option><option value="11">December</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Jaar</label>
      <input id="adminApproveYear" type="number" class="form-control" min="2000" step="1">
    </div>
    <div class="col-md-6 d-flex gap-2">
      <button id="adminApproveBtn" class="btn btn-success flex-fill">Keur goed</button>
      <button id="adminRejectBtn" class="btn btn-danger flex-fill">Keur af</button>
      <button id="adminReopenBtn" class="btn btn-outline-secondary flex-fill">Heropenen</button>
    </div>
  </div>
  <small class="text-muted d-block mt-2">Kies bovenaan in “Gebruikersbeheer” eerst de gebruiker.</small>
</div>
<div class="card p-3 mb-3" id="adminMultiMonthlyCard">
  <h6 class="mb-3">Extra lijnen per maand (per gebruiker)</h6>
  <p class="text-muted mb-2">
    Selecteer bovenaan een gebruiker. Zet aan om in de gekozen maand extra shiften (onderbrekingen) toe te staan.
  </p>
  <div class="row g-2 align-items-end">
    <div class="col-md-3">
      <label class="form-label">Maand</label>
      <select id="adminMultiMonth" class="form-select">
        <option value="0">Januari</option><option value="1">Februari</option><option value="2">Maart</option>
        <option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option>
        <option value="6">Juli</option><option value="7">Augustus</option><option value="8">September</option>
        <option value="9">Oktober</option><option value="10">November</option><option value="11">December</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Jaar</label>
      <input id="adminMultiYear" type="number" class="form-control" min="2000" step="1">
    </div>
    <div class="col-md-6">
      <div class="form-check form-switch mt-4">
        <input id="adminMultiAllow" class="form-check-input" type="checkbox">
        <label class="form-check-label" for="adminMultiAllow">
          Sta extra lijnen toe in deze maand (voor deze gebruiker)
        </label>
      </div>
    </div>
  </div>
</div>
</section>

    </div>
  </main>

  <!-- MODALS -->
  <!-- Shift modal -->
  <div class="modal fade" id="shiftModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nieuwe / bewerk shift</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-md-6"><label class="form-label">Naam</label><input id="newShiftName" class="form-control" /></div>
            <div class="col-6 col-md-3"><label class="form-label">Start</label><input id="newShiftStart" type="time" value="08:00" class="form-control" /></div>
            <div class="col-6 col-md-3"><label class="form-label">Einde</label><input id="newShiftEnd" type="time" value="16:00" class="form-control" /></div>
            <div class="col-6 col-md-3"><label class="form-label">Pauze (min)</label><input id="newShiftBreak" type="number" min="0" value="0" class="form-control" /></div>
            <div class="col-6 col-md-5"><label class="form-label">Project</label><select id="newShiftProjectSelect" class="form-select"><option value="">Geen project</option></select></div>
            <div class="col-6 col-md-4"><label class="form-label">Vanaf</label><input id="newShiftStartDate" type="date" class="form-control" /></div>
            <div class="col-6 col-md-4"><label class="form-label">Tot</label><input id="newShiftEndDate" type="date" class="form-control" /></div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="addShiftBtn" class="btn btn-primary">Opslaan</button>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick input modal -->
  <div class="modal fade" id="quickModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Snelle invoer</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Datum</label>
              <input type="date" id="quickDate" class="form-control" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Shift</label>
              <select id="quickShift" class="form-select"></select>
            </div>
            <div class="col-12">
              <label class="form-label">Omschrijving (optioneel)</label>
              <input type="text" id="quickNote" class="form-control" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="saveQuickBtn" class="btn btn-success">Opslaan</button>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Sluiten</button>
        </div>
      </div>
    </div>
  </div>
<!-- Meerdere dagen invoeren Modal -->
<div class="modal fade" id="multiDayModal" tabindex="-1"
     aria-labelledby="multiDayModalLabel" aria-hidden="true"
     data-bs-scroll="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="multiDayModalLabel">Meerdere dagen invoeren</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Sluiten"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="multiShiftDays" class="form-label">Selecteer dagen</label>
          <input id="multiShiftDays" type="text" class="form-control" placeholder="Klik om dagen te kiezen">
        </div>

        <div class="mb-3">
          <label for="multiShiftName" class="form-label">Shift</label>
          <select id="multiShiftName" class="form-select">
            <option value="">Kies shift</option>
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuleren</button>
        <button type="button" id="saveMultiShift" class="btn btn-primary">Opslaan</button>
      </div>
    </div>
  </div>
</div>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- JSPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <!-- ✅ SortableJS voor drag & drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Flatpickr NL taal -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/nl.js"></script>
  <!-- Firebase (Modular CDN) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
   import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  getDocs,
  addDoc,
  deleteDoc,
  collection,
  query,
  orderBy,
  limit,
  onSnapshot,
  where,
  startAfter,
  serverTimestamp 
} from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    // ===== Firebase config (jouw bestaande waarden) =====
    const firebaseConfig = {
      apiKey: "AIzaSyB8uHwRXCe1iV7z6T80YPxEbeB64qdMpNY",
      authDomain: "shift-planner-dc7ad.firebaseapp.com",
      projectId: "shift-planner-dc7ad",
      storageBucket: "shift-planner-dc7ad.firebasestorage.app",
      messagingSenderId: "719441527396",
      appId: "1:719441527396:web:de87d6f950fe23702a5571"
    };

    // ===== App init =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ======= State =======
    let currentUserId = null;
    const dataStore = { users: {}, currentUser: null };

    // ======= Elements =======
    const sidebar = document.getElementById('sidebar');
    const main = document.getElementById('main');
    const logoutBtn = document.getElementById('logoutBtn');
    const currentUserName = document.getElementById('currentUserName');
    const adminTabBtn = document.getElementById('adminTabBtn');

// activeer bij login / gebruikerswissel
document.querySelector('a[href="#tab-mail"]')?.addEventListener('shown.bs.tab', () => {
  const uid = getActiveUserId();
  if (uid) listenMailbox(uid);
});

    // Tabs: Shifts
    const filterShiftYear = document.getElementById('filterShiftYear');
    const shiftTableBody = document.getElementById('shiftTableBody');

    // Invoer elements
    const monthSelectMain = document.getElementById('monthSelectMain');
    const yearSelectMain = document.getElementById('yearSelectMain');
    const projectFilterSelect = document.getElementById('projectFilterSelect');
    const monthTargetHours = document.getElementById('monthTargetHours');
    const monthTargetMinutes = document.getElementById('monthTargetMinutes');
    const tbody = document.getElementById('tbody');

    // Historiek
    const historyBody = document.getElementById('historyBody');
    const historiekJaar = document.getElementById('historiekJaar');
    const currentUserHistoriek = document.getElementById('currentUserHistoriek');

    // Admin
    const adminUserSelect = document.getElementById('adminUserSelect');
    const roleSelect = document.getElementById('roleSelect');
    const addUserBtn = document.getElementById('addUserBtn');
    const updateRoleBtn = document.getElementById('updateRoleBtn');
    const removeUserBtn = document.getElementById('removeUserBtn');
    const activeUserLabel = document.getElementById('activeUserLabel');
    const projectTableBody = document.getElementById('projectTableBody');
    const newProjectName = document.getElementById('newProjectName');
    const newProjectStart = document.getElementById('newProjectStart');
    const newProjectEnd = document.getElementById('newProjectEnd');
    const addProjectBtn = document.getElementById('addProjectBtn');
    const auditLog = document.getElementById('auditLog');

    // Shift modal fields
    const newShiftName = document.getElementById('newShiftName');
    const newShiftStart = document.getElementById('newShiftStart');
    const newShiftEnd = document.getElementById('newShiftEnd');
    const newShiftBreak = document.getElementById('newShiftBreak');
    const newShiftProjectSelect = document.getElementById('newShiftProjectSelect');
    const newShiftStartDate = document.getElementById('newShiftStartDate');
    const newShiftEndDate = document.getElementById('newShiftEndDate');
    const addShiftBtn = document.getElementById('addShiftBtn');

    // Quick input
    const quickDate = document.getElementById('quickDate');
    const quickShift = document.getElementById('quickShift');
    const quickNote = document.getElementById('quickNote');
    const saveQuickBtn = document.getElementById('saveQuickBtn');
// --- helpers: mapping & automatische projecttoewijzing ---
const SPECIAL_PROJECT_MAP = {
  'Verlof': 'Eght Care',
  'Ziekte': 'Eght Care',
  'Teammeeting': 'Eght Care',
  'School': 'PXL Verpleegkunde Hasselt',
  'Schoolverlof': 'PXL Verpleegkunde Hasselt'
};
function isValidProject(name) {
  const ud = getCurrentUserData();
  return !!(ud.projects || []).find(p => p.name === name);
}
function autoProjectForShift(shiftName){
  return SPECIAL_PROJECT_MAP[shiftName] || null;
}
    // ======= UI helpers =======
    const daysFull = ["Zondag","Maandag","Dinsdag","Woensdag","Donderdag","Vrijdag","Zaterdag"];
    const monthsFull = ["Januari","Februari","Maart","April","Mei","Juni","Juli","Augustus","September","Oktober","November","December"];
    const toast = (msg, type='primary') => {
      const el = document.createElement('div');
      el.className = `toast align-items-center text-bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
      el.role = 'alert'; el.ariaLive='assertive'; el.ariaAtomic='true';
      el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      document.body.appendChild(el);
      new bootstrap.Toast(el, { delay: 2500 }).show();
      el.addEventListener('hidden.bs.toast', ()=> el.remove());
    };

    const dateKey = (y,m,d)=> `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const toDisplayDate = iso => !iso ? '-' : iso.split('-').reverse().join('-');
    const fromDisplayDate = disp => {const [d,m,y]=disp.split('-'); return `${y}-${m}-${d}`;};
    const minutesBetween = (s,e,b)=> {
      if(!s||!e) return 0;
      const [sh,sm]=s.split(':').map(Number), [eh,em]=e.split(':').map(Number);
      let mins = (eh*60+em) - (sh*60+sm) - (Number(b)||0);
      if(mins<0) mins+=1440;
      return mins;
    };
    const isDateWithin = (iso, start, end) => {
      const d = iso?.replaceAll('-',''); if(!d) return false;
      const s = start? start.replaceAll('-',''): null;
      const e = end? end.replaceAll('-',''): null;
      if(s && d < s) return false; if(e && d > e) return false; return true;
    };
// ===== per gebruiker per maand =====
function ensureUserMonthlyMap(ud){
  ud.settings ||= {};
  ud.settings.multiByMonth ||= {}; // { 'YYYY-MM': true }
  return ud.settings.multiByMonth;
}
function userAllowsMultiMonth(ud, year, month){ // month: 0..11
  const key = `${year}-${String(month+1).padStart(2,'0')}`;
  return !!(ud.settings?.multiByMonth?.[key]);
}
function canAddMultiForProject(projectName) {
  const ud = getCurrentUserData();
  if (!projectName) return false;
  const p = (ud.projects || []).find(px => px.name === projectName);
  return !!p?.allowMulti;
}
function listDayKeys(md, baseKey) {
  const rows = md?.rows || {};
  return Object.keys(rows)
    .filter(k => k === baseKey || k.startsWith(baseKey + '#'))
    .sort((a, b) => a.localeCompare(b, 'nl'));
}
function nextLineIndex(md, baseKey) {
  const keys = listDayKeys(md, baseKey);
  let n = 2;
  while (keys.includes(`${baseKey}#${n}`)) n++;
  return n;
}
// ===== HOME DASHBOARD =====
function fmt(mins){ return `${Math.floor(mins/60)}u ${mins%60}min`; }

async function loadHomeNotifications() {
  try {
    if (!currentUserId) return;
    const listEl = document.getElementById('homeNotifList');
    if (!listEl) return;
    const colRef = collection(db, 'users', currentUserId, 'notifications');
    const qy = query(colRef, orderBy('timestamp','desc'), limit(5));
    const snap = await getDocs(qy);

    listEl.innerHTML = '';
    if (snap.empty) {
      listEl.innerHTML = '<li class="text-muted small">Geen meldingen.</li>';
      return;
    }
    snap.forEach(d => {
      const n = d.data();
      const when = n.timestamp ? new Date(n.timestamp).toLocaleString('nl-BE') : '';
      listEl.insertAdjacentHTML('beforeend',
        `<li class="small mb-1">${n.text}<br><span class="text-muted">${when}</span></li>`);
    });
  } catch(e){ console.error(e); }
}

function renderHome() {
  const ud = getCurrentUserData();
  const name = ud.name || ud.email || '-';
  const y = Number(yearSelectMain.value);
  const m = Number(monthSelectMain.value);
  const md = ud.monthData?.[y]?.[m] || { rows:{}, targetHours:0, targetMinutes:0 };

  // header
  const userEl = document.getElementById('homeUserName');
  if (userEl) userEl.textContent = name;
  const monthNameEl = document.getElementById('homeMonthName');
  if (monthNameEl) monthNameEl.textContent = `${monthsFull[m]} ${y}`;

  // totals
  const planned = Object.values(md.rows||{}).reduce((s,r)=> s + (Number(r.minutes)||0), 0);
  const target  = (Number(md.targetHours)||0)*60 + (Number(md.targetMinutes)||0);
  const diff    = planned - target;
  const pct     = target > 0 ? Math.min(100, Math.round(planned/target*100)) : 0;

  const elP = document.getElementById('homeMonthPlanned');
  const elT = document.getElementById('homeMonthTarget');
  const elD = document.getElementById('homeMonthDiff');
  if (elP) elP.textContent = fmt(planned);
  if (elT) elT.textContent = fmt(target);
  if (elD) elD.textContent = `${diff>=0?'+':''}${fmt(Math.abs(diff))}`;

  const bar = document.getElementById('homeMonthProgress');
  const barLbl = document.getElementById('homeMonthProgressLabel');
  if (bar) {
    bar.style.width = `${pct}%`;
    bar.setAttribute('aria-valuenow', String(pct));
    bar.classList.remove('bg-success','bg-warning');
    bar.classList.add(planned >= target && target>0 ? 'bg-success' : 'bg-warning');
    if (barLbl) barLbl.textContent = `${pct}%`;
  }

  // status badge
  const st = document.getElementById('homeMonthStatus');
  if (st) {
    const status = getMonthStatus(y, m);
    st.textContent =
      status==='draft'     ? 'Concept' :
      status==='submitted' ? 'Ingediend' :
      status==='approved'  ? 'Goedgekeurd' : 'Afgekeurd';
    st.className = 'badge';
    st.classList.add(
      status==='approved'  ? 'bg-success' :
      status==='submitted' ? 'bg-primary' :
      status==='rejected'  ? 'bg-danger' : 'bg-secondary-subtle','text-dark'
    );
  }

  // verlof chips
  const leaveAllow = getLeaveAllowanceMinutes();
  const leaveTaken = sumTakenMinutesFor(y, LEAVE_SHIFT_NAMES);
  const leaveRemain = leaveAllow - leaveTaken;
  const leaveEl = document.getElementById('homeLeave');
  if (leaveEl) {
    leaveEl.textContent = !leaveAllow
  ? 'Verlof: niet ingesteld'
  : (leaveRemain >= 0
      ? `Verlof: ${fmt(leaveRemain)} over`
      : `Verlof: -${fmt(Math.abs(leaveRemain))} overschreden`);
    leaveEl.className = `badge ${leaveRemain<0 ? 'bg-danger' : (leaveAllow? 'bg-success':'bg-secondary-subtle text-dark')}`;
  }

const schAllow = getSchoolLeaveAllowanceMinutes(y, m);
const { startISO, endISO, label } = getAcademicYearBounds(y, m);
const schTaken = sumTakenMinutesForRange(startISO, endISO, SCHOOL_LEAVE_SHIFT_NAMES);
const schRemain = schAllow - schTaken;

const schEl = document.getElementById('homeSchoolLeave');
if (schEl) {
  if (!schAllow) {
    schEl.textContent = 'Schoolverlof: niet ingesteld — ' + label;
    schEl.className = 'badge bg-secondary-subtle text-dark';
  } else {
    schEl.textContent = schRemain >= 0
      ? `Schoolverlof: ${fmt(schRemain)} over — ${label}`
      : `Schoolverlof: -${fmt(Math.abs(schRemain))} overschreden — ${label}`;
    schEl.className = `badge ${schRemain < 0 ? 'bg-danger' : (schRemain === 0 ? 'bg-warning text-dark' : 'bg-success')}`;
  }
}

  // actieve projecten (vandaag)
  const todayISO = new Date().toISOString().slice(0,10);
  const projWrap = document.getElementById('homeProjects');
  if (projWrap) {
    const list = (ud.projects||[]).filter(p => isDateWithin(todayISO, p.start||null, p.end||null));
    if (!list.length) {
      projWrap.innerHTML = '<div class="text-muted small">Geen actieve projecten vandaag.</div>';
    } else {
      projWrap.innerHTML = list.map(p => `
        <div class="col-12 col-sm-6 col-md-4">
          <div class="border rounded p-2 h-100">
            <div class="fw-semibold">${p.name}</div>
            <div class="text-muted small">${toDisplayDate(p.start)} – ${toDisplayDate(p.end)}</div>
          </div>
        </div>`).join('');
    }
  }

  // laatste meldingen
  loadHomeNotifications();
}

// Snelkoppelingen op Home
document.getElementById('homeBtnQuickInput')?.addEventListener('click', () => {
  new bootstrap.Modal(document.getElementById('quickModal')).show();
});
document.getElementById('homeBtnNewShift')?.addEventListener('click', () => {
  new bootstrap.Modal(document.getElementById('shiftModal')).show();
});
document.getElementById('homeBtnGoInvoer')?.addEventListener('click', () => {
  const a = document.querySelector('a[href="#tab-invoer"]');
  if (a) new bootstrap.Tab(a).show();
});
// ======= Maandstatus helpers (global) =======
// status: 'draft' | 'submitted' | 'approved' | 'rejected'
function getMonthStatus(y, m){
  const ud = getCurrentUserData();
  return ud.monthData?.[y]?.[m]?.status || 'draft';
}

async function setMonthStatus(y, m, status){
  const ud = getCurrentUserData();
  ud.monthData ||= {};
  ud.monthData[y] ||= {};
  ud.monthData[y][m] ||= { targetHours:0, targetMinutes:0, rows:{} };
  ud.monthData[y][m].status = status;
  await saveUserData();
  updateMonthStatusBadge();
}

function updateMonthStatusBadge(){
  const y = Number(yearSelectMain.value);
  const m = Number(monthSelectMain.value);
  const status = getMonthStatus(y,m);
  const badge = document.getElementById('monthStatusBadge');
  const submitBtn = document.getElementById('submitMonthBtn');
  if (!badge) return;

  badge.className = 'badge badge-status';
  if (status==='draft'){ badge.classList.add('badge-draft'); badge.textContent='Concept'; }
  if (status==='submitted'){ badge.classList.add('badge-submitted'); badge.textContent='Ingediend'; }
  if (status==='approved'){ badge.classList.add('badge-approved'); badge.textContent='Goedgekeurd'; }
  if (status==='rejected'){ badge.classList.add('badge-rejected'); badge.textContent='Afgekeurd'; }

  const hide = (status==='submitted' || status==='approved');
  if (submitBtn){
    submitBtn.classList.toggle('d-none', hide);
    submitBtn.disabled = hide;
  }

  if (multiDayShiftBtn){
    multiDayShiftBtn.classList.toggle('d-none', hide);  // ✅ “Invoer meerdere dagen” ook verbergen
    multiDayShiftBtn.disabled = hide;
  }
}
    // ======= Auth =======
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        // Voor demo: toon eenvoudige melding
        currentUserName.textContent = 'Niet ingelogd';
        toast('Geen gebruiker ingelogd. Redirect naar login…', 'warning');
        // Je kan hier een loginpagina openen of FirebaseUI integreren.
        return;
      }
      currentUserId = user.uid;
      currentUserName.textContent = user.displayName || user.email;

      await ensureUserDoc(user);
      await loadAllUsers();
      initSelectors();
      renderAll();
      await revealAdminIfNeeded();
      updateMonthStatusBadge();
// ✅ Automatische meldingen uitvoeren
await autoCheckNotifications();
  updateLeaveBadges();
  renderHome();
});

    logoutBtn?.addEventListener('click', async ()=>{
  await signOut(auth);
  window.location.href = 'index.html'; // 👈 redirect in plaats van reload
});

    async function ensureUserDoc(user){
      const ref = doc(db, 'users', user.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, { email: user.email, name: user.displayName || user.email.split('@')[0], role:'user', shifts:{}, monthData:{}, projects:[], shiftOrder:[] });
      } else {
        const data = snap.data(), updates={};
        if(!('email' in data)) updates.email = user.email;
        if(!('name' in data)) updates.name = user.displayName || user.email.split('@')[0];
        if(!('role' in data)) updates.role = 'user';
        if(!('shifts' in data)) updates.shifts = {};
        if(!('monthData' in data)) updates.monthData = {};
        if(!('projects' in data)) updates.projects = [];
        if(!('shiftOrder' in data)) updates.shiftOrder = [];
        if(Object.keys(updates).length) await updateDoc(ref, updates);
      }
    }
function getActiveUserId() {
  return dataStore.viewUserId || dataStore.currentUser;
}
    // ======= Data loading/saving =======
    async function loadAllUsers(){
      const meRef = doc(db,'users', currentUserId);
      const meSnap = await getDoc(meRef);
      const me = meSnap.data();
      dataStore.users = {};
      if(me.role === 'admin'){
        const qs = await getDocs(collection(db,'users'));
        qs.forEach(d=> dataStore.users[d.id] = d.data());
      } else {
        dataStore.users[currentUserId] = me;
      }
      dataStore.currentUser = currentUserId;
    }

async function saveUserData(){
  const id = getActiveUserId();
  if (!id) return;
  const ref = doc(db,'users', id);
  await setDoc(ref, dataStore.users[id], { merge: true });
}

   function getCurrentUserData() {
  const id = getActiveUserId();
  if (!id) return { shifts:{}, monthData:{}, projects:[], shiftOrder:[] };
  if (!dataStore.users[id]) dataStore.users[id] = { shifts:{}, monthData:{}, projects:[], shiftOrder:[] };
  return dataStore.users[id];
}

    // ======= UI init =======
function initSelectors(){
  // years
  const yNow = new Date().getFullYear();
  yearSelectMain.innerHTML = '';
  for (let y = yNow - 2; y <= yNow + 3; y++) {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    if (y === yNow) opt.selected = true;
    yearSelectMain.appendChild(opt);
  }

  // ⇩ huidige maand selecteren (0..11)
  const mNow = new Date().getMonth();
  monthSelectMain.value = String(mNow);
}
    async function revealAdminIfNeeded(){
      const meSnap = await getDoc(doc(db,'users', currentUserId));
      const role = meSnap.data().role;
      if(role === 'admin'){ adminTabBtn.classList.remove('d-none'); }
      renderAdminMonthlyMulti();
    }

    // ======= Projects =======
    function renderProjects(){
      const ud = getCurrentUserData();
      const list = (ud.projects || []).slice().sort((a,b)=>{
        const as = a.start? new Date(a.start): new Date('1900-01-01');
        const bs = b.start? new Date(b.start): new Date('1900-01-01');
        if(as.getTime() !== bs.getTime()) return as - bs;
        const ae = a.end? new Date(a.end): new Date('9999-12-31');
        const be = b.end? new Date(b.end): new Date('9999-12-31');
        return ae - be;
      });

      // table
      projectTableBody.innerHTML = '';
      newShiftProjectSelect.innerHTML = '<option value="">Geen project</option>';
      projectFilterSelect.innerHTML = '<option value="">Alle projecten</option>';

      list.forEach((p, idx)=>{
        const tr = document.createElement('tr');
       // default-flag voor bestaande projecten
if (p.allowMulti === undefined) p.allowMulti = false;

tr.innerHTML = `
  <td>${p.name}</td>
  <td>${toDisplayDate(p.start)}</td>
  <td>${toDisplayDate(p.end)}</td>
  <td class="text-end">
    <button
      class="btn btn-sm ${p.allowMulti ? 'btn-success' : 'btn-outline-secondary'} me-1"
      data-idx="${idx}" data-act="toggle-multi-btn"
      title="Sta extra lijnen toe voor dit project"
    >
      ${p.allowMulti ? 'Extra lijn: aan' : 'Extra lijn: uit'}
    </button>
    <button class="btn btn-sm btn-warning me-1" data-idx="${idx}" data-act="extend">Verleng</button>
    <button class="btn btn-sm btn-danger" data-idx="${idx}" data-act="delete">Verwijder</button>
  </td>`;
        projectTableBody.appendChild(tr);

        const o1 = document.createElement('option'); o1.value=p.name; o1.textContent=p.name; newShiftProjectSelect.appendChild(o1);
        const o2 = document.createElement('option'); o2.value=p.name; o2.textContent=p.name; projectFilterSelect.appendChild(o2);
      });

      // actions
// actions
projectTableBody.querySelectorAll('button').forEach(btn => {
  btn.addEventListener('click', async () => {
    const ud = getCurrentUserData();
    const idx = Number(btn.dataset.idx);
    const p = ud.projects[idx];
    if (!p) return;

    if (btn.dataset.act === 'toggle-multi-btn') {
      // toggle
      p.allowMulti = !p.allowMulti;
      await saveUserData();

      // (optioneel) audit
      try { writeAudit(getActiveUserId(), { action:'project.toggleMulti', context:{ name: p.name }, to: p.allowMulti }); } catch {}

      // UI opnieuw tekenen (zowel projectenlijst als invoertabel, zodat de +-knoppen direct goed staan)
      renderProjects();
      renderMonth(Number(yearSelectMain.value), Number(monthSelectMain.value));
      toast(`Extra lijn ${p.allowMulti ? 'ingeschakeld' : 'uitgeschakeld'} voor ${p.name}`, 'success');
      return;
    }

    if (btn.dataset.act === 'extend') {
      const v = prompt('Nieuwe einddatum (DD-MM-YYYY):', toDisplayDate(p.end) || '');
      if (!v) return;
      p.end = fromDisplayDate(v);

      await saveUserData();
      renderProjects();
      renderMonth(Number(yearSelectMain.value), Number(monthSelectMain.value));
      toast('Project verlengd', 'success');

      // 🔔 Melding naar alle gebruikers (behalve admin zelf)
      const qs = await getDocs(collection(db, 'users'));
      for (const u of qs.docs) {
        if (u.id !== currentUserId) {
          await notifyProjectChange(u.id, 'extended', p.name, v);
        }
      }
    } else if (btn.dataset.act === 'delete') {
      if (!confirm('Project verwijderen?')) return;
      ud.projects.splice(idx, 1);
      await saveUserData();
      renderProjects();
      renderProjectFilterForMonth();
      renderMonth(Number(yearSelectMain.value), Number(monthSelectMain.value));
      toast('Project verwijderd', 'danger');
    }
  });
});
// toggle "extra lijn" per project
projectTableBody.querySelectorAll('input[data-act="toggle-multi"]').forEach(chk => {
  chk.addEventListener('change', async () => {
    const ud = getCurrentUserData();
    const idx = Number(chk.dataset.idx);
    const p = ud.projects[idx];
    if (!p) return;
    p.allowMulti = !!chk.checked;
    await saveUserData();
    toast(`Extra lijn ${p.allowMulti ? 'toegestaan' : 'uitgeschakeld'} voor ${p.name}`, 'success');
  });
});
    }

addProjectBtn?.addEventListener('click', async () => {
  const name = newProjectName.value.trim();
  if (!name) return toast('Vul projectnaam in', 'warning');

  const ud = getCurrentUserData();
  ud.projects = ud.projects || [];
  ud.projects.push({
    name,
    start: newProjectStart.value || null,
    end: newProjectEnd.value || null
  });

  await saveUserData();

  newProjectName.value = '';
  newProjectStart.value = '';
  newProjectEnd.value = '';

  renderProjects();
  renderProjectFilterForMonth();
  toast('Project toegevoegd', 'success');

  // 🔔 Melding naar alle gebruikers (behalve admin zelf)
  const qs = await getDocs(collection(db, 'users'));
  for (const u of qs.docs) {
    if (u.id !== currentUserId) {
      await notifyProjectChange(u.id, 'added', name);
    }
  }
});
    // ======= Shifts =======
function renderShifts() {
  const ud = getCurrentUserData();
  const shifts = ud.shifts || {};
  const order = ud.shiftOrder && ud.shiftOrder.length ? ud.shiftOrder : Object.keys(shifts);

  const selectedYear = filterShiftYear.value ? Number(filterShiftYear.value) : null;

  // Leegmaken
  shiftTableBody.innerHTML = '';

  // Opnieuw opbouwen
  order.forEach(name => {
    const sh = shifts[name];
    if (!sh) return;

    // ✅ Filteren op gekozen jaar
    if (selectedYear) {
      const startY = sh.startDate ? new Date(sh.startDate).getFullYear() : null;
      const endY = sh.endDate ? new Date(sh.endDate).getFullYear() : null;

      // Geen overlap → overslaan
      if (
        (startY && endY && (selectedYear < startY || selectedYear > endY)) ||
        (startY && !endY && selectedYear < startY) ||
        (!startY && endY && selectedYear > endY)
      ) {
        return;
      }
    }

    const tr = document.createElement('tr');
    tr.dataset.name = name;
    tr.setAttribute('draggable', true);
    tr.innerHTML = `
      <td class="fw-medium">
        <span class="material-icons-outlined drag-handle me-1" style="cursor:grab;">drag_indicator</span>${name}
      </td>
      <td class="text-mono">${sh.start || ''}</td>
      <td class="text-mono">${sh.end || ''}</td>
      <td>${sh.break || 0}</td>
      <td>${sh.project || ''}</td>
      <td>${toDisplayDate(sh.startDate)} → ${toDisplayDate(sh.endDate)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-warning me-1" data-name="${name}" data-act="edit">Bewerk</button>
        <button class="btn btn-sm btn-danger" data-name="${name}" data-act="delete">Verwijder</button>
      </td>`;
    shiftTableBody.appendChild(tr);
  });

  // ✅ Activeer SortableJS
  if (shiftTableBody.sortableInstance) {
    shiftTableBody.sortableInstance.destroy();
  }

  shiftTableBody.sortableInstance = new Sortable(shiftTableBody, {
    handle: '.drag-handle',
    animation: 150,
    fallbackOnBody: true,
    swapThreshold: 0.65,
    ghostClass: 'bg-light',
    onEnd: async (evt) => {
      const newOrder = Array.from(shiftTableBody.querySelectorAll('tr')).map(tr => tr.dataset.name);
      ud.shiftOrder = newOrder;
      await saveUserData();
      toast('Volgorde opgeslagen', 'success');
    }
  });

  // acties
  shiftTableBody.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', async () => {
      const act = btn.dataset.act, name = btn.dataset.name;
      if (act === 'delete') {
        if (!confirm(`Shift ${name} verwijderen?`)) return;
        delete ud.shifts[name];
        ud.shiftOrder = (ud.shiftOrder || []).filter(n => n !== name);
        await saveUserData();
        renderShifts();
      } else if (act === 'edit') {
        const sh = ud.shifts[name];
        newShiftName.value = name;
        newShiftStart.value = sh.start || '08:00';
        newShiftEnd.value = sh.end || '16:00';
        newShiftBreak.value = sh.break || 0;
        newShiftProjectSelect.value = sh.project || '';
        newShiftStartDate.value = sh.startDate || '';
        newShiftEndDate.value = sh.endDate || '';
        delete ud.shifts[name];
        await saveUserData();
        new bootstrap.Modal(document.getElementById('shiftModal')).show();
      }
    });
  });
}

    addShiftBtn?.addEventListener('click', async ()=>{
      const name = newShiftName.value.trim(); if(!name) return toast('Vul shift naam in','warning');
      const ud = getCurrentUserData();
      ud.shifts = ud.shifts || {};
      ud.shifts[name] = {
        start: newShiftStart.value || '00:00',
        end: newShiftEnd.value || '00:00',
        break: Number(newShiftBreak.value) || 0,
        project: newShiftProjectSelect.value || null,
        startDate: newShiftStartDate.value || null,
        endDate: newShiftEndDate.value || null
      };
      ud.shiftOrder = ud.shiftOrder || [];
      if(!ud.shiftOrder.includes(name)) ud.shiftOrder.push(name);
      await saveUserData(); renderShifts();
      bootstrap.Modal.getInstance(document.getElementById('shiftModal')).hide();
      newShiftName.value=''; newShiftBreak.value=0; newShiftStartDate.value=''; newShiftEndDate.value='';
      toast('Shift opgeslagen','success');
    });

    filterShiftYear.addEventListener('change', ()=> renderShifts());

function populateFilterShiftYears() {
  const ud = getCurrentUserData();
  const years = new Set();

  // Verzamel jaartallen uit startDate en endDate
  Object.values(ud.shifts || {}).forEach(sh => {
    if (sh.startDate) years.add(new Date(sh.startDate).getFullYear());
    if (sh.endDate) years.add(new Date(sh.endDate).getFullYear());
  });

  const sortedYears = [...years].sort((a, b) => a - b);

  filterShiftYear.innerHTML = '<option value="">Alle jaren</option>';
  sortedYears.forEach(y => {
    const o = document.createElement('option');
    o.value = y;
    o.textContent = y;
    filterShiftYear.appendChild(o);
  });

  // Automatisch huidig jaar selecteren (indien aanwezig)
  const currentYear = new Date().getFullYear();
  if (sortedYears.includes(currentYear)) {
    filterShiftYear.value = currentYear;
  }
}

    // ======= Invoer (maand) =======
function renderProjectFilterForMonth(){
  const ud = getCurrentUserData();
  const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
  const daysInMonth = new Date(y, m+1, 0).getDate();
  const monthStart = `${y}-${String(m+1).padStart(2,'0')}-01`.replaceAll('-','');
  const monthEnd = `${y}-${String(m+1).padStart(2,'0')}-${String(daysInMonth).padStart(2,'0')}`.replaceAll('-','');

  projectFilterSelect.innerHTML = '<option value="">Alle projecten</option>';

  const list = (ud.projects || [])
    .slice()
    .sort((a,b) => {
      const as = a.start ? new Date(a.start) : new Date('1900-01-01');
      const bs = b.start ? new Date(b.start) : new Date('1900-01-01');
      if (as.getTime() !== bs.getTime()) return as - bs;
      return (a.name || '').localeCompare(b.name || '');
    });

  list.forEach(p => {
    const ps = (p.start || '0000-01-01').replaceAll('-','');
    const pe = (p.end || '9999-12-31').replaceAll('-','');
    if (ps <= monthEnd && pe >= monthStart) {
      const o = document.createElement('option');
      o.value = p.name;
      o.textContent = p.name;
      projectFilterSelect.appendChild(o);
    }
  });
}

    async function generateMonth(){
      const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
      const ud = getCurrentUserData();
      ud.monthData = ud.monthData || {};
      ud.monthData[y] = ud.monthData[y] || {};
      if(!ud.monthData[y][m]) ud.monthData[y][m] = { targetHours:0, targetMinutes:0, rows:{} };
      await saveUserData();
      await renderMonth(y,m); updateInputTotals(); renderHome(); renderHistory();
    }
// ✅ Automatische koppeling van project aan shift bij herladen
function autoAssignProjectIfNeeded(r) {
  const sp = autoProjectForShift(r.shift);
  if (sp && (!r.project || r.project === '' || !isValidProject(r.project))) {
    ensureProjectExists(sp);
    r.project = sp;
  }
}
async function renderMonth(year, month){
  const ud = getCurrentUserData();
  ud.monthData[year] ||= {};
  ud.monthData[year][month] ||= { targetHours:0, targetMinutes:0, rows:{} };
  const md = ud.monthData[year][month];

  const selectedProject = projectFilterSelect.value || '';
  tbody.innerHTML = '';

  monthTargetHours.value = md.targetHours || 0;
  monthTargetMinutes.value = md.targetMinutes || 0;

  // lock & tonen acties-kolom
  const statusNow = getMonthStatus(year, month);
  const locked = (statusNow==='approved' || statusNow==='submitted');

  const showActions =
    !locked && ( userAllowsMultiMonth(ud, year, month) || (ud.projects||[]).some(p => p.allowMulti) );
  document.getElementById('thActions')?.classList.toggle('d-none', !showActions);

  const daysInMonth = new Date(year, month+1, 0).getDate();
  for(let d=1; d<=daysInMonth; d++){
    const baseKey = dateKey(year, month, d);
    if (!md.rows[baseKey]) {
      md.rows[baseKey] = { project:'', shift:'', start:'00:00', end:'00:00', break:0, omschrijving:'', minutes:0 };
    } else {
      autoAssignProjectIfNeeded(md.rows[baseKey]);
    }

    const allKeys = listDayKeys(md, baseKey);

    // Filter per project (zichtbare lijst)
    const visibleKeys = allKeys.filter(k => {
      const r = md.rows[k];
      if (!selectedProject) return true;
      return (r.project || '') === selectedProject;
    });

    const renderKeys = visibleKeys.length ? visibleKeys : (selectedProject ? [] : allKeys);

    for (let idx = 0; idx < renderKeys.length; idx++) {
      const rowKey = renderKeys[idx];
      const r = md.rows[rowKey];
      const dayName = daysFull[new Date(year, month, d).getDay()];

      // rechten voor + op deze rij
      const allowByMonth   = userAllowsMultiMonth(ud, year, month);
      const allowByProject = r.project ? canAddMultiForProject(r.project) : false;
      const allowThisRow   = allowByMonth || allowByProject;

      const tr = document.createElement('tr');

      const actionsCell = showActions
        ? (idx === 0
            ? `<td class="actions-cell">
                 <button class="btn btn-outline-success btn-line addLineBtn" ${allowThisRow ? '' : 'disabled'} title="Extra regel toevoegen">+</button>
               </td>`
            : `<td class="actions-cell">
                 <button class="btn btn-outline-danger btn-line delLineBtn" data-key="${rowKey}" title="Deze regel verwijderen">−</button>
               </td>`
          )
        : '';

      tr.innerHTML = `
        ${actionsCell}
        <td>${idx === 0 ? dayName : ''}</td>
        <td>${idx === 0 ? `${String(d).padStart(2,'0')}-${String(month+1).padStart(2,'0')}-${year}` : ''}</td>
        <td><select class="form-select form-select-sm projectSelect"></select></td>
        <td><select class="form-select form-select-sm shiftSelect"></select></td>
        <td><input class="form-control form-control-sm startInput" type="time" value="${r.start}"></td>
        <td><input class="form-control form-control-sm endInput" type="time" value="${r.end}"></td>
        <td><input class="form-control form-control-sm breakInput" type="number" min="0" value="${r.break}"></td>
        <td><input class="form-control form-control-sm omschrijvingInput" type="text" value="${r.omschrijving}"></td>
        <td class="dur text-mono">${Math.floor(r.minutes/60)}u ${r.minutes%60}min</td>`;
      tbody.appendChild(tr);

      // project dropdown (gefilterd op datum)
      const projSel = tr.querySelector('.projectSelect');
      projSel.innerHTML = '<option value="">--</option>';
      (ud.projects || []).forEach(p=>{
        if (isDateWithin(baseKey, p.start || null, p.end || null)) {
          const o = document.createElement('option'); o.value=p.name; o.textContent=p.name; projSel.appendChild(o);
        }
      });
      if(r.project) projSel.value = r.project;

      projSel.addEventListener('change', async ()=>{
        r.project = projSel.value || '';
        saveCell(year, month, rowKey, r, tr);
        await populateShiftSelectForRow(tr, rowKey);
        updateInputTotals();
        saveUserData();

        // + opnieuw (de)activeren
        const addBtn = tr.querySelector('.addLineBtn');
        if (addBtn) {
          const allowByMonth   = userAllowsMultiMonth(getCurrentUserData(), year, month);
          const allowByProject = r.project ? canAddMultiForProject(r.project) : false;
          addBtn.disabled = !(allowByMonth || allowByProject);
        }
      });

      await populateShiftSelectForRow(tr, rowKey);

      tr.querySelector('.startInput').addEventListener('change', e=>{
        r.start = e.target.value; recalcRowMinutes(r);
        saveCell(year, month, rowKey, r, tr);
        tr.querySelector('.dur').textContent = `${Math.floor(r.minutes/60)}u ${r.minutes%60}min`;
        updateInputTotals(); saveUserData(); renderHistory();
      });
      tr.querySelector('.endInput').addEventListener('change', e=>{
        r.end = e.target.value; recalcRowMinutes(r);
        saveCell(year, month, rowKey, r, tr);
        tr.querySelector('.dur').textContent = `${Math.floor(r.minutes/60)}u ${r.minutes%60}min`;
        updateInputTotals(); saveUserData(); renderHistory();
      });
      tr.querySelector('.breakInput').addEventListener('input', e=>{
        r.break = Number(e.target.value)||0; recalcRowMinutes(r);
        saveCell(year, month, rowKey, r, tr);
        tr.querySelector('.dur').textContent = `${Math.floor(r.minutes/60)}u ${r.minutes%60}min`;
        updateInputTotals(); saveUserData(); renderHistory();
      });
      tr.querySelector('.omschrijvingInput').addEventListener('change', e=>{
        r.omschrijving = e.target.value; saveCell(year, month, rowKey, r, tr); saveUserData(); renderHistory();
      });

      // + / − handlers
      const addBtn = tr.querySelector('.addLineBtn');
      if (addBtn) {
        addBtn.addEventListener('click', async () => {
          const idxNew = nextLineIndex(md, baseKey);
          const newKey = `${baseKey}#${idxNew}`;
          md.rows[newKey] = { project: r.project, shift:'', start:'00:00', end:'00:00', break:0, omschrijving:'', minutes:0 };
          await saveUserData();
          renderMonth(year, month);
          updateInputTotals(); renderHistory();
        });
      }
      const delBtn = tr.querySelector('.delLineBtn');
      if (delBtn) {
        delBtn.addEventListener('click', async () => {
          const k = delBtn.dataset.key;
          delete md.rows[k];
          await saveUserData();
          renderMonth(year, month);
          updateInputTotals(); renderHistory();
        });
      }
    }
  }

  await saveUserData();
  updateRemainingHours();
  renderProjectSummary(); 
  updateLeaveBadges(); 
  renderHome();

// 🔒 velden vergrendelen bij submitted/approved
  const lockedNow = (getMonthStatus(year, month)==='approved' || getMonthStatus(year, month)==='submitted');
  tbody.querySelectorAll('select, input').forEach(el => { el.disabled = lockedNow; });

  updateMonthStatusBadge();

  // ✅ Toegevoegd: kaarten + badges verversen
  renderProjectSummaryForVisibleMonth();
  updateLeaveBadges();
}

async function populateShiftSelectForRow(tr, rowKey){
  const base = rowKey.split('#')[0];                   // YYYY-MM-DD
  const [yStr, mStr, dStr] = base.split('-');
  const year = Number(yStr), month = Number(mStr)-1;

  const ud = getCurrentUserData();
  const md = ud.monthData[year][month];
  const r = md.rows[rowKey];

  const projSel = tr.querySelector('.projectSelect');
  const sel = tr.querySelector('.shiftSelect');
  sel.innerHTML = '<option value=""></option>';

  const all = ud.shifts || {};
  const order = ud.shiftOrder || Object.keys(all);
  const entries = order.map(n=> [n, all[n]]).filter(([,sh])=> !!sh);

  for(const [name, sh] of entries){
    if(!isDateWithin(base, sh.startDate || null, sh.endDate || null)) continue;
    const o = document.createElement('option');
    o.value = name; o.textContent = name; if(r.shift===name) o.selected = true; sel.appendChild(o);
  }

  sel.addEventListener('change', async ()=>{
    const chosen = sel.value;
    const all = ud.shifts || {};
    if (!chosen) {
      r.shift = ''; r.project = ''; projSel.value = '';
      saveCell(year, month, rowKey, r, tr); await saveUserData(); updateInputTotals(); renderHistory();
      return;
    }

    r.shift = chosen;
    await saveUserData();

    // auto project (jouw bestaande logica)
    if (['Bench'].includes(chosen)) {
      r.project = '';
      saveCell(year, month, rowKey, r, tr);
      await saveUserData();
    } 
    else if (['Schoolverlof','School'].includes(chosen)) {
      ensureProjectExists('PXL Verpleegkunde Hasselt');
      r.project = 'PXL Verpleegkunde Hasselt';
      saveCell(year, month, rowKey, r, tr);
      await saveUserData();
    } 
    else if (['Verlof','Teammeeting','Ziekte'].includes(chosen)) {
      ensureProjectExists('Eght Care');
      r.project = 'Eght Care';
      saveCell(year, month, rowKey, r, tr);
      await saveUserData();
    } 
    else {
      const sh = all[chosen];
      if (sh && sh.project) {
        const p = (ud.projects||[]).find(px => px.name===sh.project);
        if (p && isDateWithin(base, p.start||null, p.end||null)) {
          r.project = p.name;
        }
      }
    }

    // project dropdown herladen
    projSel.innerHTML = '<option value="">--</option>';
    (getCurrentUserData().projects || []).forEach(p=>{
      if(isDateWithin(base, p.start || null, p.end || null)){
        const o = document.createElement('option');
        o.value = p.name; o.textContent = p.name; projSel.appendChild(o);
      }
    });
    setTimeout(()=> { projSel.value = r.project || ''; }, 50);

    // tijden/pauze invullen
    const sh = all[chosen];
    if (sh) {
      r.start = sh.start || '00:00';
      r.end   = sh.end   || '00:00';
      r.break = Number(sh.break) || 0;
    }
    recalcRowMinutes(r);
    tr.querySelector('.startInput').value = r.start;
    tr.querySelector('.endInput').value = r.end;
    tr.querySelector('.breakInput').value = r.break;
    tr.querySelector('.dur').textContent = `${Math.floor(r.minutes/60)}u ${r.minutes%60}min`;

    saveCell(year, month, rowKey, r, tr);
    await saveUserData();
    updateInputTotals();

    // + opnieuw (de)activeren
    const addBtn = tr.querySelector('.addLineBtn');
    if (addBtn) {
      const allowByMonth   = userAllowsMultiMonth(getCurrentUserData(), year, month);
      const allowByProject = r.project ? canAddMultiForProject(r.project) : false;
      addBtn.disabled = !(allowByMonth || allowByProject);
    }
  });
}
async function ensureProjectExists(name){
  const ud = getCurrentUserData();
  ud.projects = ud.projects || [];
  let p = ud.projects.find(p=> p.name===name);
  if(!p){
    // Oneindige geldigheid (altijd zichtbaar)
    ud.projects.push({ name, start: "2000-01-01", end: "2099-12-31" });
    saveUserData();
    renderProjects(); // meteen toevoegen aan alle dropdowns
  }
}

    function recalcRowMinutes(r){ r.minutes = minutesBetween(r.start, r.end, r.break); }
    function saveCell(year, month, key, r, tr){
      const ud = getCurrentUserData();
      ud.monthData = ud.monthData || {}; ud.monthData[year] = ud.monthData[year] || {};
      ud.monthData[year][month] = ud.monthData[year][month] || { targetHours:0, targetMinutes:0, rows:{} };
      ud.monthData[year][month].rows[key] = { ...r, minutes: r.minutes || minutesBetween(r.start, r.end, r.break) };
    }
    function updateInputTotals(){
      const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
      const ud = getCurrentUserData();
      const md = ud.monthData?.[y]?.[m] || { targetHours:0, targetMinutes:0, rows:{} };
      const total = Object.values(md.rows||{}).reduce((s,r)=> s + (r.minutes||0), 0);
      const target = (md.targetHours||0)*60 + (md.targetMinutes||0);
      const diff = total - target;
      updateRemainingHours();
      updateLeaveBadges();
      renderProjectSummary(); // ✅ toegevoegd
    }

    // live target updates
    monthTargetHours.addEventListener('input', async ()=>{
      const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
      const ud = getCurrentUserData();
      ud.monthData[y][m].targetHours = Number(monthTargetHours.value)||0;
      await saveUserData(); updateInputTotals(); renderHistory();
    });
    monthTargetMinutes.addEventListener('input', async ()=>{
      const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
      const ud = getCurrentUserData();
      ud.monthData[y][m].targetMinutes = Number(monthTargetMinutes.value)||0;
      await saveUserData(); updateInputTotals(); renderHistory();
    });

    projectFilterSelect.addEventListener('change', ()=> { renderMonth(Number(yearSelectMain.value), Number(monthSelectMain.value)); updateInputTotals(); renderProjectSummary(); });

    yearSelectMain.addEventListener('change', async ()=> {
  renderProjectFilterForMonth();
  await generateMonth();
  updateLeaveBadges();
  renderProjectSummary();
});
    monthSelectMain.addEventListener('change', async ()=> { renderProjectFilterForMonth(); generateMonth(); });

    // ======= Quick input =======
    quickDate.addEventListener('change', populateQuickShifts);
    function populateQuickShifts(){
      const ud = getCurrentUserData();
      quickShift.innerHTML = '<option value="">-- Kies shift --</option>';
      const all = ud.shifts || {};
      const order = ud.shiftOrder || Object.keys(all);
      const dateStr = quickDate.value; if(!dateStr) return;
      const withPeriod = [], without = [];
      order.forEach(n=> { const sh = all[n]; if(!sh) return; if(sh.startDate || sh.endDate) withPeriod.push([n,sh]); else without.push([n,sh]); });
      [...withPeriod, ...without].forEach(([n,sh])=>{
        if(!isDateWithin(dateStr, sh.startDate||null, sh.endDate||null)) return;
        const o = document.createElement('option'); o.value=n; o.textContent=n; quickShift.appendChild(o);
      });
    }

    saveQuickBtn.addEventListener('click', async ()=>{
  const date = quickDate.value, shift = quickShift.value, note = quickNote.value;
  if(!date || !shift) return toast('Kies minstens een datum en shift','warning');
  const y = Number(date.split('-')[0]), m = Number(date.split('-')[1]) - 1, key = date;
  const ud = getCurrentUserData();
  ud.monthData = ud.monthData || {}; ud.monthData[y] = ud.monthData[y] || {};
  ud.monthData[y][m] = ud.monthData[y][m] || { targetHours:0, targetMinutes:0, rows:{} };
  const sh = ud.shifts[shift];
  const minutes = minutesBetween(sh.start, sh.end, sh.break);

  // ✅ Automatische projecttoewijzing
let project = sh?.project || '';
const sp = autoProjectForShift(shift);
if (sp) {
  ensureProjectExists(sp);
  project = sp;
}

  ud.monthData[y][m].rows[key] = {
    project,
    shift,
    start: sh.start,
    end: sh.end,
    break: sh.break,
    omschrijving: note,
    minutes
  };

  await saveUserData();
  renderMonth(y, m);
  updateInputTotals();
  renderHistory();
  updateRemainingHours();
  bootstrap.Modal.getInstance(document.getElementById('quickModal')).hide();
  toast('Snelle invoer toegevoegd','success');
});

    // ======= Historiek =======
    function renderHistory(){
      const ud = getCurrentUserData();
      const year = Number(yearSelectMain.value) || new Date().getFullYear();
      historiekJaar.textContent = year;
      currentUserHistoriek.textContent = ud.name || ud.email || '—';

      let totDoel=0, totGepland=0, totVerschil=0, totVerlof=0, totZiekte=0, totSchool=0, totFeest=0, totBench=0;
      historyBody.innerHTML = '';
      for(let m=0; m<12; m++){
        const md = ud.monthData?.[year]?.[m] || { targetHours:0, targetMinutes:0, rows:{} };
        const target = (md.targetHours||0)*60 + (md.targetMinutes||0);
        const rows = md.rows || {};
        const gepland = Object.values(rows).reduce((s,r)=> s + (r.minutes||0), 0);
        let v=0,z=0,sf=0,f=0,b=0;
        Object.values(rows).forEach(r=>{
          if(!r.shift) return;
          if(r.shift==='Verlof') v += r.minutes||0;
          if(r.shift==='Ziekte') z += r.minutes||0;
          if(r.shift==='Schoolverlof') sf += r.minutes||0;
          if(r.shift==='Feestdag') f += r.minutes||0;
          if(r.shift==='Bench') b += r.minutes||0;
        });
        const diff = gepland - target;

        totDoel += target; totGepland += gepland; totVerschil += diff;
        totVerlof += v; totZiekte += z; totSchool += sf; totFeest += f; totBench += b;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${monthsFull[m]}</td>
          <td>${Math.floor(target/60)}u ${target%60}min</td>
          <td>${Math.floor(gepland/60)}u ${gepland%60}min</td>
          <td class="${diff>=0? 'text-success':'text-danger'}">${diff>=0?'+':''}${Math.floor(Math.abs(diff)/60)}u ${Math.abs(diff)%60}min</td>
          <td>${Math.floor(v/60)}u ${v%60}min</td>
          <td>${Math.floor(z/60)}u ${z%60}min</td>
          <td>${Math.floor(sf/60)}u ${sf%60}min</td>
          <td>${Math.floor(f/60)}u ${f%60}min</td>
          <td>${Math.floor(b/60)}u ${b%60}min</td>`;
        historyBody.appendChild(tr);
      }

      document.getElementById('totDoel').textContent = `${Math.floor(totDoel/60)}u ${totDoel%60}min`;
      document.getElementById('totGepland').textContent = `${Math.floor(totGepland/60)}u ${totGepland%60}min`;
      document.getElementById('totVerschil').textContent = `${totVerschil>=0?'+':''}${Math.floor(Math.abs(totVerschil)/60)}u ${Math.abs(totVerschil)%60}min`;
      document.getElementById('totVerlof').textContent = `${Math.floor(totVerlof/60)}u ${totVerlof%60}min`;
      document.getElementById('totZiekte').textContent = `${Math.floor(totZiekte/60)}u ${totZiekte%60}min`;
      document.getElementById('totSchool').textContent = `${Math.floor(totSchool/60)}u ${totSchool%60}min`;
      document.getElementById('totFeest').textContent = `${Math.floor(totFeest/60)}u ${totFeest%60}min`;
      document.getElementById('totBench').textContent = `${Math.floor(totBench/60)}u ${totBench%60}min`;
    }
// === Verlof / Schoolverlof instellingen en badges ===
const LEAVE_SHIFT_NAMES = ['Verlof'];              // telt mee als "verlof"
const SCHOOL_LEAVE_SHIFT_NAMES = ['Schoolverlof']; // telt mee als "schoolverlof"

function getLeaveAllowanceMinutes() {
  const ud = getCurrentUserData();
  return Number(ud?.settings?.leaveAllowanceMinutes) || 0;
}
function getSchoolLeaveAllowanceMinutes(y, m) {
  const ud = getCurrentUserData();
  const label = getAcademicYearBounds(y, m).label; // bv "2024-2025"
  const map = ud?.settings?.schoolLeaveByYear || {};
  return Number(map[label]) || 0;
}
function sumTakenMinutesFor(year, shiftNames) {
  const ud = getCurrentUserData();
  let total = 0;
  const months = ud.monthData?.[year] || {};
  Object.values(months).forEach(md => {
    Object.values(md?.rows || {}).forEach(r => {
      const s = (r?.shift || '').trim();
      if (s && shiftNames.includes(s)) total += Number(r.minutes) || 0;
    });
  });
  return total;
}
function fmtMins(mins) {
  const a = Math.abs(mins);
  return `${Math.floor(a/60)}u ${a%60}min`;
}

// === Schooljaar helpers ===
// Geeft grenzen van het schooljaar terug voor de huidig geselecteerde maand/jaar
function getAcademicYearBounds(y, m /* 0..11 */) {
  const startYear = (m >= 8) ? y : y - 1;   // 8 = september
  const endYear   = startYear + 1;
  const startISO  = `${startYear}-09-01`;
  const endISO    = `${endYear}-08-31`;
  return { startISO, endISO, label: `${startYear}-${endYear}` };
}

// Sommeer minuten voor opgegeven shifts binnen [startISO, endISO]
function sumTakenMinutesForRange(startISO, endISO, shiftNames) {
  const ud = getCurrentUserData();
  let total = 0;
  for (const months of Object.values(ud.monthData || {})) {
    for (const md of Object.values(months || {})) {
      for (const [key, r] of Object.entries(md?.rows || {})) {
        const sName = (r?.shift || '').trim();
        if (!sName || !shiftNames.includes(sName)) continue;
        if (isDateWithin(key, startISO, endISO)) {
          total += Number(r.minutes) || 0;
        }
      }
    }
  }
  return total;
}
function buildSchoolYearOptions(selectEl) {
  if (!selectEl) return;
  const now = new Date();
  const yNow = now.getMonth() >= 8 ? now.getFullYear() : now.getFullYear() - 1; // sept = 8
  const years = [];
  for (let y = yNow - 3; y <= yNow + 3; y++) {
    years.push(`${y}-${y+1}`);
  }
  selectEl.innerHTML = '';
  years.forEach(label => {
    const opt = document.createElement('option');
    opt.value = label;
    opt.textContent = label;
    selectEl.appendChild(opt);
  });
}
// === Verlof / Schoolverlof badges (met schooljaar-logica) ===
function updateLeaveBadges() {
  const badgeLeave  = document.getElementById('leaveBalanceBadge');
  const badgeSchool = document.getElementById('schoolLeaveBalanceBadge');

  const y = Number(yearSelectMain.value);
  const m = Number(monthSelectMain.value);

  // ---- Gewoon verlof (kalenderjaar, ongewijzigd) ----
  if (badgeLeave) {
    const allowance = getLeaveAllowanceMinutes();
    if (!allowance) {
      badgeLeave.textContent = 'Verlof saldo: — (stel in)';
      badgeLeave.className = 'badge bg-secondary-subtle text-dark ms-2';
    } else {
      const taken = sumTakenMinutesFor(y, LEAVE_SHIFT_NAMES);
      const remaining = allowance - taken;
      const over = remaining < 0;
      badgeLeave.textContent = over
        ? `Verlof saldo: -${fmtMins(remaining)} (overschreden)`
        : `Verlof saldo: ${fmtMins(remaining)} over`;
      badgeLeave.className = `badge ms-2 ${over ? 'bg-danger' : (remaining === 0 ? 'bg-warning text-dark' : 'bg-success')}`;
    }
  }

  // ---- Schoolverlof (schooljaar 1/9–31/8) ----
  if (badgeSchool) {
    const allowance = getSchoolLeaveAllowanceMinutes(y, m);
    if (!allowance) {
      badgeSchool.textContent = 'Schoolverlof saldo: — (stel in)';
      badgeSchool.className = 'badge bg-secondary-subtle text-dark ms-2';
    } else {
      const { startISO, endISO, label } = getAcademicYearBounds(y, m);
      const taken = sumTakenMinutesForRange(startISO, endISO, SCHOOL_LEAVE_SHIFT_NAMES);
      const remaining = allowance - taken;
      const over = remaining < 0;
      badgeSchool.textContent = over
        ? `Schoolverlof saldo: -${fmtMins(remaining)} (overschreden) — ${label}`
        : `Schoolverlof saldo: ${fmtMins(remaining)} over — ${label}`;
      badgeSchool.className = `badge ms-2 ${over ? 'bg-danger' : (remaining === 0 ? 'bg-warning text-dark' : 'bg-success')}`;
    }
  }
}

// === Admin: velden tonen/opslaan ===
function hydrateAdminLeaveInputsFor(uid) {
  const prev = dataStore.viewUserId;
  dataStore.viewUserId = uid;

  const ud = getCurrentUserData();

  // kalenderjaar-verlof (zoals je al had)
  const i1 = document.getElementById('adminLeaveHours');
  if (i1) i1.value = Math.floor((ud?.settings?.leaveAllowanceMinutes || 0) / 60) || '';
document.getElementById('adminSaveLeaveBtn')?.addEventListener('click', async () => {
  const uid = adminUserSelect?.value || getActiveUserId();
  if (!uid) return toast('Geen gebruiker geselecteerd', 'warning');

  const prev = dataStore.viewUserId; dataStore.viewUserId = uid;
  const ud = getCurrentUserData(); ud.settings ||= {};

  const hours = Math.max(0, Number(document.getElementById('adminLeaveHours')?.value || 0));
  ud.settings.leaveAllowanceMinutes = hours * 60;

  await saveUserData();
  dataStore.viewUserId = prev;
  updateLeaveBadges(); renderHome();
  toast('Verlof (kalenderjaar) opgeslagen', 'success');
});

document.getElementById('adminResetLeaveBtn')?.addEventListener('click', async () => {
  const uid = adminUserSelect?.value || getActiveUserId();
  if (!uid) return toast('Geen gebruiker geselecteerd', 'warning');

  const prev = dataStore.viewUserId; dataStore.viewUserId = uid;
  const ud = getCurrentUserData(); ud.settings ||= {};
  delete ud.settings.leaveAllowanceMinutes;

  await saveUserData();
  dataStore.viewUserId = prev;

  hydrateAdminLeaveInputsFor(uid);
  updateLeaveBadges(); renderHome();
  toast('Kalenderjaar-verlof leeggemaakt', 'info');
});
  // schooljaar-verlof
  const yearSel = document.getElementById('adminSchoolYearSelect');
  const schoolHoursInput = document.getElementById('adminSchoolLeaveHours');
  if (yearSel && schoolHoursInput) {
    if (!yearSel.options.length) buildSchoolYearOptions(yearSel);
    const label = yearSel.value; // bv "2024-2025"
    const map = ud?.settings?.schoolLeaveByYear || {};
    const mins = Number(map[label] || 0);
    schoolHoursInput.value = mins ? Math.floor(mins / 60) : '';
  }

  dataStore.viewUserId = prev;
}

document.getElementById('adminSchoolYearSelect')?.addEventListener('change', () => {
  const uid = adminUserSelect?.value || getActiveUserId();
  if (uid) hydrateAdminLeaveInputsFor(uid);
});

document.getElementById('adminSaveSchoolLeaveBtn')?.addEventListener('click', async () => {
  const uid = adminUserSelect?.value || getActiveUserId();
  if (!uid) return toast('Geen gebruiker geselecteerd', 'warning');

  const prev = dataStore.viewUserId;
  dataStore.viewUserId = uid;

  const ud = getCurrentUserData();
  ud.settings ||= {};
  ud.settings.schoolLeaveByYear ||= {};

  const label = document.getElementById('adminSchoolYearSelect')?.value;
  const hours = Math.max(0, Number(document.getElementById('adminSchoolLeaveHours')?.value || 0));

  if (!label) {
    dataStore.viewUserId = prev;
    return toast('Kies een schooljaar', 'warning');
  }

  ud.settings.schoolLeaveByYear[label] = hours * 60; // bewaar in minuten
  await saveUserData();

  dataStore.viewUserId = prev;
  updateLeaveBadges();
  renderHome();
  toast(`Schoolverlof opgeslagen voor ${label}`, 'success');
});

document.getElementById('adminResetSchoolLeaveBtn')?.addEventListener('click', async () => {
  const uid = adminUserSelect?.value || getActiveUserId();
  if (!uid) return toast('Geen gebruiker geselecteerd', 'warning');

  const prev = dataStore.viewUserId;
  dataStore.viewUserId = uid;

  const ud = getCurrentUserData();
  const label = document.getElementById('adminSchoolYearSelect')?.value;
  if (ud?.settings?.schoolLeaveByYear && label in ud.settings.schoolLeaveByYear) {
    delete ud.settings.schoolLeaveByYear[label];
    await saveUserData();
  }

  dataStore.viewUserId = prev;
  hydrateAdminLeaveInputsFor(uid);
  updateLeaveBadges();
  renderHome();
  toast(`Schoolverlof leeggemaakt voor ${label}`, 'info');
});

// === Project-samenvatting (zichtbare maand) ===
function renderProjectSummaryForVisibleMonth() 
{
  const wrap = document.getElementById('projectSummary');
  if (!wrap) return;

  const y = Number(yearSelectMain.value);
  const m = Number(monthSelectMain.value);
  const ud = getCurrentUserData();
  const md = ud.monthData?.[y]?.[m] || { rows:{} };

  const map = new Map(); // project -> minuten
  Object.values(md.rows || {}).forEach(r => {
    const mins = Number(r?.minutes) || 0;
    if (mins <= 0) return;
    const key = (r?.project || '').trim() || '— Geen project';
    map.set(key, (map.get(key) || 0) + mins);
  });

  if (map.size === 0) {
    wrap.innerHTML = '<div class="alert alert-light border small mb-0">Nog geen minuten in deze maand.</div>';
    return;
  }

  const items = [...map.entries()]
    .sort((a,b)=> b[1]-a[1])
    .map(([name, mins]) => {
      const h = Math.floor(mins/60), min = mins%60;
      return `
        <div class="project-mini">
          <div class="meta">Project</div>
          <div class="title">${name}</div>
          <div class="value">${h}u ${min}min</div>
        </div>`;
    });

  wrap.innerHTML = `
    <div class="d-flex align-items-center gap-2 mb-2">
      <h6 class="mb-0">Project-samenvatting</h6>
      <span class="text-muted small">totaal minuten per project (zichtbare maand)</span>
    </div>
    ${items.join('')}
  `;
}

// ======= Admin =======
// Gebruikerslijst renderen
async function renderAdminUserSelect() {
  adminUserSelect.innerHTML = '<option value="">-- Kies gebruiker --</option>';
  const qs = await getDocs(collection(db, 'users'));
  qs.forEach(d => {
    const u = d.data();
    const opt = document.createElement('option');
    opt.value = d.id;
    opt.textContent = `${u.name || u.email || d.id} (${u.role || 'user'})`;
    adminUserSelect.appendChild(opt);
  });

  activeUserLabel.textContent =
    dataStore.users[currentUserId]?.name || currentUserName.textContent || '-';
}
document.querySelector('a[href="#tab-admin"]')?.addEventListener('shown.bs.tab', () => {
  buildSchoolYearOptions(document.getElementById('adminSchoolYearSelect'));
  const uid = adminUserSelect?.value || getActiveUserId();
  if (uid) hydrateAdminLeaveInputsFor(uid); // vult waarden in
});
// ✅ Gebruiker selecteren zonder adminstatus te verliezen
adminUserSelect?.addEventListener('change', async () => {
  const uid = adminUserSelect.value;
  if (!uid) return;

  try {
    const snap = await getDoc(doc(db, 'users', uid));
    if (!snap.exists()) {
      toast('Gebruiker niet gevonden', 'warning');
      return;
    }

    const u = snap.data();
    // Plaats de gebruiker tijdelijk in dataStore voor weergave
    dataStore.users[uid] = u;

    // UI labels bijwerken
    activeUserLabel.textContent = u.name || u.email || uid;
    roleSelect.value = u.role || 'user';
    document.getElementById('currentUserName').textContent = u.name || u.email || uid;
    document.getElementById('currentUserHistoriek').textContent = u.name || u.email || uid;

    // We tonen enkel hun data (zonder rechten te verliezen)
    await renderUserDataAsAdmin(uid);
    toast(`Beheer actief voor ${u.name || uid}`, 'primary');
  } catch (err) {
    console.error(err);
    toast('Fout bij laden van gebruiker', 'danger');
  }
});

// ✅ Alleen UI renderen voor geselecteerde gebruiker
async function renderUserDataAsAdmin(uid) {
  const snap = await getDoc(doc(db, 'users', uid));
  if (!snap.exists()) return;
  const u = snap.data();

  // Tijdelijk: toon deze data in invoer & historiek
  dataStore.users[uid] = u;
  dataStore.viewUserId = uid;

  renderProjects();
  renderShifts();
  populateFilterShiftYears();
  renderProjectFilterForMonth();
  generateMonth();
  renderHistory();
}

// ✅ Rol bijwerken
updateRoleBtn?.addEventListener('click', async () => {
  const uid = adminUserSelect.value;
  const newRole = roleSelect.value;
  if (!uid) return toast('Geen gebruiker geselecteerd', 'warning');

  try {
    await updateDoc(doc(db, 'users', uid), { role: newRole });
    toast(`Rol aangepast naar ${newRole}`, 'success');
    await renderAdminUserSelect();
  } catch (err) {
    console.error(err);
    toast('Fout bij rol aanpassen — controleer Firestore-regels', 'danger');
  }
});

// ✅ Gebruiker verwijderen
removeUserBtn?.addEventListener('click', async () => {
  const uid = adminUserSelect.value;
  if (!uid) return toast('Geen gebruiker geselecteerd', 'warning');
  if (uid === currentUserId) return toast('Je kunt jezelf niet verwijderen', 'warning');
  if (!confirm('Weet je zeker dat je deze gebruiker wilt verwijderen?')) return;

  try {
    await deleteDoc(doc(db, 'users', uid));
    toast('Gebruiker verwijderd', 'danger');
    await renderAdminUserSelect();
    dataStore.viewUserId = null;
  } catch (err) {
    console.error(err);
    toast('Fout bij verwijderen — controleer Firestore-regels', 'danger');
  }
});

    // ======= Converter =======
    const convHours = document.getElementById('convHours');
    const convMinutes = document.getElementById('convMinutes');
    const decimalInput = document.getElementById('decimalInput');
    function updateDecimal(){
      const h = Number(convHours.value)||0, m = Number(convMinutes.value)||0;
      decimalInput.value = (h + m/60).toFixed(2);
    }
    function updateHM(){
      const dec = Number(decimalInput.value)||0;
      const h = Math.floor(dec), m = Math.round((dec-h)*60);
      convHours.value = h; convMinutes.value = m;
    }
    convHours.addEventListener('input', updateDecimal);
    convMinutes.addEventListener('input', updateDecimal);
    decimalInput.addEventListener('input', updateHM);

    
    document.getElementById('sidebarToggle').addEventListener('click', ()=>{
      sidebar.classList.toggle('collapsed'); main.classList.toggle('collapsed');
    });
    document.getElementById('sidebarMobile').addEventListener('click', ()=>{
      sidebar.classList.toggle('show');
    });
    // ======= Admin tab =======
    document.querySelector('a[href="#tab-admin"]')
  ?.addEventListener('shown.bs.tab', renderAdminMonthlyMulti);
    // close sidebar on nav click (mobile)
    document.querySelectorAll('#navTabs .nav-link').forEach(a=>{
      a.addEventListener('click', ()=> sidebar.classList.remove('show'));
    });

    // ======= Render all =======
    function renderAll(){
      renderProjects();
      renderShifts();
      populateFilterShiftYears();
      renderProjectFilterForMonth();
      generateMonth();
      renderAdminUserSelect();
      renderAdminMonthlyMulti();
      updateRemainingHours();
      updateLeaveBadges();
      renderHome();

    }
     // ✅ Plaats DIT hier:
document.getElementById('exportPdfBtn')?.addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: 'a4' });

  const monthIndex = Number(document.getElementById('monthSelectMain').value);
  const year = document.getElementById('yearSelectMain').value;
  const monthName = monthsFull[monthIndex];
  const ud = getCurrentUserData();
  const md = ud.monthData?.[year]?.[monthIndex];

  if (!md || !md.rows || Object.keys(md.rows).length === 0) {
    return toast('Geen data voor deze maand', 'warning');
  }
  // === Header met branding ===
  const pageWidth = doc.internal.pageSize.width;
  doc.setFillColor(13, 110, 253);
  doc.rect(0, 0, pageWidth, 25, 'F');
  doc.setFontSize(16);
  doc.setTextColor(255, 255, 255);
  doc.text('Shift Planner', 14, 15);
  doc.setFontSize(11);
  doc.text(`${monthName} ${year}`, pageWidth - 50, 15);

  // Gebruikersinfo
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(9);
  doc.text(`Gebruiker: ${ud.name || ud.email || '-'}`, 14, 32);
  doc.text(`Exportdatum: ${new Date().toLocaleDateString('nl-BE')}`, 14, 37);

  // === Data voorbereiden ===
  const body = Object.entries(md.rows)
    .sort(([a], [b]) => a.localeCompare(b)) // chronologisch sorteren
    .map(([key, r]) => {
      const date = key.split('-').reverse().join('-');
      const duration = `${Math.floor(r.minutes / 60)}u ${r.minutes % 60}m`;
      return [
        date,
        r.project || '-',
        r.shift || '-',
        r.start || '',
        r.end || '',
        r.break || 0,
        duration,
        r.omschrijving || ''
      ];
    });

  // === AutoTable met compacte styling ===
  doc.autoTable({
    head: [['Datum', 'Project', 'Shift', 'Start', 'Einde', 'Pauze', 'Duur', 'Omschrijving']],
    body,
    startY: 43,
    theme: 'grid',
    styles: {
      fontSize: 8,
      cellPadding: 1.5,
      lineWidth: 0.1
    },
    headStyles: { fillColor: [13, 110, 253], textColor: 255 },
    alternateRowStyles: { fillColor: [248, 249, 252] },
    margin: { left: 8, right: 8 },
    tableWidth: 'auto',
    columnStyles: {
      0: { cellWidth: 20 }, // datum
      1: { cellWidth: 30 }, // project
      2: { cellWidth: 25 }, // shift
      3: { cellWidth: 15 }, // start
      4: { cellWidth: 15 }, // einde
      5: { cellWidth: 12 }, // pauze
      6: { cellWidth: 18 }, // duur
      7: { cellWidth: 'auto' } // omschrijving
    },
    didDrawPage: (data) => {
      const pageCount = doc.internal.getNumberOfPages();
      const pageHeight = doc.internal.pageSize.height;
      doc.setFontSize(8);
      doc.setTextColor(120);
      doc.text(`Pagina ${pageCount}`, pageWidth - 30, pageHeight - 8);
    }
  });

  // === Samenvatting onder tabel ===
  const total = Object.values(md.rows).reduce((s, r) => s + (r.minutes || 0), 0);
  const doel = ((md.targetHours || 0) * 60) + (md.targetMinutes || 0);
  const diff = total - doel;
  const fmt = v => `${Math.floor(v / 60)}u ${v % 60}m`;
  const endY = doc.lastAutoTable.finalY + 6;

  doc.setFontSize(11);
  doc.setTextColor(13, 110, 253);
  doc.text('Maandoverzicht', 14, endY);
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(9);
  doc.text(`Doel: ${fmt(doel)}`, 20, endY + 5);
  doc.text(`Gepland: ${fmt(total)}`, 20, endY + 10);
  doc.text(`Verschil: ${(diff >= 0 ? '+' : '-') + fmt(Math.abs(diff))}`, 20, endY + 15);

  // === PDF genereren ===
  const filename = `Shiftplanning_${ud.name || 'gebruiker'}_${monthName}_${year}.pdf`;
  doc.save(filename);
  toast('PDF geëxporteerd', 'success');
});
// 🔁 Shift toepassen op meerdere dagen
const multiShiftName = document.getElementById('multiShiftName');
const multiShiftStart = document.getElementById('multiShiftStart');
const multiShiftEnd = document.getElementById('multiShiftEnd');
const multiShiftDays = document.getElementById('multiShiftDays');
const multiDayShiftBtn = document.getElementById('multiDayShiftBtn');

// knop opent modal
document.getElementById('multiDayShiftBtn')?.addEventListener('click', () => {
  const modal = new bootstrap.Modal(document.getElementById('multiDayModal'));
  modal.show();
});

// 🖱️ Open modal en stel kalender in op huidige maand
document.getElementById('multiDayShiftBtn')?.addEventListener('click', () => {
  const modal = new bootstrap.Modal(document.getElementById('multiDayModal'));
  modal.show();
  setTimeout(initMultiDayPicker, 150); // even wachten tot modal zichtbaar is
});

// 🔵 Herkleur direct alle ingeplande dagen opnieuw
const plannedDates = Object.keys(
  getCurrentUserData()?.monthData?.[yearSelectMain.value]?.[monthSelectMain.value]?.rows || {}
);
if (window.multiDayPicker) {
  highlightPlannedDays(window.multiDayPicker, plannedDates);
}
// 🔔 In-app notificaties
const notifBtn = document.getElementById('notifBtn');
const notifDropdown = document.getElementById('notifDropdown');
const notifList = document.getElementById('notifList');
const notifBadge = document.getElementById('notifBadge');
const markAllReadBtn = document.getElementById('markAllReadBtn');

notifBtn?.addEventListener('click', (e) => {
  e.stopPropagation(); // voorkom dat klik buiten dropdown het meteen sluit

  // Sluit andere openstaande dropdowns
  document.querySelectorAll('.dropdown-menu.show').forEach(el => {
    if (el !== notifDropdown) el.classList.remove('show');
  });

  notifDropdown.classList.toggle('show');
});

// Klik buiten dropdown → sluit hem
document.addEventListener('click', (e) => {
  if (!notifDropdown.contains(e.target) && e.target !== notifBtn) {
    notifDropdown.classList.remove('show');
  }
});

markAllReadBtn?.addEventListener('click', async () => {
  if (!currentUserId) return;

  const colRef = collection(db, 'users', currentUserId, 'notifications');
  const snap = await getDocs(colRef);

  // 🔥 Verwijder alle meldingen
  const batchDeletes = snap.docs.map(d => deleteDoc(d.ref));
  await Promise.all(batchDeletes);

  // UI opschonen
  notifList.innerHTML = '';
  notifBadge.classList.add('d-none');

  toast('Alle meldingen verwijderd', 'success');
});
let lastVisible = null; // houdt bij tot waar we geladen hebben

// 🔁 Laad de eerste reeks meldingen
function listenToNotifications(uid) {
  const colRef = collection(db, 'users', uid, 'notifications');
  const q = query(colRef, orderBy('timestamp', 'desc'), limit(20));

  onSnapshot(q, (snapshot) => {
    notifList.innerHTML = '';
    let unread = 0;

    const docs = snapshot.docs;
    lastVisible = docs[docs.length - 1]; // laatste document bewaren

    snapshot.forEach((docSnap) => {
      const n = docSnap.data();
      const time = n.timestamp ? new Date(n.timestamp).toLocaleString('nl-BE') : '';
      if (!n.read) unread++;
      const li = document.createElement('li');
      li.className = `mb-1 p-1 rounded ${n.read ? '' : 'bg-light unread'}`;
      li.innerHTML = `
        <div>${n.text}</div>
        <div class="text-muted small">${time}</div>
      `;
      notifList.appendChild(li);
    });

    notifBadge.textContent = unread;
    notifBadge.classList.toggle('d-none', unread === 0);

    // Toon 'Toon meer' als er minstens 20 meldingen zijn
    document.getElementById('loadMoreNotifBtn').classList.toggle('d-none', docs.length < 20);
  });
}

// 📥 Extra meldingen ophalen
async function loadMoreNotifications(uid) {
  if (!lastVisible) return;
  const colRef = collection(db, 'users', uid, 'notifications');
  const qMore = query(
    colRef,
    orderBy('timestamp', 'desc'),
    startAfter(lastVisible),
    limit(20)
  );

  const snap = await getDocs(qMore);
  if (snap.empty) {
    document.getElementById('loadMoreNotifBtn').classList.add('d-none');
    return;
  }

  snap.forEach((docSnap) => {
    const n = docSnap.data();
    const time = n.timestamp ? new Date(n.timestamp).toLocaleString('nl-BE') : '';
    const li = document.createElement('li');
    li.className = `mb-1 p-1 rounded ${n.read ? '' : 'bg-light unread'}`;
    li.innerHTML = `
      <div>${n.text}</div>
      <div class="text-muted small">${time}</div>
    `;
    notifList.appendChild(li);
  });

  lastVisible = snap.docs[snap.docs.length - 1]; // update naar nieuw einde
}

// 🎛️ Koppel knop aan event
document.getElementById('loadMoreNotifBtn')?.addEventListener('click', async () => {
  await loadMoreNotifications(currentUserId);
});
// ✅ Start luisteren na login
onAuthStateChanged(auth, async (user) => {
  if (user) {
    listenToNotifications(user.uid);

    // 🕒 Start automatische meldingensysteem
    await autoCheckNotifications(); // direct uitvoeren bij login

    // 🔁 Herhaal automatisch elke 6 uur (21600000 ms)
    setInterval(async () => {
      await autoCheckNotifications();
    }, 21600000);
  }
});
// helpers bovenin
function getISOWeekParts(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const day = d.getUTCDay() || 7;           // ma=1..zo=7
  d.setUTCDate(d.getUTCDate() + 4 - day);   // naar donderdag
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  const week = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return { week, year: d.getUTCFullYear() };
}
function isoWeekId(date) {
  const { week, year } = getISOWeekParts(date);
  return `${year}-W${String(week).padStart(2, '0')}`;
}
// 🔔 Automatisch meldingsysteem — controleert volledige jaar
async function autoCheckNotifications() {
  if (!currentUserId) return;
  const uid = currentUserId;
  const ud = getCurrentUserData();
  if (!ud || !ud.monthData) return;

  const today = new Date();
  const currentYear = today.getFullYear();

// 🔹 1. Controleer of gebruiker deze week nog niets heeft ingevoerd
{
  const thisWeek = isoWeekId(new Date());
  let hasShiftThisWeek = false;
  const yearMap = ud.monthData || {};

  // Loop alle jaren/maanden/rijen af
  for (const yStr of Object.keys(yearMap)) {
    const months = yearMap[yStr] || {};
    for (const mStr of Object.keys(months)) {
      const rowsObj = months[mStr]?.rows || {};
      for (const key of Object.keys(rowsObj)) {
        const [Y, M, D] = key.split('-').map(Number);
        const rowDate = new Date(Y, M - 1, D);

        // ✅ Negeer "Vrij weekend"
        const shiftName = rowsObj[key]?.shift?.trim() || '';
        const filled = shiftName && shiftName !== 'Vrij weekend';

        if (isoWeekId(rowDate) === thisWeek && filled) {
          hasShiftThisWeek = true;
          break;
        }
      }
      if (hasShiftThisWeek) break;
    }
    if (hasShiftThisWeek) break;
  }

  if (!hasShiftThisWeek) {
    await createUniqueNotification(uid, 'Je hebt deze week nog geen shifts ingevuld.');
  }
}
const currentMonthData = ud.monthData?.[currentYear]?.[today.getMonth()] || { rows: {}, targetHours: 0, targetMinutes: 0 };
const md = currentMonthData;
  // 🔹 2. Controleer maanddoel vs. werkelijk (alleen huidige maand)
  const doel = (md.targetHours || 0) * 60 + (md.targetMinutes || 0);
  const gepland = Object.values(md.rows || {}).reduce((s, r) => s + (r.minutes || 0), 0);
  if (doel > 0 && gepland < doel * 0.8) {
    await createUniqueNotification(uid, 'Je hebt nog minder dan 80% van je maanddoel behaald.');
  }

  // 🔹 3. Controleer of projecten binnenkort aflopen
  const soon = ud.projects?.filter(p => {
    if (!p.end) return false;
    const end = new Date(p.end);
    const diff = (end - today) / (1000 * 60 * 60 * 24);
    return diff > 0 && diff < 14; // binnen 2 weken
  });
  if (soon?.length) {
    const names = soon.map(p => p.name).join(', ');
    await createUniqueNotification(uid, `Project(en) bijna afgelopen: ${names}`);
  }

// 🔹 4. Controleer ALLE dagen van het huidige jaar (alleen echte lege dagen)
const startOfYear = new Date(today.getFullYear(), 0, 1);
const endOfYear = new Date(today);

for (let d = new Date(startOfYear); d <= endOfYear; d.setDate(d.getDate() + 1)) {
  const y = d.getFullYear();
  const m = d.getMonth();
  const day = d.getDate();
  const key = `${y}-${String(m + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

  const rows = ud.monthData?.[y]?.[m]?.rows || {};
  const r = rows[key];

  // ⛔ Geen maanddata of geen rij → overslaan
  if (!ud.monthData?.[y]?.[m] || !r) continue;

  // ⛔ Toekomstige dagen overslaan
  if (d > today) continue;

  // ⛔ Vrije shifts overslaan
  const skipShifts = ['Vrij weekend', 'Verlof', 'Ziekte', 'Feestdag', 'Schoolverlof', 'School', 'Bench'];
  const shiftName = (r?.shift || '').trim();
  const isEmpty = !shiftName;
  const isSkipped = skipShifts.includes(shiftName);

  if (isEmpty && !isSkipped) {
    await createUniqueNotification(
      uid,
      `Geen shift ingevuld op ${String(day).padStart(2, '0')}-${String(m + 1).padStart(2, '0')}-${y}.`
    );
  }
}

  // 🔹 5. Automatisch opruimen van meldingen ouder dan 30 dagen
  const notifCol = collection(db, 'users', uid, 'notifications');
  const notifSnap = await getDocs(notifCol);
  const nowClean = new Date();

  notifSnap.forEach(async (docSnap) => {
    const n = docSnap.data();
    if (n.timestamp) {
      const created = new Date(n.timestamp);
      const ageDays = (nowClean - created) / (1000 * 60 * 60 * 24);
      if (ageDays > 30) {
        await deleteDoc(docSnap.ref);
        console.log(`🧹 Oude melding verwijderd (${n.text})`);
      }
    }
  });
}
// ⚙️ Helper
async function createUniqueNotification(uid, text) {
  const colRef = collection(db, 'users', uid, 'notifications');
  const todayKey = new Date().toISOString().slice(0, 10);
  const q = query(colRef, where('text', '==', text), where('dateKey', '==', todayKey));
  const snap = await getDocs(q);
  if (!snap.empty) return;

  await addDoc(colRef, {
    text,
    timestamp: new Date().toISOString(),
    dateKey: todayKey,
    read: false
  });

  // ➕ Log ook als "noreply"-mail in de inbox
  await sendSystemMail(
    uid,
    'Notificatie',
    text,
    'notification'
  );

  console.log('🔔 Automatische melding + mail aangemaakt:', text);
}
// 🔔 Stuur melding naar gebruiker bij projectwijziging (door admin)
async function notifyProjectChange(userId, type, projectName, newEndDate = null) {
  const colRef = collection(db, 'users', userId, 'notifications');
  const todayKey = new Date().toISOString().slice(0, 10);
  let text = '';

  if (type === 'added') {
    text = `Admin heeft een nieuw project toegevoegd: ${projectName}`;
  } else if (type === 'extended') {
    text = `Admin heeft het project "${projectName}" verlengd tot ${newEndDate}`;
  }

  const q = query(colRef, where('text', '==', text), where('dateKey', '==', todayKey));
  const snap = await getDocs(q);
  if (snap.empty) {
    await addDoc(colRef, { text, timestamp: new Date().toISOString(), dateKey: todayKey, read: false });
  }

  // ✉️ Mail erbij
  await sendSystemMail(userId, 'Projectupdate', text, 'notification');
  console.log('🔔 Melding + mail gestuurd naar gebruiker:', text);
}

// 🌙 Donkere modus
const darkModeBtn = document.getElementById('darkModeBtn');
const prefersDark = localStorage.getItem('darkMode') === 'true';
if (prefersDark) document.body.classList.add('dark-mode');

darkModeBtn?.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  const active = document.body.classList.contains('dark-mode');
  localStorage.setItem('darkMode', active);
});

// 🔄 Loading overlay
function showLoading(show = true) {
  document.getElementById('loadingOverlay').classList.toggle('d-none', !show);
}

// 🎯 Resterende uren-teller
function updateRemainingHours() {
  const alertBox = document.getElementById('remainingHoursAlert');
  if (!alertBox) return;

  const year = parseInt(yearSelectMain.value);
  const month = parseInt(monthSelectMain.value);
  const ud = getCurrentUserData();
  const monthData = ud?.monthData?.[year]?.[month];
  if (!monthData) {
    alertBox.classList.add('d-none');
    return;
  }

  const doel = (monthData.targetHours || 0) * 60 + (monthData.targetMinutes || 0);
  const gepland = Object.values(monthData.rows || {}).reduce((s, r) => s + (r.minutes || 0), 0);
  const verschil = doel - gepland;
  const pct = doel > 0 ? Math.round((gepland / doel) * 100) : 0;

  // 🔹 Bereken tekst voor resterende of extra uren
  let resterendTekst = '';
  if (verschil > 0) {
    const uren = Math.floor(verschil / 60);
    const min = verschil % 60;
    resterendTekst = `🕓 <b>Resterend:</b> ${uren}u ${min}min`;
  } else if (verschil < 0) {
    const extra = Math.abs(verschil);
    const uren = Math.floor(extra / 60);
    const min = extra % 60;
    resterendTekst = `✅ <b>Meer uren:</b> ${uren}u ${min}min`;
  } else {
    resterendTekst = `✅ <b>Doel exact behaald!</b>`;
  }

  // 🔹 Kleur aanpassen volgens voortgang
  alertBox.classList.remove('alert-danger', 'alert-success');
  if (pct >= 100) {
    alertBox.classList.add('alert-success'); // groen
  } else {
    alertBox.classList.add('alert-danger'); // rood
  }

  // 🔹 HTML samenstellen
  alertBox.innerHTML = `
    🎯 <b>Doel:</b> ${Math.floor(doel / 60)}u ${doel % 60}min 
    &nbsp;|&nbsp; ⏱ <b>Gepland:</b> ${Math.floor(gepland / 60)}u ${gepland % 60}min 
    &nbsp;|&nbsp; ${resterendTekst}
  `;
  alertBox.classList.remove('d-none');
}
// 💡 Laat de balk zweven — maar schuif omhoog bij paginabodem
document.addEventListener('DOMContentLoaded', () => {
  const alertBox = document.getElementById('remainingHoursAlert');
  if (!alertBox) return;

  const TOPBAR_H = 70;
  const getThreshold = () => Math.max(0, alertBox.offsetTop - TOPBAR_H);
  let threshold = getThreshold();

  const toggleFloating = () => {
    const shouldFloat = window.scrollY > threshold;
    alertBox.classList.toggle('floating', shouldFloat);

    const scrollBottom = window.innerHeight + window.scrollY;
    const pageHeight = document.body.offsetHeight;

    if (pageHeight - scrollBottom < 120) {
      alertBox.style.bottom = `${120 - (pageHeight - scrollBottom)}px`;
    } else {
      alertBox.style.bottom = '1rem';
    }
  };

  // ✅ direct forceren bij laden
  alertBox.style.position = "fixed";
  alertBox.style.bottom = "1rem";
  alertBox.style.left = "50%";
  alertBox.style.transform = "translateX(-50%)";
  alertBox.style.zIndex = "2000";

  // hercontrole na 0,5s
  setTimeout(() => {
    alertBox.style.position = "fixed";
    alertBox.style.bottom = "1rem";
    alertBox.style.left = "50%";
    alertBox.style.transform = "translateX(-50%)";
  }, 500);

  toggleFloating();
  window.addEventListener('scroll', toggleFloating, { passive: true });
  window.addEventListener('resize', () => {
    threshold = getThreshold();
    toggleFloating();
  });
});
// ✅ Fix: resterende uren-balk altijd onderaan direct bij laden
document.addEventListener("DOMContentLoaded", () => {
  const alertBox = document.getElementById("remainingHoursAlert");
  if (!alertBox) return;

  // Direct forceren
  alertBox.style.position = "fixed";
  alertBox.style.bottom = "1rem";
  alertBox.style.left = "50%";
  alertBox.style.transform = "translateX(-50%)";
  alertBox.style.zIndex = "2000";

  // Hercontrole na 0,5s (voor het geval DOM later rendert)
  setTimeout(() => {
    alertBox.style.position = "fixed";
    alertBox.style.bottom = "1rem";
    alertBox.style.left = "50%";
    alertBox.style.transform = "translateX(-50%)";
  }, 500);
});
// ➕ Helper: controleer of een shiftperiode overlapt met een maand
function monthOverlapsPeriod(year, month0, startISO, endISO) {
  const monthStart = new Date(year, month0, 1);
  const monthEnd   = new Date(year, month0 + 1, 0);
  const start = startISO ? new Date(startISO) : null;
  const end   = endISO   ? new Date(endISO)   : null;
  if (!start && !end) return true;
  const s = start || new Date('1900-01-01');
  const e = end   || new Date('9999-12-31');
  return !(e < monthStart || s > monthEnd);
}
// 🟡 Kleurt de dagen die al een shift hebben
function highlightPlannedDays(inst, plannedDates = []) {
  if (!inst || !inst.daysContainer) return;

  inst.daysContainer.querySelectorAll('.flatpickr-day').forEach(d => {
    if (!d.dateObj) return;
    const yyyy = d.dateObj.getFullYear();
    const mm   = String(d.dateObj.getMonth() + 1).padStart(2, '0');
    const dd   = String(d.dateObj.getDate()).padStart(2, '0');
    const dateStr = `${yyyy}-${mm}-${dd}`; 

    if (plannedDates.includes(dateStr)) {
      d.classList.add('planned-day');
    } else {
      d.classList.remove('planned-day');
    }
  });
}

// 📋 Vult de shift-selectielijst in de modal
document.getElementById('multiDayShiftBtn').addEventListener('click', () => {
  populateMultiDayShifts();
});
function populateMultiDayShifts(selectedDates = []) {
  const ud = getCurrentUserData();
  const sel = document.getElementById('multiShiftName');
  sel.innerHTML = '<option value="">Kies shift</option>';

  const all = ud.shifts || {};
  const order = ud.shiftOrder || Object.keys(all);

  order.forEach(name => {
    const sh = all[name];
    if (!sh) return;

    // toon shift als er GEEN periode is, of als ten minste één dag binnen de periode valt
    const match = !sh.startDate && !sh.endDate ||
      selectedDates.some(d => isDateWithin(d, sh.startDate || null, sh.endDate || null));

    if (match) {
      const o = document.createElement('option');
      o.value = name;
      o.textContent = name;
      sel.appendChild(o);
    }
  });
}

// 🔄 Kleurt de geplande dagen opnieuw na opslaan
async function refreshPlannedDays() {
  const year = Number(document.getElementById("yearSelectMain").value);
  const month = Number(document.getElementById("monthSelectMain").value);
  const ud = getCurrentUserData();
  const maandData = ud?.monthData?.[year]?.[month]?.rows || {};
  const plannedDates = Object.keys(maandData).filter(d => !!maandData[d]?.shift);

  if (window.multiDayPicker) {
    highlightPlannedDays(window.multiDayPicker, plannedDates);
  }
}

// --- Geeft alle ingeplande datums terug in ISO-formaat ---
function getPlannedDates() {
  const ud = getCurrentUserData();
  const y = Number(yearSelectMain.value);
  const m = Number(monthSelectMain.value);
  const md = ud.monthData?.[y]?.[m];
  if (!md || !md.rows) return [];
  const set = new Set();
  for (const [k, r] of Object.entries(md.rows)) {
    const base = k.split('#')[0]; // strip extra-lijn suffix
    const shiftName = (r?.shift || '').trim();
    if (shiftName && shiftName.toLowerCase() !== 'niet ingepland') {
      set.add(base);
    }
  }
  return [...set];
}

/* === Kalender voor invoer meerdere dagen === */
function initMultiDayPicker() {
  const year = Number(document.getElementById("yearSelectMain").value);
  const month = Number(document.getElementById("monthSelectMain").value);
  const start = new Date(year, month, 1);
  const end = new Date(year, month + 1, 0);

  if (window.multiDayPicker) window.multiDayPicker.destroy();

  const ud = getCurrentUserData();
  const maandData = ud?.monthData?.[year]?.[month]?.rows || {};
  const plannedDates = Object.keys(maandData).filter(d => !!maandData[d]?.shift);

  console.log("✅ Planned dates:", plannedDates);

window.multiDayPicker = flatpickr("#multiShiftDays", {
  mode: "multiple",
  dateFormat: "d-m-Y",
  altInput: true,
  altFormat: "d F Y",
  locale: flatpickr.l10ns.nl,
  weekNumbers: true,
  minDate: start,
  maxDate: end,
  disableMobile: false,
  defaultDate: [],

  // ✅ Eerste dag correct kleuren bij laden
onReady(_, __, inst) {
  setTimeout(() => highlightPlannedDays(inst, getPlannedDates()), 50);
},
onMonthChange(_, __, inst) {
  highlightPlannedDays(inst, getPlannedDates());
},
onChange(selectedDates) {
  const isoDates = selectedDates.map(d => {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;   // no toISOString()
  });
  populateMultiDayShifts(isoDates);
},
});
setTimeout(markPlannedDays, 100);

function markPlannedDays() {
  const ud = getCurrentUserData();
  const y = Number(yearSelectMain.value);
  const m = Number(monthSelectMain.value);
  const md = ud.monthData?.[y]?.[m] || {};
  const planned = Object.keys(md.rows || {}).filter(k => md.rows[k].shift);

  document.querySelectorAll('.calendar-day').forEach(dayEl => {
    const date = dayEl.dataset?.date;
    if (!date) return;
    if (planned.includes(date)) {
      dayEl.classList.add('planned-day');
    } else {
      dayEl.classList.remove('planned-day');
    }
  });
}
  // 🟡 extra aanroep om te garanderen dat dag 1 direct mee kleurt
  highlightPlannedDays(window.multiDayPicker, plannedDates);
}

/* === Eventlisteners === */

// 🟢 Open de modal
document.getElementById("multiDayShiftBtn")?.addEventListener("click", () => {
  const modal = new bootstrap.Modal(document.getElementById("multiDayModal"));
  modal.show();
  populateMultiDayShifts();
  setTimeout(initMultiDayPicker, 150);
});

// 💾 Opslaan van meerdere dagen
document.getElementById('saveMultiShift').addEventListener('click', async () => {
  try {
    const ud = getCurrentUserData();
    const dateInput = document.getElementById('multiShiftDays');
    const shiftSelect = document.getElementById('multiShiftName');

    const selectedShift = shiftSelect.value;
    if (!selectedShift) {
      toast('Kies eerst een shift', 'warning');
      return;
    }

  // flatpickr geeft comma-separated string terug → splits op ','
    const selectedDates = (dateInput.value || '')
      .split(',')
      .map(s => s.trim())
      .filter(Boolean)
      .map(disp => {
        // "d-m-Y" -> ISO zonder timezone-trucs
        const [dd, mm, yyyy] = disp.split('-').map(x => x.trim());
        return `${yyyy}-${mm}-${dd}`;
      });

    if (selectedDates.length === 0) {
      toast('Kies minstens één dag', 'warning');
      return;
    }

    const sh = ud.shifts[selectedShift];
    if (!sh) {
      toast('Shift niet gevonden', 'danger');
      return;
    }

    // wegschrijven
    for (const iso of selectedDates) {
      const [yStr, mStr] = iso.split('-');
      const y = Number(yStr);
      const m = Number(mStr) - 1;

      ud.monthData ||= {};
      ud.monthData[y] ||= {};
      ud.monthData[y][m] ||= { targetHours: 0, targetMinutes: 0, rows: {} };

      // project auto
      let project = sh.project || '';
      const sp = autoProjectForShift(selectedShift);
      if (sp) {
        ensureProjectExists(sp);
        project = sp;
      }

      const minutes = minutesBetween(sh.start, sh.end, sh.break);

      ud.monthData[y][m].rows[iso] = {
        project,
        shift: selectedShift,
        start: sh.start,
        end: sh.end,
        break: sh.break,
        omschrijving: '',
        minutes
      };
    }

    await saveUserData();

    // UI refresh
    const curY = Number(yearSelectMain.value);
    const curM = Number(monthSelectMain.value);
    await renderMonth(curY, curM);
    updateInputTotals();
    renderHistory();

    // kalender-highlights (veilig, zonder await)
    if (window.multiDayPicker) {
      highlightPlannedDays(window.multiDayPicker, getPlannedDates());
    }

    // ✅ eerst toast tonen...
    toast('Shiften toegevoegd', 'success');

    // ...dán modal sluiten (met fallback als getInstance null is)
    const modalEl = document.getElementById('multiDayModal');
    (bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl)).hide();

  } catch (err) {
    console.error(err);
    toast('Er ging iets mis bij opslaan', 'danger');
  }
});
 console.log("Planned dates:", plannedDates);
// 🧩 Functie om direct 1 dag op de kalender te updaten
function updateCalendarDay(date, shiftName) {
  // Zoek het cel-element dat overeenkomt met deze datum
  const cell = document.querySelector(`[data-date="${date}"]`);
  if (!cell) return;

  // Shift-informatie ophalen (kleur + label)
  const ud = getCurrentUserData();
  const shiftColor = ud.shiftColors?.[shiftName] || "#6c757d"; // grijs fallback

  // Update visuele weergave
  cell.classList.add("has-shift");
  cell.style.backgroundColor = shiftColor;
  cell.style.color = "#fff";
  cell.dataset.shift = shiftName;
  cell.innerHTML = `
    <div class="shift-label">${shiftName}</div>
    <div class="shift-date">${new Date(date).getDate()}</div>
  `;
}
// Verwijder grijze overlay als die per ongeluk blijft staan
document.getElementById('multiDayModal').addEventListener('hidden.bs.modal', () => {
  document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
  document.body.classList.remove('modal-open');
  document.body.style.removeProperty('overflow');
});
// User: Indienen
document.getElementById('submitMonthBtn')?.addEventListener('click', async () => {
  const y = Number(yearSelectMain.value);
  const m = Number(monthSelectMain.value);
  const status = getMonthStatus(y,m);
  if (status === 'approved') return toast('Maand is al goedgekeurd', 'info');
  if (status === 'submitted') return toast('Maand is al ingediend', 'info');

  await setMonthStatus(y, m, 'submitted');
  toast('Maand ingediend ter goedkeuring', 'success');

  // ✉️ Mail naar admins + bevestiging naar user
  const ud = getCurrentUserData();
  const who = ud.name || ud.email || currentUserId;
  const subject = `[Planner] Ingediend — ${who} — ${monthsFull[m]} ${y}`;
  const bodyAdmin = `${who} heeft zojuist ${monthsFull[m]} ${y} ingediend.\n\nOpen Admin > Goedkeuring maand om te beoordelen.`;
  await broadcastToAdmins(subject, bodyAdmin, 'status');

  const bodyUser = `Je hebt ${monthsFull[m]} ${y} ingediend ter goedkeuring.\nJe ontvangt een bericht zodra dit is beoordeeld.`;
  await sendSystemMail(getActiveUserId(), `[Bevestiging] Planner ingediend — ${monthsFull[m]} ${y}`, bodyUser, 'status');
});

// Admin jaarveld default
document.getElementById('adminMultiYear')?.addEventListener('focus', e => {
  if (!e.target.value) e.target.value = new Date().getFullYear();
});
// Admin jaarveld default
document.getElementById('adminApproveYear')?.addEventListener('focus', e => {
  if (!e.target.value) e.target.value = new Date().getFullYear();
});

// Admin: Keur goed
document.getElementById('adminApproveBtn')?.addEventListener('click', async () => {
  const uid = adminUserSelect?.value || getActiveUserId();
  if (!uid) return toast('Geen gebruiker gekozen', 'warning');
  const y = Number(document.getElementById('adminApproveYear').value || new Date().getFullYear());
  const m = Number(document.getElementById('adminApproveMonth').value || 0);
  const prev = dataStore.viewUserId;
  dataStore.viewUserId = uid;
  await setMonthStatus(y, m, 'approved');
  toast(`Goedgekeurd: ${monthsFull[m]} ${y}`, 'success');
  dataStore.viewUserId = prev;

  // ✉️ Mail naar user
  const uSnap = await getDoc(doc(db,'users', uid));
  const u = uSnap.data();
  const subject = `[Planner] Goedgekeurd — ${monthsFull[m]} ${y}`;
  const body = `Je planner voor ${monthsFull[m]} ${y} werd goedgekeurd.`;
  await sendSystemMail(uid, subject, body, 'status');

  if (getActiveUserId() === currentUserId && y===Number(yearSelectMain.value) && m===Number(monthSelectMain.value)) {
    renderMonth(y, m);
  }
});

// Admin: Keur af
document.getElementById('adminRejectBtn')?.addEventListener('click', async () => {
  const uid = adminUserSelect?.value || getActiveUserId();
  if (!uid) return toast('Geen gebruiker gekozen', 'warning');
  const y = Number(document.getElementById('adminApproveYear').value || new Date().getFullYear());
  const m = Number(document.getElementById('adminApproveMonth').value || 0);

  // ➕ Vraag om commentaar (optioneel)
  const comment = prompt('Commentaar voor de gebruiker (optioneel):', '');

  const prev = dataStore.viewUserId;
  dataStore.viewUserId = uid;
  await setMonthStatus(y, m, 'rejected');
  toast(`Afgekeurd: ${monthsFull[m]} ${y}`, 'warning');
  dataStore.viewUserId = prev;

  // ✉️ Mail naar user met commentaar
  const subject = `[Planner] Afgekeurd — ${monthsFull[m]} ${y}`;
  const body = `Je planner voor ${monthsFull[m]} ${y} werd afgekeurd.${comment ? `\n\nReden:\n${comment}` : ''}`;
  await sendSystemMail(uid, subject, body, 'status');

  if (getActiveUserId() === currentUserId && y===Number(yearSelectMain.value) && m===Number(monthSelectMain.value)) {
    renderMonth(y, m);
  }
});

// Admin: Heropenen (ontgrendelen)
document.getElementById('adminReopenBtn')?.addEventListener('click', async () => {
  const uid = adminUserSelect?.value || getActiveUserId();
  if (!uid) return toast('Geen gebruiker gekozen', 'warning');
  const y = Number(document.getElementById('adminApproveYear').value || new Date().getFullYear());
  const m = Number(document.getElementById('adminApproveMonth').value || 0);
  const prev = dataStore.viewUserId;
  dataStore.viewUserId = uid;
  await setMonthStatus(y, m, 'draft');
  toast(`Heropend: ${monthsFull[m]} ${y}`, 'info');
  dataStore.viewUserId = prev;
  if (getActiveUserId() === currentUserId &&
      y === Number(yearSelectMain.value) &&
      m === Number(monthSelectMain.value)) {
    renderMonth(y, m);
  }
});
function renderAdminMonthlyMulti(){
  const yInput   = document.getElementById('adminMultiYear');
  const mSelect  = document.getElementById('adminMultiMonth');
  const allowBox = document.getElementById('adminMultiAllow');
  if (!yInput || !mSelect || !allowBox) return;

  const uid = adminUserSelect?.value || getActiveUserId();
  if (!uid){
    allowBox.checked = false;
    allowBox.disabled = true;
    return;
  }

  const prev = dataStore.viewUserId;
  dataStore.viewUserId = uid;
  const ud = getCurrentUserData();
  ensureUserMonthlyMap(ud);

  if (!yInput.value)   yInput.value = new Date().getFullYear();
  if (!mSelect.value)  mSelect.value = String(new Date().getMonth());

  const y = Number(yInput.value);
  const m = Number(mSelect.value);
  allowBox.disabled = false;
  allowBox.checked  = userAllowsMultiMonth(ud, y, m);

  yInput.onchange = () => renderAdminMonthlyMulti();
  mSelect.onchange = () => renderAdminMonthlyMulti();
  allowBox.onchange = async () => {
    const key = `${yInput.value}-${String(Number(mSelect.value)+1).padStart(2,'0')}`;
    if (allowBox.checked) ud.settings.multiByMonth[key] = true;
    else delete ud.settings.multiByMonth[key];
    await saveUserData();

    // herteken als het de zichtbare maand is
    if (getActiveUserId() === uid &&
        Number(yearSelectMain.value) === Number(yInput.value) &&
        Number(monthSelectMain.value) === Number(mSelect.value)) {
      renderMonth(Number(yInput.value), Number(mSelect.value));
    }
    toast(`Extra lijnen: ${allowBox.checked ? 'toegestaan' : 'uitgezet'} voor ${key}`, 'success');
  };

  dataStore.viewUserId = prev;
}
// aanroepen bij wisselen admin user
adminUserSelect?.addEventListener('change', renderAdminMonthlyMulti);
function renderProjectSummary() 
{
  const y = Number(yearSelectMain.value);
  const m = Number(monthSelectMain.value);
  const ud = getCurrentUserData();
  const md = ud.monthData?.[y]?.[m];
  const wrap = document.getElementById('projectSummary');
  if (!wrap) return;

  if (!md || !md.rows || !Object.keys(md.rows).length) {
    wrap.innerHTML = '<div class="alert alert-light border small mb-0">Geen data in deze maand.</div>';
    return;
  }

  const filterProject = projectFilterSelect.value || '';
  const perProject = {};
  for (const r of Object.values(md.rows)) {
    if (!r) continue;
    const p = (r.project || '—');
    if (filterProject && p !== filterProject) continue;
    perProject[p] = (perProject[p] || 0) + (r.minutes || 0);
  }

  const cards = Object.entries(perProject)
    .sort((a,b)=> b[1]-a[1])
    .map(([name, minutes]) => {
      const h = Math.floor(minutes/60), min = minutes%60;
      return `
        <div class="project-mini">
          <div class="title">${name}</div>
          <div class="meta">Totaal in maand</div>
          <div class="value">${h}u ${min}m</div>
        </div>`;
    });

  wrap.innerHTML = cards.length
    ? cards.join('')
    : '<div class="alert alert-light border small mb-0">Geen projecten voor huidig filter.</div>';
}
function minutesToHM(min){ return `${Math.floor(min/60)}u ${min%60}m`; }
// Helpers
function isSchoolLeaveEnabledFor(uid) {
  const prev = dataStore.viewUserId; dataStore.viewUserId = uid;
  const ud = getCurrentUserData();
  dataStore.viewUserId = prev;
  return ud?.settings?.schoolLeaveEnabled !== false; // default true
}
function applySchoolLeaveVisibility() {
  const uid = adminUserSelect?.value || getActiveUserId();
  const on  = isSchoolLeaveEnabledFor(uid);

  // Home badge
  const homeSch = document.getElementById('homeSchoolLeave');
  if (homeSch) homeSch.closest('span').style.display = on ? '' : 'none';

  // Invoer badge
  const invBadge = document.getElementById('schoolLeaveBalanceBadge');
  if (invBadge) invBadge.style.display = on ? '' : 'none';

  // Historiek: kolom "Schoolverlof" (7e kolom in jouw tabel)
  const ths = document.querySelectorAll('#tab-historiek thead th');
  const idx = 6; // 0-based: Maand(0), Doel(1), Gepland(2), Verschil(3), Verlof(4), Ziekte(5), Schoolverlof(6)...
  if (ths[idx]) ths[idx].classList.toggle('d-none', !on);
  document.querySelectorAll('#tab-historiek tbody tr').forEach(tr => {
    const td = tr.children[idx]; if (td) td.classList.toggle('d-none', !on);
  });
  const tf = document.querySelectorAll('#tab-historiek tfoot th')[idx];
  if (tf) tf.classList.toggle('d-none', !on);
}

// Admin: bij user-select en bij laden
document.getElementById('adminUserSelect')?.addEventListener('change', hydrateSchoolLeaveToggle);
document.querySelector('a[href="#tab-admin"]')?.addEventListener('shown.bs.tab', hydrateSchoolLeaveToggle);

function hydrateSchoolLeaveToggle() {
  const uid = adminUserSelect?.value || getActiveUserId();
  const chk = document.getElementById('adminSchoolLeaveEnabled');
  if (!chk || !uid) return;

  chk.checked = isSchoolLeaveEnabledFor(uid);
  applySchoolLeaveVisibility();

  chk.onchange = async () => {
    const prev = dataStore.viewUserId; dataStore.viewUserId = uid;
    const ud = getCurrentUserData(); ud.settings ||= {};
    ud.settings.schoolLeaveEnabled = !!chk.checked;
    await saveUserData();
    dataStore.viewUserId = prev;

    applySchoolLeaveVisibility();
    // ook invoer/hertekenen (filters) en badges
    renderMonth(Number(yearSelectMain.value), Number(monthSelectMain.value));
    updateLeaveBadges();
    renderHistory();
    toast(`Schoolverlof ${chk.checked ? 'ingeschakeld' : 'verborgen'}`, 'success');
  };
}
/***** ========== MAILBOX — COMPLETE ========== *****/
const mailListBody    = document.getElementById('mailListBody');
const mailDetail      = document.getElementById('mailDetail');
const mailRefreshBtn  = document.getElementById('mailRefreshBtn');
const mailComposeBtn  = document.getElementById('mailComposeBtn');
const mailComposeCard = document.getElementById('mailComposeCard');
const mailToSelect    = document.getElementById('mailToSelect');
const mailSubjectInput= document.getElementById('mailSubjectInput');
const mailBodyInput   = document.getElementById('mailBodyInput');
const mailSendBtn     = document.getElementById('mailSendBtn');
const mailCancelBtn   = document.getElementById('mailCancelBtn');
const mailUnreadBadge = document.getElementById('mailUnreadBadge');
const mailSidebarBadge= document.getElementById('mailSidebarBadge');
const mailFolderNav   = document.getElementById('mailFolderNav');

let mailboxUnsub = null;
let mailboxCache = [];      // alle berichten (snapshot)
let mailFolder   = 'inbox'; // 'inbox' | 'sent'
let composeThreadId = null; // reply flow
let mailUIBound = false;

/* ---------- helpers ---------- */
function normTs(ts){
  if (!ts) return '';
  if (typeof ts?.toDate === 'function') return ts.toDate().toISOString();
  if (typeof ts === 'string') return ts;
  return '';
}
function formatWhen(ts){
  if (!ts) return '';
  try { return new Date(ts).toLocaleString('nl-BE'); } catch { return ''; }
}
function updateUnreadBadges(unread) {
  const n = Math.max(0, Number(unread) || 0);
  [mailUnreadBadge, mailSidebarBadge].forEach(badge => {
    if (!badge) return;
    if (n > 0) { badge.textContent = n; badge.classList.remove('d-none'); }
    else       { badge.classList.add('d-none'); }
  });
}

/* ---------- mailbox listen ---------- */
function listenMailbox(uid) {
  if (mailboxUnsub) mailboxUnsub();
  const colRef = collection(db,'users', uid, 'mailbox');
  const qy = query(colRef, orderBy('timestamp','desc'), limit(200));
  mailboxUnsub = onSnapshot(qy, (snap) => {
    mailboxCache = snap.docs.map(d => ({ _id:d.id, ...d.data(), _tsIso: normTs(d.data().timestamp) }));
    renderMailList();
  });
}

/* ---------- compose ---------- */
function isAdmin() {
  const me = dataStore.users[getActiveUserId()];
  return (me?.role || 'user') === 'admin';
}
function prepareComposeOptions() {
  mailToSelect.innerHTML = '';
  if (isAdmin()) {
    // admin → kies user (excl admins)
    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.textContent = 'Kies gebruiker…';
    mailToSelect.appendChild(opt0);
    Object.entries(dataStore.users).forEach(([uid,u]) => {
      if ((u.role || 'user') === 'admin') return;
      const o = document.createElement('option');
      o.value = `user:${uid}`; o.textContent = u.name || u.email || uid;
      mailToSelect.appendChild(o);
    });
  } else {
    // user → admins
    const o = document.createElement('option');
    o.value = 'admin-group'; o.textContent = 'Admins';
    mailToSelect.appendChild(o);
  }
}
function prepareComposeToCounterparty(m) {
  prepareComposeOptions();
  if (isAdmin()) {
    mailToSelect.value = `user:${m.from?.uid || ''}`;
  } else {
    mailToSelect.value = 'admin-group';
  }
  mailSubjectInput.value = m.subject?.startsWith('Re: ') ? m.subject : `Re: ${m.subject || ''}`;
  mailBodyInput.value = '';
  composeThreadId = m.threadId || `conv:${m.from?.uid || getActiveUserId()}`;
}

/* ---------- send helpers ---------- */
async function sendSystemMail(uid, subject, body, kind = "notification", threadId = `sys:${Date.now()}`) {
  await addDoc(collection(db, "users", uid, "mailbox"), {
    threadId,
    system: true,
    kind,
    from: { uid: "noreply", name: "Shift Planner", role: "system", email: "no-reply@local" },
    to:   { type: "user", uid },
    subject,
    body,
    read: false,
    timestamp: serverTimestamp()
  });
}

async function sendUserMessageToAdmins(subject, body, threadId=`conv:${getActiveUserId()}`) {
  const meUid = getActiveUserId();
  const me = dataStore.users[meUid];
  const meName = me?.name || me?.email || meUid;

  // kopie in eigen mailbox (als 'verzonden')
  await addDoc(collection(db, 'users', meUid, 'mailbox'), {
    threadId, system:false, kind:'message',
    from:{ uid: meUid, name: meName, role:'user' },
    to:{ type:'admin-group' },
    subject, body, read:true,
    timestamp: serverTimestamp()
  });

  // fan-out naar admins
  const qAdmins = query(collection(db, 'users'), where('role','==','admin'));
  const snap = await getDocs(qAdmins);
  await Promise.all(snap.docs.map(a =>
    addDoc(collection(db, 'users', a.id, 'mailbox'), {
      threadId, system:false, kind:'message',
      from:{ uid: meUid, name: meName, role:'user' },
      to:{ type:'user', uid: a.id },
      subject, body, read:false,
      timestamp: serverTimestamp()
    })
  ));
}

async function sendAdminReplyToUser(adminUid, userUid, subject, body) {
  const admin = dataStore.users[adminUid];
  const user  = dataStore.users[userUid];
  const threadId = `conv:${userUid}`;

  // kopie in admin mailbox
  await addDoc(collection(db,'users', adminUid, 'mailbox'), {
    threadId, system:false, kind:'message',
    from: { uid:adminUid, name: admin?.name || admin?.email || 'Admin', role:'admin' },
    to:   { type:'user-id', uid:userUid },
    subject, body, read:true, timestamp: serverTimestamp()
  });

  // naar de user
  await addDoc(collection(db,'users', userUid, 'mailbox'), {
    threadId, system:false, kind:'message',
    from: { uid:adminUid, name: admin?.name || admin?.email || 'Admin', role:'admin' },
    to:   { type:'user', uid:userUid },
    subject, body, read:false, timestamp: serverTimestamp()
  });
}

/* ---------- actions ---------- */
async function markMailRead(messageId, val = true) {
  const uid = getActiveUserId();
  await updateDoc(doc(db, 'users', uid, 'mailbox', messageId), { read: !!val });
  const m = mailboxCache.find(x => x._id === messageId);
  if (m) m.read = !!val;
  renderMailList();
}
async function deleteMail(messageId) {
  const uid = getActiveUserId();
  await deleteDoc(doc(db, 'users', uid, 'mailbox', messageId));
  mailboxCache = mailboxCache.filter(x => x._id !== messageId);
  renderMailList();
  if (mailDetail.dataset?.openId === messageId) {
    mailDetail.innerHTML = '<div class="text-muted small">Selecteer een bericht…</div>';
    delete mailDetail.dataset.openId;
  }
}

/* ---------- render ---------- */
function filteredMessages() {
  const uid = getActiveUserId();
  const items = mailboxCache
    .slice()
    .sort((a,b)=> (b._tsIso||'').localeCompare(a._tsIso||''));

  if (mailFolder === 'sent') {
    // verzonden = door mij (niet system)
    return items.filter(m => (m.from?.uid === uid) && !m.system);
  }
  // inbox = alles dat NIET door mij is gestuurd óf system
  return items.filter(m => (m.from?.uid !== uid) || m.system);
}

function renderMailList() {
  const msgs = filteredMessages();
  mailListBody.innerHTML = '';

  let unread = 0;
  msgs.forEach(m => { if (!m.read && mailFolder === 'inbox') unread++; });

  updateUnreadBadges(unread);

  msgs.forEach(m => {
    const fromName = m.system ? 'Shift Planner (noreply)' : (m.from?.name || m.from?.email || '—');
    const tr = document.createElement('tr');
    tr.className = m.read ? '' : 'fw-semibold';
    tr.innerHTML = `
      <td>${fromName}</td>
      <td><a href="#" class="js-open" data-id="${m._id}">${m.subject || '(geen onderwerp)'}</a></td>
      <td class="text-end"><span class="mail-meta">${formatWhen(m._tsIso)}</span></td>
      <td class="text-end">
        <button class="btn btn-sm ${m.read ? 'btn-outline-secondary' : 'btn-outline-primary'} me-1 js-toggle" data-id="${m._id}">
          ${m.read ? 'Ongelezen' : 'Gelezen'}
        </button>
        <button class="btn btn-sm btn-outline-danger js-del" data-id="${m._id}">
          <span class="material-icons-outlined" style="font-size:16px">delete</span>
        </button>
      </td>
    `;
    mailListBody.appendChild(tr);
  });
}

function openMail(m) {
  if (!m) return;
  if (!m.read) { markMailRead(m._id, true); m.read = true; }

  const fromName = m.system ? 'Shift Planner (noreply)' : (m.from?.name || m.from?.email || '—');
  const actions = `
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary btn-sm js-mark-unread" data-id="${m._id}">Markeer ongelezen</button>
      <button class="btn btn-outline-danger btn-sm js-del" data-id="${m._id}">
        <span class="material-icons-outlined" style="font-size:16px">delete</span>
      </button>
      ${m.system ? '' : '<button class="btn btn-outline-primary btn-sm js-reply" data-id="'+m._id+'"><span class="material-icons-outlined">reply</span> Antwoorden</button>'}
    </div>`;

  mailDetail.innerHTML = `
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <div class="fw-semibold">${m.subject || '(geen onderwerp)'}</div>
        <div class="mail-meta">Van: ${fromName} • ${formatWhen(m._tsIso)}</div>
      </div>
      ${actions}
    </div>
    <hr class="my-2">
    <div style="white-space:pre-wrap">${m.body || ''}</div>
  `;
  mailDetail.dataset.openId = m._id;
}

/* ---------- once-only UI binding ---------- */
function bindMailboxUIOnce() {
  if (mailUIBound) return;
  mailUIBound = true;

  // Folder switch
  mailFolderNav?.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-folder]');
    if (!btn) return;
    mailFolder = btn.dataset.folder;
    mailFolderNav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderMailList();
    mailDetail.innerHTML = '<div class="text-muted small">Selecteer een bericht…</div>';
  });

  // Compose
  mailComposeBtn?.addEventListener('click', () => {
    mailComposeCard.classList.toggle('d-none');
    if (!mailComposeCard.classList.contains('d-none')) {
      prepareComposeOptions();
      mailSubjectInput.value = '';
      mailBodyInput.value    = '';
      composeThreadId = null;
    }
  });
  mailCancelBtn?.addEventListener('click', () => {
    mailComposeCard.classList.add('d-none');
    composeThreadId = null;
  });
  mailSendBtn?.addEventListener('click', async () => {
    const toVal   = mailToSelect.value;
    const subject = (mailSubjectInput.value || '').trim();
    const body    = (mailBodyInput.value || '').trim();
    if (!toVal || !subject || !body) return toast('Vul aan: geadresseerde, onderwerp en bericht', 'warning');

    const meUid = getActiveUserId();
    try {
      if (isAdmin()) {
        const userUid = toVal.startsWith('user:') ? toVal.split(':')[1] : null;
        if (!userUid) return toast('Kies gebruiker', 'warning');
        await sendAdminReplyToUser(meUid, userUid, subject, body);
        toast('Bericht verzonden aan gebruiker', 'success');
      } else {
        await sendUserMessageToAdmins(subject, body, composeThreadId || `conv:${meUid}`);
        toast('Bericht verzonden aan admins', 'success');
      }
      mailComposeCard.classList.add('d-none');
      composeThreadId = null;
    } catch (e) {
      console.error(e);
      toast('Versturen mislukt', 'danger');
    }
  });

  // Refresh
  mailRefreshBtn?.addEventListener('click', () => {
    const uid = getActiveUserId();
    if (uid) listenMailbox(uid);
  });

  // Lijst actions (delegation, één listener)
  mailListBody?.addEventListener('click', async (e) => {
    const aOpen = e.target.closest('a.js-open');
    const bTog  = e.target.closest('button.js-toggle');
    const bDel  = e.target.closest('button.js-del');
    if (aOpen) {
      e.preventDefault();
      const msg = filteredMessages().find(x => x._id === aOpen.dataset.id)
               || mailboxCache.find(x => x._id === aOpen.dataset.id);
      if (msg) openMail(msg);
      return;
    }
    if (bTog) {
      const id = bTog.dataset.id;
      const msg = mailboxCache.find(x => x._id === id);
      await markMailRead(id, !(msg?.read));
      return;
    }
    if (bDel) {
      const id = bDel.dataset.id;
      if (!confirm('Dit bericht verwijderen?')) return;
      await deleteMail(id);
      toast('Bericht verwijderd', 'success');
      return;
    }
  });

  // Detail actions (delegation)
  mailDetail?.addEventListener('click', (e) => {
    const markUn = e.target.closest('.js-mark-unread');
    const delBtn = e.target.closest('.js-del');
    const reply  = e.target.closest('.js-reply');

    if (markUn) {
      const id = markUn.dataset.id;
      markMailRead(id, false);
      toast('Gemarkeerd als ongelezen', 'success');
      return;
    }
    if (delBtn) {
      const id = delBtn.dataset.id;
      if (!confirm('Dit bericht verwijderen?')) return;
      deleteMail(id).then(()=> toast('Bericht verwijderd', 'success'));
      return;
    }
    if (reply) {
      const id = reply.dataset.id;
      const msg = mailboxCache.find(x => x._id === id);
      if (!msg) return;
      mailComposeCard.classList.remove('d-none');
      prepareComposeToCounterparty(msg);
      window.scrollTo({ top: mailComposeCard.offsetTop - 80, behavior: 'smooth' });
      return;
    }
  });
}

/* ---------- init on tab show ---------- */
document.querySelector('a[href="#tab-mail"]')?.addEventListener('shown.bs.tab', () => {
  bindMailboxUIOnce();
  const uid = getActiveUserId();
  if (uid) listenMailbox(uid);
});

// ook starten na login
onAuthStateChanged(auth, (user) => {
  if (!user) return;
  bindMailboxUIOnce();
  listenMailbox(user.uid);
});
/***** ========== /MAILBOX ========== *****/

  </script>
<!-- 🔄 Loading overlay -->
<div id="loadingOverlay" class="loading-overlay d-none">
  <div class="spinner-border text-light" role="status">
    <span class="visually-hidden">Laden...</span>
  </div>
</div>  
</body>
</html>
