<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shift Planner ‚Äî Dashboard</title>
<!-- ===== Favicons for all devices ===== -->
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="favicon-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="favicon-512x512.png">
<link rel="shortcut icon" href="favicon.ico">

<!-- Apple (iPhone/iPad) -->
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png">
<link rel="apple-touch-icon-precomposed" href="apple-touch-icon-180x180.png">

<!-- Android/Chrome Web App -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">

<!-- Windows -->
<meta name="msapplication-TileImage" content="favicon-192x192.png">
<meta name="msapplication-TileColor" content="#0d6efd">
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />

  <style>
    :root {
      --sp-sidebar-w: 260px;
      --sp-sidebar-w-collapsed: 78px;
    }
    body { background: #f5f7fb; }
    /* Sidebar */
    .sp-sidebar {
      position: fixed; inset: 0 auto 0 0;
      width: var(--sp-sidebar-w); background: #0d6efd; color: #fff;
      padding-top: 64px; transition: width .25s ease, left .25s ease;
      z-index: 1031;
    }
    .sp-sidebar.collapsed { width: var(--sp-sidebar-w-collapsed); }
    .sp-sidebar .nav-link {
      color: #fff; display: flex; align-items: center; gap: 10px; padding: 10px 16px;
      border-radius: .375rem; margin: 2px 10px;
    }
    .sp-sidebar .nav-link.active, .sp-sidebar .nav-link:hover { background: rgba(255,255,255,.18); }
    .sp-sidebar .label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sp-sidebar.collapsed .label { display: none; }

    /* Topbar */
    .sp-topbar { position: fixed; top: 0; left: 0; right: 0; height: 64px; background: #fff; border-bottom: 1px solid #e9edf5; z-index: 1032; }

    /* Main content */
    .sp-main { padding: 86px 20px 24px; margin-left: var(--sp-sidebar-w); transition: margin-left .25s ease; }
    .sp-main.collapsed { margin-left: var(--sp-sidebar-w-collapsed); }

    /* Mobile: sidebar overlay */
    @media (max-width: 768px) {
      .sp-sidebar { left: -100%; }
      .sp-sidebar.show { left: 0; }
      .sp-main, .sp-main.collapsed { margin-left: 0; }
    }

    .table-nowrap td, .table-nowrap th { white-space: nowrap; }
    .text-mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .chip {display:inline-flex;align-items:center;gap:6px;padding:.25rem .5rem;border-radius:999px;background:#eef4ff;color:#0d6efd;font-size:.8rem}
    .chip .dot{width:.5rem;height:.5rem;border-radius:50%;background:#0d6efd}
.drag-handle:hover { color: #0d6efd; transform: scale(1.15); }
.sortable-chosen { background-color: #f0f8ff !important; }
.sortable-ghost { opacity: 0.6; }
#quickTopBtn {
  border-color: #fd7e14 !important;   /* zachter oranje */
  color: #fd7e14 !important;
  transition: all .15s ease;
}

#quickTopBtn:hover {
  background-color: #fd7e14 !important;
  color: #fff !important;
  transform: scale(1.05);
}
@media (max-width: 768px) {
  #exportPdfBtn {
    font-size: 0.9rem;
    padding: 6px 10px;
  }
}
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside id="sidebar" class="sp-sidebar">
    <div class="px-3 mb-3">
      <div class="d-flex align-items-center gap-2 ps-2">
        <span class="material-icons-outlined">event_note</span>
        <strong class="label">Shift Planner</strong>
      </div>
    </div>
    <nav class="nav flex-column" id="navTabs">
      <a class="nav-link active" data-bs-toggle="tab" href="#tab-shifts">
        <span class="material-icons-outlined">schedule</span> <span class="label">Shifts</span>
      </a>
      <a class="nav-link" data-bs-toggle="tab" href="#tab-invoer">
        <span class="material-icons-outlined">list_alt</span> <span class="label">Invoer</span>
      </a>
      <a class="nav-link" data-bs-toggle="tab" href="#tab-historiek">
        <span class="material-icons-outlined">query_stats</span> <span class="label">Historiek</span>
      </a>
      <a class="nav-link" data-bs-toggle="tab" href="#tab-converter">
        <span class="material-icons-outlined">calculate</span> <span class="label">Converter</span>
      </a>
      <a class="nav-link d-none" id="adminTabBtn" data-bs-toggle="tab" href="#tab-admin">
        <span class="material-icons-outlined">admin_panel_settings</span> <span class="label">Admin</span>
      </a>
    </nav>
  </aside>

  <!-- Topbar -->
  <nav class="sp-topbar">
    <div class="container-fluid h-100 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
  <button id="sidebarToggle" class="btn btn-outline-primary btn-sm d-none d-md-inline-flex">
    <span class="material-icons-outlined">menu_open</span>
  </button>
  <button id="sidebarMobile" class="btn btn-outline-primary btn-sm d-inline-flex d-md-none">
    <span class="material-icons-outlined">menu</span>
  </button>

  <!-- ‚úÖ Nieuw: Snelle invoer-knop -->
  <button id="quickTopBtn" class="btn btn-outline-warning btn-sm d-flex align-items-center gap-1" data-bs-toggle="modal" data-bs-target="#quickModal">
    <span class="material-icons-outlined">event</span> 
    <span class="d-none d-sm-inline">Snelle invoer</span>
  </button>

  <div class="chip d-none d-sm-inline-flex"><span class="dot"></span> <span id="envBadge">Online</span></div>
</div>

      <div class="d-flex align-items-center gap-3">
        <span class="text-secondary small">Ingelogd als <strong id="currentUserName">-</strong></span>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">
          <span class="material-icons-outlined">logout</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main id="main" class="sp-main">
    <div class="tab-content">

      <!-- SHIFTS -->
      <section id="tab-shifts" class="tab-pane fade show active">
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Shifts</h5>
          <div class="d-flex flex-wrap gap-2">
            <select id="filterShiftYear" class="form-select form-select-sm"></select>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#shiftModal">
              <span class="material-icons-outlined">add</span> Nieuwe shift
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle table-nowrap">
            <thead class="table-light">
              <tr>
                <th>Naam</th><th>Start</th><th>Einde</th><th>Pauze (min)</th><th>Project</th><th>Periode</th><th class="text-end">Acties</th>
              </tr>
            </thead>
            <tbody id="shiftTableBody"></tbody>
          </table>
        </div>

        <div class="alert alert-info small">
          Tip: je kan de volgorde bewaren via de ‚Äúvolgorde opslaan‚Äù-knop (drag & drop is browser-afhankelijk in tabellen; alternatief: gebruik sorteerknoppen).
        </div>
      </section>

      <!-- INVOER -->
      <section id="tab-invoer" class="tab-pane fade">
        <div class="d-flex justify-content-between align-items-center mb-3">
  <div class="row g-2 align-items-center mb-3">
  <div class="col-12 col-md-auto d-flex flex-wrap gap-2">
    <select id="monthSelectMain" class="form-select form-select-sm w-auto flex-fill flex-md-grow-0">
      <option value="0">Januari</option>
      <option value="1">Februari</option>
      <option value="2">Maart</option>
      <option value="3">April</option>
      <option value="4">Mei</option>
      <option value="5">Juni</option>
      <option value="6">Juli</option>
      <option value="7">Augustus</option>
      <option value="8">September</option>
      <option value="9">Oktober</option>
      <option value="10">November</option>
      <option value="11">December</option>
    </select>

    <select id="yearSelectMain" class="form-select form-select-sm w-auto flex-fill flex-md-grow-0"></select>
    <select id="projectFilterSelect" class="form-select form-select-sm w-auto flex-fill flex-md-grow-0">
      <option value="">Alle projecten</option>
    </select>
  </div>

  <div class="col-12 col-md-auto mt-2 mt-md-0">
    <button id="exportPdfBtn" class="btn btn-outline-danger btn-sm w-100 w-md-auto">
      <i class="bi bi-file-earmark-pdf me-1"></i> Export PDF
    </button>
  </div>
</div>

        <div class="row g-3 mb-3">
          <div class="col-6 col-md-2">
            <label class="form-label">Doel uren</label>
            <input id="monthTargetHours" type="number" min="0" value="0" class="form-control form-control-sm" />
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">Doel min</label>
            <input id="monthTargetMinutes" type="number" min="0" value="0" class="form-control form-control-sm" />
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle table-nowrap">
            <thead class="table-light">
              <tr>
                <th>Dag</th><th>Datum</th><th>Project</th><th>Shift</th><th>Start</th><th>Einde</th><th>Pauze</th><th>Omschrijving</th><th>Duur</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-sm-4"><strong>Doel totaal:</strong> <span id="inputTotDoel" class="text-mono">0u 0min</span></div>
          <div class="col-sm-4"><strong>Totaal uren:</strong> <span id="inputTotGepland" class="text-mono">0u 0min</span></div>
          <div class="col-sm-4"><strong>Verschil:</strong> <span id="inputTotVerschil" class="text-mono">0u 0min</span></div>
        </div>
      </section>

      <!-- HISTORIEK -->
      <section id="tab-historiek" class="tab-pane fade">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Historiek ‚Äî <span id="currentUserHistoriek">-</span> ‚Äî Jaar: <span id="historiekJaar"></span></h5>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle table-nowrap">
            <thead class="table-light">
              <tr>
                <th>Maand</th><th>Doel uren</th><th>Gepland</th><th>Verschil</th>
                <th>Verlof</th><th>Ziekte</th><th>Schoolverlof</th><th>Feestdag</th><th>Bench</th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
            <tfoot class="table-light">
              <tr>
                <th>Totaal</th>
                <th id="totDoel">0u 0min</th>
                <th id="totGepland">0u 0min</th>
                <th id="totVerschil">0u 0min</th>
                <th id="totVerlof">0u 0min</th>
                <th id="totZiekte">0u 0min</th>
                <th id="totSchool">0u 0min</th>
                <th id="totFeest">0u 0min</th>
                <th id="totBench">0u 0min</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <!-- CONVERTER -->
      <section id="tab-converter" class="tab-pane fade">
        <h5>Uren/minuten ‚Üî decimale uren</h5>
        <div class="row g-3">
          <div class="col-6 col-md-2">
            <label class="form-label">Uren</label>
            <input id="convHours" type="number" min="0" value="0" class="form-control" />
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">Minuten</label>
            <input id="convMinutes" type="number" min="0" value="0" class="form-control" />
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Decimale uren</label>
            <input id="decimalInput" type="number" step="0.01" min="0" value="0" class="form-control" />
          </div>
        </div>
      </section>

<!-- ADMIN -->
<section id="tab-admin" class="tab-pane fade">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h5 class="mb-0">Admin beheer</h5>
    <div class="text-secondary small">
      Actief: <strong id="activeUserLabel">-</strong>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <h6 class="mb-3">Gebruikersbeheer</h6>
    <div class="row g-2 align-items-end">
      <div class="col-md-6">
        <label class="form-label">Gebruiker selecteren</label>
        <select id="adminUserSelect" class="form-select"></select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Rol</label>
        <select id="roleSelect" class="form-select">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button id="updateRoleBtn" class="btn btn-warning flex-fill">Rol opslaan</button>
        <button id="removeUserBtn" class="btn btn-danger flex-fill">Verwijder</button>
      </div>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <h6 class="mb-3">Projectbeheer</h6>
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Projectnaam</label>
        <input id="newProjectName" class="form-control" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Startdatum</label>
        <input id="newProjectStart" type="date" class="form-control" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Einddatum</label>
        <input id="newProjectEnd" type="date" class="form-control" />
      </div>
      <div class="col-md-2">
        <button id="addProjectBtn" class="btn btn-success w-100">Toevoegen</button>
      </div>
    </div>

    <div class="table-responsive mt-3">
      <table class="table table-striped align-middle table-nowrap">
        <thead class="table-light">
          <tr><th>Project</th><th>Start</th><th>Eind</th><th>Acties</th></tr>
        </thead>
        <tbody id="projectTableBody"></tbody>
      </table>
    </div>
  </div>
</section>

    </div>
  </main>

  <!-- MODALS -->
  <!-- Shift modal -->
  <div class="modal fade" id="shiftModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nieuwe / bewerk shift</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-md-6"><label class="form-label">Naam</label><input id="newShiftName" class="form-control" /></div>
            <div class="col-6 col-md-3"><label class="form-label">Start</label><input id="newShiftStart" type="time" value="08:00" class="form-control" /></div>
            <div class="col-6 col-md-3"><label class="form-label">Einde</label><input id="newShiftEnd" type="time" value="16:00" class="form-control" /></div>
            <div class="col-6 col-md-3"><label class="form-label">Pauze (min)</label><input id="newShiftBreak" type="number" min="0" value="0" class="form-control" /></div>
            <div class="col-6 col-md-5"><label class="form-label">Project</label><select id="newShiftProjectSelect" class="form-select"><option value="">Geen project</option></select></div>
            <div class="col-6 col-md-4"><label class="form-label">Vanaf</label><input id="newShiftStartDate" type="date" class="form-control" /></div>
            <div class="col-6 col-md-4"><label class="form-label">Tot</label><input id="newShiftEndDate" type="date" class="form-control" /></div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="addShiftBtn" class="btn btn-primary">Opslaan</button>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuleren</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick input modal -->
  <div class="modal fade" id="quickModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Snelle invoer</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Datum</label>
              <input type="date" id="quickDate" class="form-control" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Shift</label>
              <select id="quickShift" class="form-select"></select>
            </div>
            <div class="col-12">
              <label class="form-label">Omschrijving (optioneel)</label>
              <input type="text" id="quickNote" class="form-control" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="saveQuickBtn" class="btn btn-success">Opslaan</button>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Sluiten</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- JSPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <!-- ‚úÖ SortableJS voor drag & drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- Firebase (Modular CDN) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, getDocs, addDoc, deleteDoc, collection, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    // ===== Firebase config (jouw bestaande waarden) =====
    const firebaseConfig = {
      apiKey: "AIzaSyB8uHwRXCe1iV7z6T80YPxEbeB64qdMpNY",
      authDomain: "shift-planner-dc7ad.firebaseapp.com",
      projectId: "shift-planner-dc7ad",
      storageBucket: "shift-planner-dc7ad.firebasestorage.app",
      messagingSenderId: "719441527396",
      appId: "1:719441527396:web:de87d6f950fe23702a5571"
    };

    // ===== App init =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ======= State =======
    let currentUserId = null;
    const dataStore = { users: {}, currentUser: null };

    // ======= Elements =======
    const sidebar = document.getElementById('sidebar');
    const main = document.getElementById('main');
    const logoutBtn = document.getElementById('logoutBtn');
    const currentUserName = document.getElementById('currentUserName');
    const adminTabBtn = document.getElementById('adminTabBtn');

    // Tabs: Shifts
    const filterShiftYear = document.getElementById('filterShiftYear');
    const shiftTableBody = document.getElementById('shiftTableBody');

    // Invoer elements
    const monthSelectMain = document.getElementById('monthSelectMain');
    const yearSelectMain = document.getElementById('yearSelectMain');
    const projectFilterSelect = document.getElementById('projectFilterSelect');
    const monthTargetHours = document.getElementById('monthTargetHours');
    const monthTargetMinutes = document.getElementById('monthTargetMinutes');
    const tbody = document.getElementById('tbody');
    const inputTotDoel = document.getElementById('inputTotDoel');
    const inputTotGepland = document.getElementById('inputTotGepland');
    const inputTotVerschil = document.getElementById('inputTotVerschil');

    // Historiek
    const historyBody = document.getElementById('historyBody');
    const historiekJaar = document.getElementById('historiekJaar');
    const currentUserHistoriek = document.getElementById('currentUserHistoriek');

    // Admin
    const adminUserSelect = document.getElementById('adminUserSelect');
    const roleSelect = document.getElementById('roleSelect');
    const addUserBtn = document.getElementById('addUserBtn');
    const updateRoleBtn = document.getElementById('updateRoleBtn');
    const removeUserBtn = document.getElementById('removeUserBtn');
    const activeUserLabel = document.getElementById('activeUserLabel');
    const projectTableBody = document.getElementById('projectTableBody');
    const newProjectName = document.getElementById('newProjectName');
    const newProjectStart = document.getElementById('newProjectStart');
    const newProjectEnd = document.getElementById('newProjectEnd');
    const addProjectBtn = document.getElementById('addProjectBtn');
    const auditLog = document.getElementById('auditLog');

    // Shift modal fields
    const newShiftName = document.getElementById('newShiftName');
    const newShiftStart = document.getElementById('newShiftStart');
    const newShiftEnd = document.getElementById('newShiftEnd');
    const newShiftBreak = document.getElementById('newShiftBreak');
    const newShiftProjectSelect = document.getElementById('newShiftProjectSelect');
    const newShiftStartDate = document.getElementById('newShiftStartDate');
    const newShiftEndDate = document.getElementById('newShiftEndDate');
    const addShiftBtn = document.getElementById('addShiftBtn');

    // Quick input
    const quickDate = document.getElementById('quickDate');
    const quickShift = document.getElementById('quickShift');
    const quickNote = document.getElementById('quickNote');
    const saveQuickBtn = document.getElementById('saveQuickBtn');
// --- helpers: mapping & automatische projecttoewijzing ---
const SPECIAL_PROJECT_MAP = {
  'Verlof': 'Eght Care',
  'Ziekte': 'Eght Care',
  'Teammeeting': 'Eght Care',
  'School': 'PXL Verpleegkunde Hasselt',
  'Schoolverlof': 'PXL Verpleegkunde Hasselt'
};
function isValidProject(name) {
  const ud = getCurrentUserData();
  return !!(ud.projects || []).find(p => p.name === name);
}
function autoProjectForShift(shiftName){
  return SPECIAL_PROJECT_MAP[shiftName] || null;
}
    // ======= UI helpers =======
    const daysFull = ["Zondag","Maandag","Dinsdag","Woensdag","Donderdag","Vrijdag","Zaterdag"];
    const monthsFull = ["Januari","Februari","Maart","April","Mei","Juni","Juli","Augustus","September","Oktober","November","December"];
    const toast = (msg, type='primary') => {
      const el = document.createElement('div');
      el.className = `toast align-items-center text-bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
      el.role = 'alert'; el.ariaLive='assertive'; el.ariaAtomic='true';
      el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      document.body.appendChild(el);
      new bootstrap.Toast(el, { delay: 2500 }).show();
      el.addEventListener('hidden.bs.toast', ()=> el.remove());
    };

    const dateKey = (y,m,d)=> `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const toDisplayDate = iso => !iso ? '-' : iso.split('-').reverse().join('-');
    const fromDisplayDate = disp => {const [d,m,y]=disp.split('-'); return `${y}-${m}-${d}`;};
    const minutesBetween = (s,e,b)=> {
      if(!s||!e) return 0;
      const [sh,sm]=s.split(':').map(Number), [eh,em]=e.split(':').map(Number);
      let mins = (eh*60+em) - (sh*60+sm) - (Number(b)||0);
      if(mins<0) mins+=1440;
      return mins;
    };
    const isDateWithin = (iso, start, end) => {
      const d = iso?.replaceAll('-',''); if(!d) return false;
      const s = start? start.replaceAll('-',''): null;
      const e = end? end.replaceAll('-',''): null;
      if(s && d < s) return false; if(e && d > e) return false; return true;
    };

    // ======= Auth =======
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        // Voor demo: toon eenvoudige melding
        currentUserName.textContent = 'Niet ingelogd';
        toast('Geen gebruiker ingelogd. Redirect naar login‚Ä¶', 'warning');
        // Je kan hier een loginpagina openen of FirebaseUI integreren.
        return;
      }
      currentUserId = user.uid;
      currentUserName.textContent = user.displayName || user.email;

      await ensureUserDoc(user);
      await loadAllUsers();
      ensureDefaultProjects();
      initSelectors();
      renderAll();
      await revealAdminIfNeeded();
    });

    logoutBtn?.addEventListener('click', async ()=>{
  await signOut(auth);
  window.location.href = 'index.html'; // üëà redirect in plaats van reload
});

    async function ensureUserDoc(user){
      const ref = doc(db, 'users', user.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, { email: user.email, name: user.displayName || user.email.split('@')[0], role:'user', shifts:{}, monthData:{}, projects:[], shiftOrder:[] });
      } else {
        const data = snap.data(), updates={};
        if(!('email' in data)) updates.email = user.email;
        if(!('name' in data)) updates.name = user.displayName || user.email.split('@')[0];
        if(!('role' in data)) updates.role = 'user';
        if(!('shifts' in data)) updates.shifts = {};
        if(!('monthData' in data)) updates.monthData = {};
        if(!('projects' in data)) updates.projects = [];
        if(!('shiftOrder' in data)) updates.shiftOrder = [];
        if(Object.keys(updates).length) await updateDoc(ref, updates);
      }
    }
function getActiveUserId() {
  return dataStore.viewUserId || dataStore.currentUser;
}
    // ======= Data loading/saving =======
    async function loadAllUsers(){
      const meRef = doc(db,'users', currentUserId);
      const meSnap = await getDoc(meRef);
      const me = meSnap.data();
      dataStore.users = {};
      if(me.role === 'admin'){
        const qs = await getDocs(collection(db,'users'));
        qs.forEach(d=> dataStore.users[d.id] = d.data());
      } else {
        dataStore.users[currentUserId] = me;
      }
      dataStore.currentUser = currentUserId;
    }

async function saveUserData(){
  const id = getActiveUserId();
  if (!id) return;
  const ref = doc(db,'users', id);
  await setDoc(ref, dataStore.users[id], { merge: true });
}

   function getCurrentUserData() {
  const id = getActiveUserId();
  if (!id) return { shifts:{}, monthData:{}, projects:[], shiftOrder:[] };
  if (!dataStore.users[id]) dataStore.users[id] = { shifts:{}, monthData:{}, projects:[], shiftOrder:[] };
  return dataStore.users[id];
}

    // ======= UI init =======
    function initSelectors(){
      // years
      const yNow = new Date().getFullYear();
      yearSelectMain.innerHTML = '';
      for(let y = yNow-2; y <= yNow+3; y++){
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y; if(y===yNow) opt.selected = true; yearSelectMain.appendChild(opt);
      }
    }

    async function revealAdminIfNeeded(){
      const meSnap = await getDoc(doc(db,'users', currentUserId));
      const role = meSnap.data().role;
      if(role === 'admin'){ adminTabBtn.classList.remove('d-none'); }
    }

    // ======= Projects =======
    function renderProjects(){
      const ud = getCurrentUserData();
      const list = (ud.projects || []).slice().sort((a,b)=>{
        const as = a.start? new Date(a.start): new Date('1900-01-01');
        const bs = b.start? new Date(b.start): new Date('1900-01-01');
        if(as.getTime() !== bs.getTime()) return as - bs;
        const ae = a.end? new Date(a.end): new Date('9999-12-31');
        const be = b.end? new Date(b.end): new Date('9999-12-31');
        return ae - be;
      });

      // table
      projectTableBody.innerHTML = '';
      newShiftProjectSelect.innerHTML = '<option value="">Geen project</option>';
      projectFilterSelect.innerHTML = '<option value="">Alle projecten</option>';

      list.forEach((p, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${toDisplayDate(p.start)}</td>
          <td>${toDisplayDate(p.end)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-warning me-1" data-idx="${idx}" data-act="extend">Verleng</button>
            <button class="btn btn-sm btn-danger" data-idx="${idx}" data-act="delete">Verwijder</button>
          </td>`;
        projectTableBody.appendChild(tr);

        const o1 = document.createElement('option'); o1.value=p.name; o1.textContent=p.name; newShiftProjectSelect.appendChild(o1);
        const o2 = document.createElement('option'); o2.value=p.name; o2.textContent=p.name; projectFilterSelect.appendChild(o2);
      });

      // actions
      projectTableBody.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const ud = getCurrentUserData();
          const idx = Number(btn.dataset.idx);
          const p = ud.projects[idx]; if(!p) return;
          if(btn.dataset.act==='extend'){
            const v = prompt('Nieuwe einddatum (DD-MM-YYYY):', toDisplayDate(p.end) || '');
            if(!v) return;
            p.end = fromDisplayDate(v);
            await saveUserData(); renderProjects(); renderMonth(Number(yearSelectMain.value), Number(monthSelectMain.value));
          } else {
            if(!confirm('Project verwijderen?')) return;
            ud.projects.splice(idx,1);
            await saveUserData(); 
            renderProjects(); 
            renderProjectFilterForMonth();
            renderMonth(Number(yearSelectMain.value), Number(monthSelectMain.value));
          }
        });
      });
    }

    addProjectBtn?.addEventListener('click', async ()=>{
      const name = newProjectName.value.trim(); if(!name) return toast('Vul projectnaam in','warning');
      const ud = getCurrentUserData();
      ud.projects = ud.projects || [];
      ud.projects.push({ name, start: newProjectStart.value || null, end: newProjectEnd.value || null });
      await saveUserData();
      newProjectName.value = ''; newProjectStart.value=''; newProjectEnd.value='';
      renderProjects(); 
      renderProjectFilterForMonth(); 
      toast('Project toegevoegd','success');
    });

    // ======= Shifts =======
function renderShifts() {
  const ud = getCurrentUserData();
  const shifts = ud.shifts || {};
  const order = ud.shiftOrder && ud.shiftOrder.length ? ud.shiftOrder : Object.keys(shifts);

  const selectedYear = filterShiftYear.value ? Number(filterShiftYear.value) : null;

  // Leegmaken
  shiftTableBody.innerHTML = '';

  // Opnieuw opbouwen
  order.forEach(name => {
    const sh = shifts[name];
    if (!sh) return;

    // ‚úÖ Filteren op gekozen jaar
    if (selectedYear) {
      const startY = sh.startDate ? new Date(sh.startDate).getFullYear() : null;
      const endY = sh.endDate ? new Date(sh.endDate).getFullYear() : null;

      // Geen overlap ‚Üí overslaan
      if (
        (startY && endY && (selectedYear < startY || selectedYear > endY)) ||
        (startY && !endY && selectedYear < startY) ||
        (!startY && endY && selectedYear > endY)
      ) {
        return;
      }
    }

    const tr = document.createElement('tr');
    tr.dataset.name = name;
    tr.setAttribute('draggable', true);
    tr.innerHTML = `
      <td class="fw-medium">
        <span class="material-icons-outlined drag-handle me-1" style="cursor:grab;">drag_indicator</span>${name}
      </td>
      <td class="text-mono">${sh.start || ''}</td>
      <td class="text-mono">${sh.end || ''}</td>
      <td>${sh.break || 0}</td>
      <td>${sh.project || ''}</td>
      <td>${toDisplayDate(sh.startDate)} ‚Üí ${toDisplayDate(sh.endDate)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-warning me-1" data-name="${name}" data-act="edit">Bewerk</button>
        <button class="btn btn-sm btn-danger" data-name="${name}" data-act="delete">Verwijder</button>
      </td>`;
    shiftTableBody.appendChild(tr);
  });

  // ‚úÖ Activeer SortableJS
  if (shiftTableBody.sortableInstance) {
    shiftTableBody.sortableInstance.destroy();
  }

  shiftTableBody.sortableInstance = new Sortable(shiftTableBody, {
    handle: '.drag-handle',
    animation: 150,
    fallbackOnBody: true,
    swapThreshold: 0.65,
    ghostClass: 'bg-light',
    onEnd: async (evt) => {
      const newOrder = Array.from(shiftTableBody.querySelectorAll('tr')).map(tr => tr.dataset.name);
      ud.shiftOrder = newOrder;
      await saveUserData();
      toast('Volgorde opgeslagen', 'success');
    }
  });

  // acties
  shiftTableBody.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', async () => {
      const act = btn.dataset.act, name = btn.dataset.name;
      if (act === 'delete') {
        if (!confirm(`Shift ${name} verwijderen?`)) return;
        delete ud.shifts[name];
        ud.shiftOrder = (ud.shiftOrder || []).filter(n => n !== name);
        await saveUserData();
        renderShifts();
      } else if (act === 'edit') {
        const sh = ud.shifts[name];
        newShiftName.value = name;
        newShiftStart.value = sh.start || '08:00';
        newShiftEnd.value = sh.end || '16:00';
        newShiftBreak.value = sh.break || 0;
        newShiftProjectSelect.value = sh.project || '';
        newShiftStartDate.value = sh.startDate || '';
        newShiftEndDate.value = sh.endDate || '';
        delete ud.shifts[name];
        await saveUserData();
        new bootstrap.Modal(document.getElementById('shiftModal')).show();
      }
    });
  });
}

    addShiftBtn?.addEventListener('click', async ()=>{
      const name = newShiftName.value.trim(); if(!name) return toast('Vul shift naam in','warning');
      const ud = getCurrentUserData();
      ud.shifts = ud.shifts || {};
      ud.shifts[name] = {
        start: newShiftStart.value || '00:00',
        end: newShiftEnd.value || '00:00',
        break: Number(newShiftBreak.value) || 0,
        project: newShiftProjectSelect.value || null,
        startDate: newShiftStartDate.value || null,
        endDate: newShiftEndDate.value || null
      };
      ud.shiftOrder = ud.shiftOrder || [];
      if(!ud.shiftOrder.includes(name)) ud.shiftOrder.push(name);
      await saveUserData(); renderShifts();
      bootstrap.Modal.getInstance(document.getElementById('shiftModal')).hide();
      newShiftName.value=''; newShiftBreak.value=0; newShiftStartDate.value=''; newShiftEndDate.value='';
      toast('Shift opgeslagen','success');
    });

    filterShiftYear.addEventListener('change', ()=> renderShifts());

function populateFilterShiftYears() {
  const ud = getCurrentUserData();
  const years = new Set();

  // Verzamel jaartallen uit startDate en endDate
  Object.values(ud.shifts || {}).forEach(sh => {
    if (sh.startDate) years.add(new Date(sh.startDate).getFullYear());
    if (sh.endDate) years.add(new Date(sh.endDate).getFullYear());
  });

  const sortedYears = [...years].sort((a, b) => a - b);

  filterShiftYear.innerHTML = '<option value="">Alle jaren</option>';
  sortedYears.forEach(y => {
    const o = document.createElement('option');
    o.value = y;
    o.textContent = y;
    filterShiftYear.appendChild(o);
  });

  // Automatisch huidig jaar selecteren (indien aanwezig)
  const currentYear = new Date().getFullYear();
  if (sortedYears.includes(currentYear)) {
    filterShiftYear.value = currentYear;
  }
}

    // ======= Invoer (maand) =======
function renderProjectFilterForMonth(){
  const ud = getCurrentUserData();
  const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
  const daysInMonth = new Date(y, m+1, 0).getDate();
  const monthStart = `${y}-${String(m+1).padStart(2,'0')}-01`.replaceAll('-','');
  const monthEnd = `${y}-${String(m+1).padStart(2,'0')}-${String(daysInMonth).padStart(2,'0')}`.replaceAll('-','');

  projectFilterSelect.innerHTML = '<option value="">Alle projecten</option>';

  const list = (ud.projects || [])
    .slice()
    .sort((a,b) => {
      const as = a.start ? new Date(a.start) : new Date('1900-01-01');
      const bs = b.start ? new Date(b.start) : new Date('1900-01-01');
      if (as.getTime() !== bs.getTime()) return as - bs;
      return (a.name || '').localeCompare(b.name || '');
    });

  list.forEach(p => {
    const ps = (p.start || '0000-01-01').replaceAll('-','');
    const pe = (p.end || '9999-12-31').replaceAll('-','');
    if (ps <= monthEnd && pe >= monthStart) {
      const o = document.createElement('option');
      o.value = p.name;
      o.textContent = p.name;
      projectFilterSelect.appendChild(o);
    }
  });
}

    async function generateMonth(){
      const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
      const ud = getCurrentUserData();
      ud.monthData = ud.monthData || {};
      ud.monthData[y] = ud.monthData[y] || {};
      if(!ud.monthData[y][m]) ud.monthData[y][m] = { targetHours:0, targetMinutes:0, rows:{} };
      await saveUserData();
      await renderMonth(y,m); updateInputTotals(); renderHistory();
    }
// ‚úÖ Automatische koppeling van project aan shift bij herladen
function autoAssignProjectIfNeeded(r) {
  const sp = autoProjectForShift(r.shift);
  if (sp && (!r.project || r.project === '' || !isValidProject(r.project))) {
    ensureProjectExists(sp);
    r.project = sp;
  }
}
   async function renderMonth(year, month){
  const ud = getCurrentUserData();
  ud.monthData[year] = ud.monthData[year] || {};
  ud.monthData[year][month] = ud.monthData[year][month] || { targetHours:0, targetMinutes:0, rows:{} };
  const md = ud.monthData[year][month];
  const selectedProject = projectFilterSelect.value || ''; // üëà gekozen filter
  tbody.innerHTML = '';

      monthTargetHours.value = md.targetHours || 0;
      monthTargetMinutes.value = md.targetMinutes || 0;

      const daysInMonth = new Date(year, month+1, 0).getDate();
      for(let d=1; d<=daysInMonth; d++){
        const key = dateKey(year, month, d);
if (!md.rows[key]) {
  md.rows[key] = { project:'', shift:'', start:'00:00', end:'00:00', break:0, omschrijving:'', minutes:0 };
} else {
  autoAssignProjectIfNeeded(md.rows[key]);
}
        const r = md.rows[key];
        const dayName = daysFull[new Date(year, month, d).getDay()];
  // üëá Filter op project (alleen tonen wat overeenkomt)
  if (selectedProject && r.project !== selectedProject) continue;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${dayName}</td>
          <td>${String(d).padStart(2,'0')}-${String(month+1).padStart(2,'0')}-${year}</td>
          <td><select class="form-select form-select-sm projectSelect"></select></td>
          <td><select class="form-select form-select-sm shiftSelect"></select></td>
          <td><input class="form-control form-control-sm startInput" type="time" value="${r.start}"></td>
          <td><input class="form-control form-control-sm endInput" type="time" value="${r.end}"></td>
          <td><input class="form-control form-control-sm breakInput" type="number" min="0" value="${r.break}"></td>
          <td><input class="form-control form-control-sm omschrijvingInput" type="text" value="${r.omschrijving}"></td>
          <td class="dur text-mono">${Math.floor(r.minutes/60)}u ${r.minutes%60}min</td>`;
        tbody.appendChild(tr);

        // project dropdown (alleen geldige voor datum)
        const projSel = tr.querySelector('.projectSelect');
        projSel.innerHTML = '<option value="">--</option>';
        (ud.projects || []).forEach(p=>{
          if (isDateWithin(key, p.start || null, p.end || null)) {
            const o = document.createElement('option'); o.value=p.name; o.textContent=p.name; projSel.appendChild(o);
          }
        });
        if(r.project) projSel.value = r.project;

        projSel.addEventListener('change', async ()=>{
          r.project = projSel.value || '';
          saveCell(year, month, key, r, tr);
          await populateShiftSelectForRow(tr, d, month, year);
          updateInputTotals();
          saveUserData();
        });

        await populateShiftSelectForRow(tr, d, month, year);

        tr.querySelector('.startInput').addEventListener('change', e=>{
          r.start = e.target.value; recalcRowMinutes(r);
          saveCell(year, month, key, r, tr); tr.querySelector('.dur').textContent = `${Math.floor(r.minutes/60)}u ${r.minutes%60}min`;
          updateInputTotals(); saveUserData(); renderHistory();
        });
        tr.querySelector('.endInput').addEventListener('change', e=>{
          r.end = e.target.value; recalcRowMinutes(r);
          saveCell(year, month, key, r, tr); tr.querySelector('.dur').textContent = `${Math.floor(r.minutes/60)}u ${r.minutes%60}min`;
          updateInputTotals(); saveUserData(); renderHistory();
        });
        tr.querySelector('.breakInput').addEventListener('input', e=>{
          r.break = Number(e.target.value)||0; recalcRowMinutes(r);
          saveCell(year, month, key, r, tr); tr.querySelector('.dur').textContent = `${Math.floor(r.minutes/60)}u ${r.minutes%60}min`;
          updateInputTotals(); saveUserData(); renderHistory();
        });
        tr.querySelector('.omschrijvingInput').addEventListener('change', e=>{
          r.omschrijving = e.target.value; saveCell(year, month, key, r, tr); saveUserData(); renderHistory();
        });
      }
    await saveUserData();
    }

async function populateShiftSelectForRow(tr, day, month, year){
  const key = dateKey(year, month, day);
  const ud = getCurrentUserData();
  const md = ud.monthData[year][month];
  const r = md.rows[key];
  const projSel = tr.querySelector('.projectSelect');
  const sel = tr.querySelector('.shiftSelect');
  sel.innerHTML = '<option value=""></option>';

  const all = ud.shifts || {};
  const order = ud.shiftOrder || Object.keys(all);
  const entries = order.map(n=> [n, all[n]]).filter(([,sh])=> !!sh);

  for(const [name, sh] of entries){
    if(!isDateWithin(key, sh.startDate || null, sh.endDate || null)) continue;
    const o = document.createElement('option');
    o.value = name; o.textContent = name; if(r.shift===name) o.selected = true; sel.appendChild(o);
  }

  sel.addEventListener('change', async ()=>{
    const chosen = sel.value;
    const all = ud.shifts || {};
    if (!chosen) {
      r.shift = ''; r.project = ''; projSel.value = '';
      saveCell(year, month, key, r, tr); await saveUserData(); updateInputTotals(); renderHistory();
      return;
    }

    r.shift = chosen;
await saveUserData();
// ‚úÖ Automatische projecttoewijzing
if (['Bench'].includes(chosen)) {
  r.project = '';
  saveCell(year, month, key, r, tr);
  await saveUserData();
} 
else if (['Schoolverlof','School'].includes(chosen)) {
  ensureProjectExists('PXL Verpleegkunde Hasselt');
  r.project = 'PXL Verpleegkunde Hasselt';
  saveCell(year, month, key, r, tr);
  await saveUserData();
  console.log(`üìò Project toegewezen: ${r.project}`);
} 
else if (['Verlof','Teammeeting','Ziekte'].includes(chosen)) {
  ensureProjectExists('Eght Care');
  r.project = 'Eght Care';
  saveCell(year, month, key, r, tr);
  await saveUserData();
  console.log(`üíº Project toegewezen: ${r.project}`);
} 
else {
  const sh = all[chosen];
  if (sh && sh.project) {
    const p = (ud.projects||[]).find(px => px.name===sh.project);
    if (p && isDateWithin(key, p.start||null, p.end||null)) {
      r.project = p.name;
    }
  }
}

// ‚úÖ Herlaad project-dropdown in deze rij alleen
projSel.innerHTML = '<option value="">--</option>';
(getCurrentUserData().projects || []).forEach(p=>{
  if(isDateWithin(key, p.start || null, p.end || null)){
    const o = document.createElement('option');
    o.value = p.name;
    o.textContent = p.name;
    projSel.appendChild(o);
  }
});
setTimeout(()=> { projSel.value = r.project || ''; }, 50);
// ‚úÖ Vul tijden en pauze in
const sh = all[chosen];
if (sh) {
  r.start = sh.start || '00:00';
  r.end   = sh.end   || '00:00';
  r.break = Number(sh.break) || 0;
}

recalcRowMinutes(r);
tr.querySelector('.startInput').value = r.start;
tr.querySelector('.endInput').value = r.end;
tr.querySelector('.breakInput').value = r.break;
tr.querySelector('.dur').textContent = `${Math.floor(r.minutes/60)}u ${r.minutes%60}min`;

    saveCell(year, month, key, r, tr);
    await saveUserData();
    updateInputTotals();
  });
}
async function ensureProjectExists(name){
  const ud = getCurrentUserData();
  ud.projects = ud.projects || [];
  let p = ud.projects.find(p=> p.name===name);
  if(!p){
    // Oneindige geldigheid (altijd zichtbaar)
    ud.projects.push({ name, start: "2000-01-01", end: "2099-12-31" });
    saveUserData();
    renderProjects(); // meteen toevoegen aan alle dropdowns
  }
}

    function recalcRowMinutes(r){ r.minutes = minutesBetween(r.start, r.end, r.break); }
    function saveCell(year, month, key, r, tr){
      const ud = getCurrentUserData();
      ud.monthData = ud.monthData || {}; ud.monthData[year] = ud.monthData[year] || {};
      ud.monthData[year][month] = ud.monthData[year][month] || { targetHours:0, targetMinutes:0, rows:{} };
      ud.monthData[year][month].rows[key] = { ...r, minutes: r.minutes || minutesBetween(r.start, r.end, r.break) };
    }
function ensureDefaultProjects(){
  const ud = getCurrentUserData();
  ud.projects = ud.projects || [];
  const defaults = [
    { name: 'Eght Care', start: '2000-01-01', end: '2099-12-31' },
    { name: 'PXL Verpleegkunde Hasselt', start: '2000-01-01', end: '2099-12-31' }
  ];
  defaults.forEach(def => {
    if(!ud.projects.find(p => p.name === def.name)){
      ud.projects.push(def);
    }
  });
  saveUserData();
}
    function updateInputTotals(){
      const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
      const ud = getCurrentUserData();
      const md = ud.monthData?.[y]?.[m] || { targetHours:0, targetMinutes:0, rows:{} };
      const total = Object.values(md.rows||{}).reduce((s,r)=> s + (r.minutes||0), 0);
      const target = (md.targetHours||0)*60 + (md.targetMinutes||0);
      const diff = total - target;

      const fmt = v => `${Math.floor(v/60)}u ${v%60}min`;
      inputTotDoel.textContent = fmt(target);
      inputTotGepland.textContent = fmt(total);
      inputTotVerschil.textContent = `${diff>=0?'+':''}${fmt(Math.abs(diff))}`;
      inputTotVerschil.className = `text-mono ${diff>=0? 'text-success':'text-danger'}`;
    }

    // live target updates
    monthTargetHours.addEventListener('input', async ()=>{
      const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
      const ud = getCurrentUserData();
      ud.monthData[y][m].targetHours = Number(monthTargetHours.value)||0;
      await saveUserData(); updateInputTotals(); renderHistory();
    });
    monthTargetMinutes.addEventListener('input', async ()=>{
      const y = Number(yearSelectMain.value), m = Number(monthSelectMain.value);
      const ud = getCurrentUserData();
      ud.monthData[y][m].targetMinutes = Number(monthTargetMinutes.value)||0;
      await saveUserData(); updateInputTotals(); renderHistory();
    });

    projectFilterSelect.addEventListener('change', ()=> { renderMonth(Number(yearSelectMain.value), Number(monthSelectMain.value)); updateInputTotals(); });

    yearSelectMain.addEventListener('change', async ()=> { renderProjectFilterForMonth(); generateMonth(); });
    monthSelectMain.addEventListener('change', async ()=> { renderProjectFilterForMonth(); generateMonth(); });

    // ======= Quick input =======
    quickDate.addEventListener('change', populateQuickShifts);
    function populateQuickShifts(){
      const ud = getCurrentUserData();
      quickShift.innerHTML = '<option value="">-- Kies shift --</option>';
      const all = ud.shifts || {};
      const order = ud.shiftOrder || Object.keys(all);
      const dateStr = quickDate.value; if(!dateStr) return;
      const withPeriod = [], without = [];
      order.forEach(n=> { const sh = all[n]; if(!sh) return; if(sh.startDate || sh.endDate) withPeriod.push([n,sh]); else without.push([n,sh]); });
      [...withPeriod, ...without].forEach(([n,sh])=>{
        if(!isDateWithin(dateStr, sh.startDate||null, sh.endDate||null)) return;
        const o = document.createElement('option'); o.value=n; o.textContent=n; quickShift.appendChild(o);
      });
    }

    saveQuickBtn.addEventListener('click', async ()=>{
  const date = quickDate.value, shift = quickShift.value, note = quickNote.value;
  if(!date || !shift) return toast('Kies minstens een datum en shift','warning');
  const y = Number(date.split('-')[0]), m = Number(date.split('-')[1]) - 1, key = date;
  const ud = getCurrentUserData();
  ud.monthData = ud.monthData || {}; ud.monthData[y] = ud.monthData[y] || {};
  ud.monthData[y][m] = ud.monthData[y][m] || { targetHours:0, targetMinutes:0, rows:{} };
  const sh = ud.shifts[shift];
  const minutes = minutesBetween(sh.start, sh.end, sh.break);

  // ‚úÖ Automatische projecttoewijzing
let project = sh?.project || '';
const sp = autoProjectForShift(shift);
if (sp) {
  ensureProjectExists(sp);
  project = sp;
}

  ud.monthData[y][m].rows[key] = {
    project,
    shift,
    start: sh.start,
    end: sh.end,
    break: sh.break,
    omschrijving: note,
    minutes
  };

  await saveUserData();
  renderMonth(y, m);
  updateInputTotals();
  renderHistory();
  bootstrap.Modal.getInstance(document.getElementById('quickModal')).hide();
  toast('Snelle invoer toegevoegd','success');
});

    // ======= Historiek =======
    function renderHistory(){
      const ud = getCurrentUserData();
      const year = Number(yearSelectMain.value) || new Date().getFullYear();
      historiekJaar.textContent = year;
      currentUserHistoriek.textContent = ud.name || ud.email || '‚Äî';

      let totDoel=0, totGepland=0, totVerschil=0, totVerlof=0, totZiekte=0, totSchool=0, totFeest=0, totBench=0;
      historyBody.innerHTML = '';
      for(let m=0; m<12; m++){
        const md = ud.monthData?.[year]?.[m] || { targetHours:0, targetMinutes:0, rows:{} };
        const target = (md.targetHours||0)*60 + (md.targetMinutes||0);
        const rows = md.rows || {};
        const gepland = Object.values(rows).reduce((s,r)=> s + (r.minutes||0), 0);
        let v=0,z=0,sf=0,f=0,b=0;
        Object.values(rows).forEach(r=>{
          if(!r.shift) return;
          if(r.shift==='Verlof') v += r.minutes||0;
          if(r.shift==='Ziekte') z += r.minutes||0;
          if(r.shift==='Schoolverlof') sf += r.minutes||0;
          if(r.shift==='Feestdag') f += r.minutes||0;
          if(r.shift==='Bench') b += r.minutes||0;
        });
        const diff = gepland - target;

        totDoel += target; totGepland += gepland; totVerschil += diff;
        totVerlof += v; totZiekte += z; totSchool += sf; totFeest += f; totBench += b;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${monthsFull[m]}</td>
          <td>${Math.floor(target/60)}u ${target%60}min</td>
          <td>${Math.floor(gepland/60)}u ${gepland%60}min</td>
          <td class="${diff>=0? 'text-success':'text-danger'}">${diff>=0?'+':''}${Math.floor(Math.abs(diff)/60)}u ${Math.abs(diff)%60}min</td>
          <td>${Math.floor(v/60)}u ${v%60}min</td>
          <td>${Math.floor(z/60)}u ${z%60}min</td>
          <td>${Math.floor(sf/60)}u ${sf%60}min</td>
          <td>${Math.floor(f/60)}u ${f%60}min</td>
          <td>${Math.floor(b/60)}u ${b%60}min</td>`;
        historyBody.appendChild(tr);
      }

      document.getElementById('totDoel').textContent = `${Math.floor(totDoel/60)}u ${totDoel%60}min`;
      document.getElementById('totGepland').textContent = `${Math.floor(totGepland/60)}u ${totGepland%60}min`;
      document.getElementById('totVerschil').textContent = `${totVerschil>=0?'+':''}${Math.floor(Math.abs(totVerschil)/60)}u ${Math.abs(totVerschil)%60}min`;
      document.getElementById('totVerlof').textContent = `${Math.floor(totVerlof/60)}u ${totVerlof%60}min`;
      document.getElementById('totZiekte').textContent = `${Math.floor(totZiekte/60)}u ${totZiekte%60}min`;
      document.getElementById('totSchool').textContent = `${Math.floor(totSchool/60)}u ${totSchool%60}min`;
      document.getElementById('totFeest').textContent = `${Math.floor(totFeest/60)}u ${totFeest%60}min`;
      document.getElementById('totBench').textContent = `${Math.floor(totBench/60)}u ${totBench%60}min`;
    }

// ======= Admin =======
// Gebruikerslijst renderen
async function renderAdminUserSelect() {
  adminUserSelect.innerHTML = '<option value="">-- Kies gebruiker --</option>';
  const qs = await getDocs(collection(db, 'users'));
  qs.forEach(d => {
    const u = d.data();
    const opt = document.createElement('option');
    opt.value = d.id;
    opt.textContent = `${u.name || u.email || d.id} (${u.role || 'user'})`;
    adminUserSelect.appendChild(opt);
  });

  activeUserLabel.textContent =
    dataStore.users[currentUserId]?.name || currentUserName.textContent || '-';
}

// ‚úÖ Gebruiker selecteren zonder adminstatus te verliezen
adminUserSelect?.addEventListener('change', async () => {
  const uid = adminUserSelect.value;
  if (!uid) return;

  try {
    const snap = await getDoc(doc(db, 'users', uid));
    if (!snap.exists()) {
      toast('Gebruiker niet gevonden', 'warning');
      return;
    }

    const u = snap.data();
    // Plaats de gebruiker tijdelijk in dataStore voor weergave
    dataStore.users[uid] = u;

    // UI labels bijwerken
    activeUserLabel.textContent = u.name || u.email || uid;
    roleSelect.value = u.role || 'user';
    document.getElementById('currentUserName').textContent = u.name || u.email || uid;
    document.getElementById('currentUserHistoriek').textContent = u.name || u.email || uid;

    // We tonen enkel hun data (zonder rechten te verliezen)
    await renderUserDataAsAdmin(uid);
    toast(`Beheer actief voor ${u.name || uid}`, 'primary');
  } catch (err) {
    console.error(err);
    toast('Fout bij laden van gebruiker', 'danger');
  }
});

// ‚úÖ Alleen UI renderen voor geselecteerde gebruiker
async function renderUserDataAsAdmin(uid) {
  const snap = await getDoc(doc(db, 'users', uid));
  if (!snap.exists()) return;
  const u = snap.data();

  // Tijdelijk: toon deze data in invoer & historiek
  dataStore.users[uid] = u;
  dataStore.viewUserId = uid;

  renderProjects();
  renderShifts();
  populateFilterShiftYears();
  renderProjectFilterForMonth();
  generateMonth();
  renderHistory();
}

// ‚úÖ Rol bijwerken
updateRoleBtn?.addEventListener('click', async () => {
  const uid = adminUserSelect.value;
  const newRole = roleSelect.value;
  if (!uid) return toast('Geen gebruiker geselecteerd', 'warning');

  try {
    await updateDoc(doc(db, 'users', uid), { role: newRole });
    toast(`Rol aangepast naar ${newRole}`, 'success');
    await renderAdminUserSelect();
  } catch (err) {
    console.error(err);
    toast('Fout bij rol aanpassen ‚Äî controleer Firestore-regels', 'danger');
  }
});

// ‚úÖ Gebruiker verwijderen
removeUserBtn?.addEventListener('click', async () => {
  const uid = adminUserSelect.value;
  if (!uid) return toast('Geen gebruiker geselecteerd', 'warning');
  if (uid === currentUserId) return toast('Je kunt jezelf niet verwijderen', 'warning');
  if (!confirm('Weet je zeker dat je deze gebruiker wilt verwijderen?')) return;

  try {
    await deleteDoc(doc(db, 'users', uid));
    toast('Gebruiker verwijderd', 'danger');
    await renderAdminUserSelect();
    dataStore.viewUserId = null;
  } catch (err) {
    console.error(err);
    toast('Fout bij verwijderen ‚Äî controleer Firestore-regels', 'danger');
  }
});

    // ======= Converter =======
    const convHours = document.getElementById('convHours');
    const convMinutes = document.getElementById('convMinutes');
    const decimalInput = document.getElementById('decimalInput');
    function updateDecimal(){
      const h = Number(convHours.value)||0, m = Number(convMinutes.value)||0;
      decimalInput.value = (h + m/60).toFixed(2);
    }
    function updateHM(){
      const dec = Number(decimalInput.value)||0;
      const h = Math.floor(dec), m = Math.round((dec-h)*60);
      convHours.value = h; convMinutes.value = m;
    }
    convHours.addEventListener('input', updateDecimal);
    convMinutes.addEventListener('input', updateDecimal);
    decimalInput.addEventListener('input', updateHM);

    // ======= Layout toggles =======
    document.getElementById('sidebarToggle').addEventListener('click', ()=>{
      sidebar.classList.toggle('collapsed'); main.classList.toggle('collapsed');
    });
    document.getElementById('sidebarMobile').addEventListener('click', ()=>{
      sidebar.classList.toggle('show');
    });
    // close sidebar on nav click (mobile)
    document.querySelectorAll('#navTabs .nav-link').forEach(a=>{
      a.addEventListener('click', ()=> sidebar.classList.remove('show'));
    });

    // ======= Render all =======
    function renderAll(){
      renderProjects();
      renderShifts();
      populateFilterShiftYears();
      renderProjectFilterForMonth();
      generateMonth();
      renderAdminUserSelect();
    }
     // ‚úÖ Plaats DIT hier:
document.getElementById('exportPdfBtn')?.addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: 'a4' });

  const monthIndex = Number(document.getElementById('monthSelectMain').value);
  const year = document.getElementById('yearSelectMain').value;
  const monthName = monthsFull[monthIndex];
  const ud = getCurrentUserData();
  const md = ud.monthData?.[year]?.[monthIndex];

  if (!md || !md.rows || Object.keys(md.rows).length === 0) {
    return toast('Geen data voor deze maand', 'warning');
  }

  // === Header met branding ===
  const pageWidth = doc.internal.pageSize.width;
  doc.setFillColor(13, 110, 253);
  doc.rect(0, 0, pageWidth, 25, 'F');
  doc.setFontSize(16);
  doc.setTextColor(255, 255, 255);
  doc.text('Shift Planner', 14, 15);
  doc.setFontSize(11);
  doc.text(`${monthName} ${year}`, pageWidth - 50, 15);

  // Gebruikersinfo
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(9);
  doc.text(`Gebruiker: ${ud.name || ud.email || '-'}`, 14, 32);
  doc.text(`Exportdatum: ${new Date().toLocaleDateString('nl-BE')}`, 14, 37);

  // === Data voorbereiden ===
  const body = Object.entries(md.rows)
    .sort(([a], [b]) => a.localeCompare(b)) // chronologisch sorteren
    .map(([key, r]) => {
      const date = key.split('-').reverse().join('-');
      const duration = `${Math.floor(r.minutes / 60)}u ${r.minutes % 60}m`;
      return [
        date,
        r.project || '-',
        r.shift || '-',
        r.start || '',
        r.end || '',
        r.break || 0,
        duration,
        r.omschrijving || ''
      ];
    });

  // === AutoTable met compacte styling ===
  doc.autoTable({
    head: [['Datum', 'Project', 'Shift', 'Start', 'Einde', 'Pauze', 'Duur', 'Omschrijving']],
    body,
    startY: 43,
    theme: 'grid',
    styles: {
      fontSize: 8,
      cellPadding: 1.5,
      lineWidth: 0.1
    },
    headStyles: { fillColor: [13, 110, 253], textColor: 255 },
    alternateRowStyles: { fillColor: [248, 249, 252] },
    margin: { left: 8, right: 8 },
    tableWidth: 'auto',
    columnStyles: {
      0: { cellWidth: 20 }, // datum
      1: { cellWidth: 30 }, // project
      2: { cellWidth: 25 }, // shift
      3: { cellWidth: 15 }, // start
      4: { cellWidth: 15 }, // einde
      5: { cellWidth: 12 }, // pauze
      6: { cellWidth: 18 }, // duur
      7: { cellWidth: 'auto' } // omschrijving
    },
    didDrawPage: (data) => {
      const pageCount = doc.internal.getNumberOfPages();
      const pageHeight = doc.internal.pageSize.height;
      doc.setFontSize(8);
      doc.setTextColor(120);
      doc.text(`Pagina ${pageCount}`, pageWidth - 30, pageHeight - 8);
    }
  });

  // === Samenvatting onder tabel ===
  const total = Object.values(md.rows).reduce((s, r) => s + (r.minutes || 0), 0);
  const doel = ((md.targetHours || 0) * 60) + (md.targetMinutes || 0);
  const diff = total - doel;
  const fmt = v => `${Math.floor(v / 60)}u ${v % 60}m`;
  const endY = doc.lastAutoTable.finalY + 6;

  doc.setFontSize(11);
  doc.setTextColor(13, 110, 253);
  doc.text('Maandoverzicht', 14, endY);
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(9);
  doc.text(`Doel: ${fmt(doel)}`, 20, endY + 5);
  doc.text(`Gepland: ${fmt(total)}`, 20, endY + 10);
  doc.text(`Verschil: ${(diff >= 0 ? '+' : '-') + fmt(Math.abs(diff))}`, 20, endY + 15);

  // === PDF genereren ===
  const filename = `Shiftplanning_${ud.name || 'gebruiker'}_${monthName}_${year}.pdf`;
  doc.save(filename);
  toast('PDF ge√´xporteerd', 'success');
});

  </script>
</body>
</html>

