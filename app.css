import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, getDocs, addDoc, deleteDoc, collection, query, orderBy, limit, onSnapshot, where, startAfter, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, uploadBytesResumable } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js';

// ===== Firebase config =====
const firebaseConfig = {
  apiKey: "AIzaSyB8uHwRXCe1iV7z6T80YPxEbeB64qdMpNY",
  authDomain: "shift-planner-dc7ad.firebaseapp.com",
  projectId: "shift-planner-dc7ad",
  storageBucket: "shift-planner-dc7ad.firebasestorage.app",
  messagingSenderId: "719441527396",
  appId: "1:719441527396:web:de87d6f950fe23702a5571"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ======= State =======
let currentUserId = null;
let notificationInterval = null;
const dataStore = { 
  users: {}, 
  currentUser: null,
  notifications: [],
  cvData: { 
    jobTitle: '',
    profileText: '',
    phone: '',
    city: '',
    skills: '',
    languages: '',
    education: '',
    projects: [],
    employers: [] 
  }
};
let saveTimer = null; 
const debouncedSave = () => {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => { saveUserData(); console.log("DB: Data opgeslagen."); }, 2000);
};

// ======= Elements =======
const sidebar = document.getElementById('sidebar');
const main = document.getElementById('main');
const currentUserName = document.getElementById('currentUserName');

// CV Elements
const cvJobTitle = document.getElementById('cvJobTitle');
const cvProfileText = document.getElementById('cvProfileText');
const cvPhone = document.getElementById('cvPhone');
const cvCity = document.getElementById('cvCity');
const cvSkills = document.getElementById('cvSkills');
const cvLanguages = document.getElementById('cvLanguages');
const cvEducation = document.getElementById('cvEducation');
const cvProjectsList = document.getElementById('cvProjectsList');
const cvEmployersList = document.getElementById('cvEmployersList'); 

const prevName = document.getElementById('prevName');
const prevJob = document.getElementById('prevJob');
const prevEmail = document.getElementById('prevEmail');
const prevPhone = document.getElementById('prevPhone');
const prevCity = document.getElementById('prevCity');
const prevProfile = document.getElementById('prevProfile');
const prevSkills = document.getElementById('prevSkills');
const prevLanguages = document.getElementById('prevLanguages');
const prevEducation = document.getElementById('prevEducation');
const prevProjects = document.getElementById('prevProjects');
const prevEmployers = document.getElementById('prevEmployers'); 

// ======= Auth & Init =======
onAuthStateChanged(auth, async (user)=>{
  if (notificationInterval) clearInterval(notificationInterval);
  const savedColor = localStorage.getItem('accentColor');
  if (savedColor) applyAccentColor(savedColor);

  if (!user) { window.location.replace('index.html'); return; }

  document.body.classList.add('auth-checked');
  currentUserId = user.uid; 
  currentUserName.textContent = user.displayName || user.email;

  // Foto laden
  const topPhotoEl = document.getElementById('topbarProfilePhoto');
  if (topPhotoEl) topPhotoEl.src = user.photoURL || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0iI2NjYyIgY2xhc3M9ImJpIGJpLXBlcnNvbi1jaXJjbGUiIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZD0iTTExIDZhMyAzIDAgMTEtNiAwIDMgMyAwIDAxNiAwIi8+PHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBkPSJNMDggYTEuNSAxLjUgMCAwMC0xLjUgMS41VjE0YWguNWExLjUgMS41IDAgMDAxLjUtMS41VjkuNWEzIDMgMCAwMS41NTYtMS45OTEuNDk5LjQ5OSAwIDAwLS40NzEtLjAwMkExLjUgMS41IDAgMDA4IDEzLjQ5NnYxLjAxOEM4IDE1Ni44ODQgMTYgNS41IDE2SDIuNUEEuNSAxLjUgMCAwMTQgMTQuNUgxdjEuNUMxIDE1LjYxMiAxLjA0IDE2IDEuMzU3IDE2aDExLjI4NkMxMy45NiAxNiAxNCAxNS42MTIgMTQgMTUuNXYtMS41aC0zYTEuNSAxLjUgMCAwMS0xLjUtMS41VjEyYTEuNSAxLjUgMCAwMS4yNy0uODQ0LjQ5OS40OTkgMCAwMC0uNDctLjAwNkExLjUgMS41IDAgMDAtOCAxMy41MXYxLjAxOGMwIDEuMzczIDEuMTI3IDIuNSA2LjUgMi41aDNBNy41IDcuNSAwIDAwOCAwdjNhMy41IDMuNSAwIDAwLTQgNC41djNBMi41IDIuNSAwIDAwLjUgMTN2LjVhMS41IDEuNSAwIDAwLTEuNSAxLjVaIi8+PC9zdmc+';

  await ensureUserDoc(user);
  await loadAllUsers();
  
  // Settings laden
  const ud = getCurrentUserData();
  if (ud?.settings?.accentColor) applyAccentColor(ud.settings.accentColor);
  if (ud?.settings?.sidebarCollapsed) {
      sidebar.classList.add('collapsed');
      main.classList.add('collapsed');
  }

  // CV Data laden
  if (ud.cvData) {
    dataStore.cvData = { ...dataStore.cvData, ...ud.cvData };
    if(!dataStore.cvData.employers) dataStore.cvData.employers = [];
  } else {
    ud.cvData = dataStore.cvData;
  }
  
  initCV(); 

  // Andere modules (uit je originele code)
  // ... (laat ik hier weg voor brevity)
  
  updateCVPreview();
  populateCVInputs();

  // Tab switch logic
  try {
    if (ud?.settings?.defaultTab) {
      const tabLink = document.querySelector(`a[href="${ud.settings.defaultTab}"]`);
      if (tabLink) bootstrap.Tab.getOrCreateInstance(tabLink).show();
    }
  } catch (e) {}

});

async function ensureUserDoc(user){
  const ref = doc(db, 'users', user.uid);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref, { 
      email: user.email, 
      name: user.displayName || user.email.split('@')[0], 
      role:'user', shifts:{}, monthData:{}, projects:[], shiftOrder:[],
      cvData: dataStore.cvData 
    });
  }
}

function getCurrentUserData() {
  const id = currentUserId; 
  if (!id) return null;
  if (!dataStore.users[id]) dataStore.users[id] = {};
  return dataStore.users[id];
}

async function saveUserData(){
  const id = currentUserId;
  if (!id) return;
  const ud = dataStore.users[id];
  ud.cvData = dataStore.cvData;
  const ref = doc(db,'users', id);
  await setDoc(ref, ud, { merge: true });
}

// =============================================
// ðŸ“„ CV MODULE
// =============================================

function initCV() {
  // Listeners
  const inputs = [
    { el: cvJobTitle, key: 'jobTitle', prev: prevJob },
    { el: cvProfileText, key: 'profileText', prev: prevProfile },
    { el: cvPhone, key: 'phone', prev: prevPhone },
    { el: cvCity, key: 'city', prev: prevCity },
    { el: cvEducation, key: 'education', prev: prevEducation }
  ];

  inputs.forEach(item => {
    if(!item.el) return;
    item.el.addEventListener('input', () => {
      dataStore.cvData[item.key] = item.el.value;
      if(item.prev) item.prev.innerText = item.el.value || '-';
      if(item.key === 'education') item.prev.innerText = item.el.value; 
    });
  });

  const listInputs = [
    { el: cvSkills, key: 'skills', prev: prevSkills },
    { el: cvLanguages, key: 'languages', prev: prevLanguages }
  ];

  listInputs.forEach(item => {
    if(!item.el) return;
    item.el.addEventListener('input', () => {
      dataStore.cvData[item.key] = item.el.value;
      renderList(item.prev, item.el.value);
    });
  });

  document.getElementById('cvSaveBtn')?.addEventListener('click', async () => {
    await saveUserData();
    alert('CV Gegevens opgeslagen!'); 
  });

  // Knoppen voor modals
  document.getElementById('saveCvProjectBtn')?.addEventListener('click', addCVProject);
  document.getElementById('saveCvEmployerBtn')?.addEventListener('click', addCVEmployer);
  document.getElementById('cvDownloadBtn')?.addEventListener('click', downloadCVAsPDF);

  // Wanneer Project modal opent, vul de werkgever dropdown
  const projModal = document.getElementById('cvProjectModal');
  projModal.addEventListener('show.bs.modal', updateEmployerDropdown);
}

function updateEmployerDropdown() {
    const select = document.getElementById('cvProjLinkEmp');
    if(!select) return;
    
    // Bewaar huidige selectie of reset
    select.innerHTML = '<option value="">Geen (Los project)</option>';
    
    const employers = dataStore.cvData.employers || [];
    employers.forEach(emp => {
        const opt = document.createElement('option');
        opt.value = emp.id;
        opt.textContent = emp.name;
        select.appendChild(opt);
    });
}

function populateCVInputs() {
  const data = dataStore.cvData;
  if(cvJobTitle) cvJobTitle.value = data.jobTitle || '';
  if(cvProfileText) cvProfileText.value = data.profileText || '';
  if(cvPhone) cvPhone.value = data.phone || '';
  if(cvCity) cvCity.value = data.city || '';
  if(cvSkills) cvSkills.value = data.skills || '';
  if(cvLanguages) cvLanguages.value = data.languages || '';
  if(cvEducation) cvEducation.value = data.education || '';

  renderProjectsListInput();
  renderEmployersListInput();
}

function updateCVPreview() {
  const data = dataStore.cvData;
  const user = auth.currentUser;

  if(prevName) prevName.textContent = user?.displayName || 'NAAM';
  if(prevEmail) prevEmail.textContent = user?.email || '-';

  if(prevJob) prevJob.textContent = data.jobTitle || 'Functietitel';
  if(prevProfile) prevProfile.textContent = data.profileText || 'Vul je profiel in...';
  if(prevPhone) prevPhone.textContent = data.phone || '-';
  if(prevCity) prevCity.textContent = data.city || '-';
  if(prevEducation) prevEducation.textContent = data.education || '';

  renderList(prevSkills, data.skills);
  renderList(prevLanguages, data.languages);

  // Renders de tijdlijnen (inclusief geneste projecten!)
  renderEmployersTimeline(); 
  // Renders de 'losse' projecten
  renderProjectsTimeline();
}

function renderList(ulElement, textStr) {
  if(!ulElement) return;
  ulElement.innerHTML = '';
  if(!textStr) return;
  const items = textStr.split(',').map(s => s.trim()).filter(s => s);
  items.forEach(item => {
    const li = document.createElement('li');
    li.textContent = item;
    ulElement.appendChild(li);
  });
}

// --- ADD DATA ---

function addCVProject() {
  const start = document.getElementById('cvProjStart').value;
  const endInput = document.getElementById('cvProjEnd').value;
  const isCurrent = document.getElementById('cvProjCurrent').checked;
  const client = document.getElementById('cvProjClient').value;
  const role = document.getElementById('cvProjRole').value;
  const desc = document.getElementById('cvProjDesc').value;
  const employerId = document.getElementById('cvProjLinkEmp').value; // Link ID

  if(!start || !client || !role) {
    alert("Vul minstens startdatum, klant en rol in.");
    return;
  }

  const newProj = {
    id: Date.now(),
    start,
    end: isCurrent ? 'heden' : endInput,
    client,
    role,
    desc,
    employerId: employerId || null // Sla ID op
  };

  dataStore.cvData.projects.push(newProj);
  dataStore.cvData.projects.sort((a,b) => b.start.localeCompare(a.start));

  // Reset UI
  document.getElementById('cvProjClient').value = '';
  document.getElementById('cvProjRole').value = '';
  document.getElementById('cvProjDesc').value = '';
  document.getElementById('cvProjLinkEmp').value = ''; // Reset select
  
  bootstrap.Modal.getInstance(document.getElementById('cvProjectModal')).hide();

  renderProjectsListInput();
  updateCVPreview(); // Alles refreshen
  saveUserData();
}

function addCVEmployer() {
  const start = document.getElementById('cvEmpStart').value;
  const endInput = document.getElementById('cvEmpEnd').value;
  const isCurrent = document.getElementById('cvEmpCurrent').checked;
  const name = document.getElementById('cvEmpName').value;
  const role = document.getElementById('cvEmpRole').value;
  const desc = document.getElementById('cvEmpDesc').value;

  if(!start || !name || !role) {
    alert("Vul minstens startdatum, werkgever en functie in.");
    return;
  }

  const newEmp = {
    id: Date.now(),
    start,
    end: isCurrent ? 'heden' : endInput,
    name,
    role,
    desc
  };

  dataStore.cvData.employers.push(newEmp);
  dataStore.cvData.employers.sort((a,b) => b.start.localeCompare(a.start));

  document.getElementById('cvEmpName').value = '';
  document.getElementById('cvEmpRole').value = '';
  document.getElementById('cvEmpDesc').value = '';
  
  bootstrap.Modal.getInstance(document.getElementById('cvEmployerModal')).hide();

  renderEmployersListInput();
  updateCVPreview();
  saveUserData();
}

// --- INPUT LISTS RENDERING ---

function renderProjectsListInput() {
  if(!cvProjectsList) return;
  cvProjectsList.innerHTML = '';
  const projects = dataStore.cvData.projects || [];
  if(projects.length === 0) {
    cvProjectsList.innerHTML = '<div class="text-muted fst-italic text-center">Nog geen projecten.</div>';
    return;
  }

  projects.forEach((p, index) => {
    // Zoek werkgever naam als die gekoppeld is
    let empName = '';
    if(p.employerId) {
        const emp = dataStore.cvData.employers.find(e => e.id == p.employerId);
        if(emp) empName = `<span class="badge bg-light text-dark border ms-1">@ ${emp.name}</span>`;
    }

    const div = document.createElement('div');
    div.className = 'list-group-item d-flex justify-content-between align-items-center p-2';
    div.innerHTML = `
      <div>
        <div class="fw-bold">${p.role} ${empName}</div>
        <div class="small text-muted">${p.client}</div>
      </div>
      <button class="btn btn-sm btn-outline-danger del-proj-btn" data-idx="${index}">&times;</button>
    `;
    cvProjectsList.appendChild(div);
  });

  document.querySelectorAll('.del-proj-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      dataStore.cvData.projects.splice(e.target.dataset.idx, 1);
      renderProjectsListInput();
      updateCVPreview();
      saveUserData();
    });
  });
}

function renderEmployersListInput() {
  if(!cvEmployersList) return;
  cvEmployersList.innerHTML = '';
  const list = dataStore.cvData.employers || [];
  if(list.length === 0) {
    cvEmployersList.innerHTML = '<div class="text-muted fst-italic text-center">Nog geen werkgevers.</div>';
    return;
  }

  list.forEach((p, index) => {
    const div = document.createElement('div');
    div.className = 'list-group-item d-flex justify-content-between align-items-center p-2';
    div.innerHTML = `
      <div>
        <div class="fw-bold">${p.role}</div>
        <div class="small text-muted">${p.name}</div>
      </div>
      <button class="btn btn-sm btn-outline-danger del-emp-btn" data-idx="${index}">&times;</button>
    `;
    cvEmployersList.appendChild(div);
  });

  document.querySelectorAll('.del-emp-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      dataStore.cvData.employers.splice(e.target.dataset.idx, 1);
      renderEmployersListInput();
      updateCVPreview(); // Refresh preview om projecten ook weg te halen uit de view indien nodig
      saveUserData();
    });
  });
}

// --- PREVIEW RENDERING (MET NESTING) ---

function formatD(dStr) {
    if(!dStr || dStr === 'heden') return 'Heden';
    const [y, m] = dStr.split('-');
    const date = new Date(y, m-1);
    return date.toLocaleDateString('nl-BE', { month: 'short', year: 'numeric' });
};

function renderEmployersTimeline() {
  if(!prevEmployers) return;
  prevEmployers.innerHTML = '';
  
  const employers = dataStore.cvData.employers || [];
  const allProjects = dataStore.cvData.projects || [];

  employers.forEach(emp => {
    // 1. Render de Werkgever
    const div = document.createElement('div');
    div.className = 'cv-project-item';
    const dateStr = `${formatD(emp.start)} - ${formatD(emp.end)}`;

    div.innerHTML = `
      <div class="cv-date">${dateStr}</div>
      <div class="cv-role">${emp.role}</div>
      <div class="cv-client">${emp.name}</div>
      <p class="small text-muted mb-2" style="white-space: pre-wrap;">${emp.desc}</p>
    `;

    // 2. Zoek en Render GENESTE Projecten
    const nestedProjects = allProjects.filter(p => p.employerId == emp.id); // Check ID (string/int loose match)
    
    if(nestedProjects.length > 0) {
        const nestedContainer = document.createElement('div');
        nestedContainer.className = 'cv-nested-projects';
        
        nestedProjects.forEach(proj => {
            const pDiv = document.createElement('div');
            pDiv.className = 'cv-nested-project-item';
            const pDate = `${formatD(proj.start)} - ${formatD(proj.end)}`;
            
            pDiv.innerHTML = `
                <div class="cv-nested-meta">${pDate} | ${proj.client}</div>
                <div class="cv-nested-role">${proj.role}</div>
                <p class="cv-nested-desc">${proj.desc}</p>
            `;
            nestedContainer.appendChild(pDiv);
        });

        div.appendChild(nestedContainer);
    }

    prevEmployers.appendChild(div);
  });
}

function renderProjectsTimeline() {
  const container = document.getElementById('prevProjects');
  const section = document.getElementById('prevProjectsSection');
  if(!container) return;
  
  container.innerHTML = '';
  
  // Toon alleen projecten die GEEN employerId hebben
  const looseProjects = (dataStore.cvData.projects || []).filter(p => !p.employerId);

  if(looseProjects.length === 0) {
      if(section) section.style.display = 'none';
      return;
  }

  if(section) section.style.display = 'block';

  looseProjects.forEach(p => {
    const dateStr = `${formatD(p.start)} - ${formatD(p.end)}`;
    const div = document.createElement('div');
    div.className = 'cv-project-item';
    div.innerHTML = `
      <div class="cv-date">${dateStr}</div>
      <div class="cv-role">${p.role}</div>
      <div class="cv-client">${p.client}</div>
      <p class="small text-muted mb-0" style="white-space: pre-wrap;">${p.desc}</p>
    `;
    container.appendChild(div);
  });
}

// PDF Download
async function downloadCVAsPDF() {
  const element = document.getElementById('cvPreview');
  const btn = document.getElementById('cvDownloadBtn');
  const oldText = btn.innerHTML;
  btn.innerHTML = 'Even geduld...';
  btn.disabled = true;

  try {
    const canvas = await html2canvas(element, { scale: 2, useCORS: true });
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save('Mijn_CV.pdf');
  } catch (err) {
    console.error("PDF Error:", err);
    alert("Er ging iets mis bij het maken van de PDF.");
  } finally {
    btn.innerHTML = oldText;
    btn.disabled = false;
  }
}

// Accentkleur helper
function applyAccentColor(hex) {
    if (!hex) return;
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    const rgb = `${r}, ${g}, ${b}`;
    const cssRules = `
    :root { --bs-primary: ${hex}; --bs-primary-rgb: ${rgb}; }
    .bg-primary { background-color: ${hex} !important; }
    .text-primary { color: ${hex} !important; }
    .btn-primary { background-color: ${hex} !important; border-color: ${hex} !important; }
    .btn-outline-primary { color: ${hex} !important; border-color: ${hex} !important; }
    .btn-outline-primary:hover { background-color: ${hex} !important; color: #fff !important; }
    .sp-sidebar { background: ${hex} !important; }
    .cv-header { background-color: ${hex} !important; }
    .cv-project-item::before { background-color: ${hex} !important; }
    .cv-date { color: ${hex} !important; }
    `;
    document.getElementById('accent-color-overrides').innerHTML = cssRules;
}